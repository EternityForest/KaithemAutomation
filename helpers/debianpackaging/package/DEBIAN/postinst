if [ ! -f /var/lib/kaithem/users/data/users.json ]
then
    adduser --system --no-create-home kaithem
    useradd -G serial kaithem
    useradd -G dialout kaithem
    useradd -G audio kaithem
    groupadd -r kaithem
    usermod -g kaithem kaithem
    chown -R kaithem /var/lib/kaithem
    mkdir /var/lib/kaithem
    chown kaithem /var/lib/kaithem
    chmod 700 /var/lib/kaithem/
    mkdir /var/lib/kaithem/ssl
    chown kaithem /var/lib/kaithem/ssl
    chmod 700 /var/lib/kaithem/ssl
    #Look at this race condition here! Someone could steal that private key before we chmod it!
    openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 -keyout /var/lib/kaithem/ssl/certificate.key  -out  /var/lib/kaithem/ssl/certificate.cert -subj '/CN=localhost'
    chmod 600 /var/lib/kaithem/ssl/certificate.key
    chown kaithem /var/lib/kaithem/ssl/certificate.key
    systemctl enable kaithem
    kaithem --initialpackagesetup x
fi