<%!
from kaithem.src.config import config
from kaithem.src import auth,util,notifications,pages,modules,modules_state,theming,devices,persist
import scullery.persist
import cherrypy,socket,base64
%>



<!DOCTYPE html>
<html>

<head>
  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="${_k_usr_page_theme or theming.getCSSTheme() or config['theme-url']}">
</head>

<body id="page">
  <script src="/static/widget.js"></script>

  %if not cherrypy.request.params.get("kaithem_disable_header",0):
  <header>


  <div id="kaithem-main-dropdown-panel" class="sectionbox top-navbar-dropdown" style="z-index: 5; display:none; position: absolute; left:2em; top:3em;width: 35wv;">
    <div class="buttonbar">
      <button onclick="document.getElementById('kaithem-main-dropdown-panel').style.display='none'"><i class="icofont-ui-close"></i>Close</button>
    </div>
  <iframe  id="kaithem-main-dropdown-iframe" style="height: 80vh; width: 100%; max-height: 80vh;" height="80%"></iframe>
  </div>



    <div class="buttonbar" style="position: relative;">
      %if pages.canUserDoThis("/admin/mainpage.view"):
      <button style="flex-grow: 0" onclick="document.getElementById('kaithem-main-dropdown-panel').style.display='block';document.getElementById('kaithem-main-dropdown-iframe').src='/dropdownpanel'">
        <i class="icofont-dotted-down"></i></button>

    <a href="/index"><b>${socket.gethostname()|h}</b>

    <span id="notifications_toolbar_item"  title="New Notifications">
      ${notifications.toolbarapi.render("wsapi")}

      <script type="text/javascript">
        var totalNotifications=0;

        function getCookie(c_name) {
          var c_value = document.cookie;
          var c_start = c_value.indexOf(" " + c_name + "=");
          if (c_start == -1) {
            c_start = c_value.indexOf(c_name + "=");
          }
          if (c_start == -1) {
            c_value = null;
          }
          else {
            c_start = c_value.indexOf("=", c_start) + 1;
            var c_end = c_value.indexOf(";", c_start);
            if (c_end == -1) {
              c_end = c_value.length;
            }
            c_value = unescape(c_value.substring(c_start, c_end));
          }
          return c_value;
        }


        if (!getCookie("LastSawMainPage")) {
          y = 0
        }
        else {
          y = getCookie("LastSawMainPage");
        }

        
        wsapi.upd = function (e) {
          try {
            var k = e;

            if (k[0]=='newmsg')
            {
              totalNotifications+=1
              document.getElementById("notifications_toolbar_item").innerHTML = "(" + totalNotifications + ")";
            }
            else if (k[0] > 0) {
              document.getElementById("notifications_toolbar_item").innerHTML = "M(" + k[0] + ")";
              totalNotifications = k[0]

              if (k[2] > 0) {
                document.getElementById("notifications_toolbar_item").className = "warning";
              }

              if (k[3] > 0) {
                document.getElementById("notifications_toolbar_item").className = "error";
              }

            }
            else {
              document.getElementById("notifications_toolbar_item").innerHTML = '(0)';
            }
          }
          catch (err) {
            console.log("JSON Parse Error in websocket response:\n" + e.data);
          }
        }
      
      wsapi.send(["countsince",parseFloat(y)])

      </script>
    </span>
  </a>
    %endif




      <%
      nbp = []
      for i in pages.navBarPlugins:
        x = pages.navBarPlugins[i]()
        if x:
          nbp.append(x)
        nbp=sorted(nbp)
      %>
      %for i in nbp:
      ${i[1]}
      %endfor



      <a href="/modules/"><i class="icofont-briefcase"></i>
        Modules</a>

        <a  href="/devices"><i class="icofont-usb-drive"></i>
          Devices</a>


        
          <a href="/tagpoints"><i class="icofont-molecule"></i>Tags</a>

        <a href="/settings/mixer"><i class="icofont-ui-volume"></i>Mixer</a>

        <a href="/settings" >
          <i class="icofont-gears"></i>

          %if auth.authchanged:
          <span title="The users, groups, user settings, or permissions have unsaved changes">*</span>
          %endif


          %if  persist.dirty:
          <span title="The there are persistance files with unsaved changes">*</span>
          %endif


          %if  scullery.persist.unsavedFiles:
          <span title="Something has an unsaved file">*</span>
          %endif
Tools</a>

        <a href="/helpmenu"><i class="icofont-book"></i>Help</a>

        %if "auth" in cherrypy.request.cookie:

        %if cherrypy.request.cookie['auth'].value in auth.Tokens:
        <form style="flex-grow: 0.05;" method="POST" action="/login/logout">
        <button href="/login/logout"><i class="icofont-key"></i>Logout(${pages.getAcessingUser()[:10]|h})</button>
        </form>

        %else:
        <a  style="flex-grow: 0.05;" href="/login?go=${base64.b64encode(cherrypy.url().encode()).decode()}"><i class="icofont-key"></i>Login</a>
        %endif"


        %else:
        <a  style="flex-grow: 0.05;" href="/login?go=${base64.b64encode(cherrypy.url().encode()).decode()}"><i class="icofont-key"></i>Login</a>
        %endif

  

    </div>
    %endif

    </header>
    <main>