<%!
from src.config import config
from src import auth,util,notifications,pages,modules,registry,theming,devices,persist
import cherrypy,socket,base64
%>



<!DOCTYPE html>
<html>

<head>
  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="${theming.getCSSTheme() or config['theme-url']}">
</head>

<body id="page">
  <script src="/static/widget.js"></script>

  %if not cherrypy.request.params.get("kaithem_disable_header",0):
  <div style="width: 100%; position:relative;">
    ${config['top-banner-html'].replace("HOSTNAME",socket.gethostname())}
  <div border="" id="nav">


  <div style="flex-grow: 0.05;">
    %if config['enable-js'] and pages.canUserDoThis("/admin/mainpage.view"):
    <a id="notifications_toolbar_item" href="/" title="New Notifications">
      ${notifications.toolbarapi.render("wsapi")}

      <script type="text/javascript">
        function getCookie(c_name) {
          var c_value = document.cookie;
          var c_start = c_value.indexOf(" " + c_name + "=");
          if (c_start == -1) {
            c_start = c_value.indexOf(c_name + "=");
          }
          if (c_start == -1) {
            c_value = null;
          }
          else {
            c_start = c_value.indexOf("=", c_start) + 1;
            var c_end = c_value.indexOf(";", c_start);
            if (c_end == -1) {
              c_end = c_value.length;
            }
            c_value = unescape(c_value.substring(c_start, c_end));
          }
          return c_value;
        }


        if (!getCookie("LastSawMainPage")) {
          y = 0
        }
        else {
          y = getCookie("LastSawMainPage");
        }

        
        wsapi.upd = function (e) {
          try {
            var k = e;

            if (k[0]=='newmessage')
            {
              totalNotifications+=1
              document.getElementById("notifications_toolbar_item").innerHTML = "Main (" + totalNotifications + ")";
            }
            if (k[0] > 0) {
              document.getElementById("notifications_toolbar_item").innerHTML = "Main (" + k[0] + ")";
              totalNotifications = k[0]

              if (k[2] > 0) {
                document.getElementById("notifications_toolbar_item").className = "warning";
              }

              if (k[3] > 0) {
                document.getElementById("notifications_toolbar_item").className = "error";
              }

            }
            else {
              document.getElementById("notifications_toolbar_item").innerHTML = 'Main (0)';
            }
          }
          catch (err) {
            console.log("JSON Parse Error in websocket response:\n" + e.data);
          }
        }
      
      wsapi.send(["countsince",parseFloat(y)])

      </script>
    </a>
    %endif

  </div>


      

      <%
      nbp = []
      for i in pages.navBarPlugins:
        x = pages.navBarPlugins[i]()
        if x:
          nbp.append(x)
        nbp=sorted(nbp)
      %>
      %for i in nbp:
      <div>${i[1]}</div>
      %endfor



      <div ><a class="moduleslink" href="/modules/">Modules</a>
        %if modules.unsaved_changed_obj:
        <span title="The modules have unsaved changes"><a href="/settings/save">*</a></span>
        %endif
      </div>
        <div >
          %if devices.unsaved_changes:
          <span title="The modules have unsaved changes"><a href="/settings/save">*</a></span>
          %endif
          <a class="deviceslink" href="/devices">Devices</a>
        </div>


        <div >
          <a  class="tagslink" href="/tagpoints">Tags</a>
        </div>

        <div ><span class="sound-icon"></span><a href="/settings/mixer">Mixer</a></div>

        <div style="flex-grow: 0.05;" ><a class="settingslink" href="/settings" >Tools</a>


          %if auth.authchanged:
          <span title="The users, groups, user settings, or permissions have unsaved changes"><a
              href="/settings/save">*</a></span>
          %endif

          %if not registry.is_clean:
          <span title="The kaithem registry has unsaved changes"><a href="/settings/save">*</a></span>
          %endif

          %if  persist.dirty:
          <span title="The there are persistance files with unsaved changes"><a href="/settings/save">*</a></span>
          %endif
        </div>


        <div style="flex-grow: 0.05;"><a class="helplink" href="/helpmenu">Help</a></div>

        %if "auth" in cherrypy.request.cookie:

        %if cherrypy.request.cookie['auth'].value in auth.Tokens:
        <div style="flex-grow: 0.05;" ><a class="loginlink" href="/login/logout">Logout(${pages.getAcessingUser()[:10]|h})</a></div>

        %else:
        <div style="flex-grow: 0.05;"><a class="loginlink" href="/login?go=${base64.b64encode(cherrypy.url().encode()).decode()}">Login</a></div>
        %endif


        %else:
        <div style="flex-grow: 0.05;"><a class="loginlink" href="/login?go=${base64.b64encode(cherrypy.url().encode()).decode()}">Login</a></div>
        %endif

  
  
        

      </div>
    </div>
    %endif
    <main>