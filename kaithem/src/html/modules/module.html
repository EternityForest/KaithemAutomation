<%!
from src.util import url
from src import pages,newevt,usrpages,unitsofmeasure,util
import time
%>

<%include file="/pageheader.html"/>
<h2>Module ${name|h}</h2>

This Page allows you to view and edit information and resources associated with this module.<br><br>
<title>Module: ${name|h}</title>

<form action="/modules/module/${url(name)}/update" method="POST" name="user">
<a href="/modules/downloads/${url(name)}">Download this module as a zip file</a>
<h3>Basic Information</h3>
<div class="sectionbox">

<p class="help">Changing the name of a module will invalidate all external references to the module by its old name. Also, if the name is in use it will be overwritten. Be Careful.</p><hr>
<h4>Name:</h4> 
<input required="required" class="modulename" name="name" type="text" value="${name|h}">  
<h4>Info:</h4>
<textarea name="description" class="description" rows=5>${module['__description']['text']|h}</textarea>
<hr>
%if pages.canUserDoThis("/admin/modules.edit"):
<input type="submit" value="Save Changes"></input>
%else:
<p class="warning">You must have the "/admin/modules.edit" permission to make changes. Are you logged in?</p>
%endif>
</form>
</div>



<br>

<h3>Resources in ${"/".join([name]+path)|h}</h3>
<div class="sectionbox">
<p class="menubar">
<a class="button createbutton" href="/modules/module/${url(name)}/addresource/event/${'/'.join(path)|u}">Add Event</a>
<a class="button createbutton" href="/modules/module/${url(name)}/addresource/permission/${'/'.join(path)|u}">Add Permission</a>
<a class="button createbutton" href="/modules/module/${url(name)}/addresource/page/${'/'.join(path)|u}">Add Page</a>
<a class="button createbutton" href="/modules/module/${url(name)}/addresource/directory/${'/'.join(path)|u}">Add Folder</a>
<a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource">Delete Resource</a>
</p>
<p class="help">This module contains the following resources.</p>
<%!
def get_time(t):
  try:
      return scheduling.get_next_run(t)
  except Exception as e:
      return 0

def in_folder(r,f,n):
     r = [n]+util.split_escape(r,'/')
     f = util.split_escape(f,'/')
     print("=========")
     print(r)
     print(f)
     if not len(r)==len(f)+1:
	  return False
     x = 0
     for i in f:
	  if not r[x] == i:
	       return False
	  x +=1
     return True
%>
<dl>
<dt><a href="/modules/module/${url(name)}">Top</a>(Go to Top level module folder)</dt>
<hr>
%for i in sorted(sorted(module.keys()), key=lambda x: module[x]['resource-type']):
%if in_folder(i,fullpath,name):
	%if module[i]['resource-type'] == 'event':
	  <dt>
	       <b><a href="/modules/module/${url(name)}/resource/${url(i)}">${util.split_escape(i,'/')[-1]|h}</a></b>	       
	       (Event)
	       %if newevt.fastGetEventErrors(name,i):
	       <span class="error">[${len(newevt.fastGetEventErrors(name,i))} Errors]</span>
	       %endif       
	  </dt>
	  <dd>
	       <b>Trigger:</b> ${module[i]['trigger']|h}<br>
     
		    <b>Last Ran:</b> 
		    %if newevt.getEventLastRan(name,i):
		    ${unitsofmeasure.strftime(newevt.getEventLastRan(name,i))|h}
		    (about ${unitsofmeasure.formatTimeInterval(time.time()-newevt.getEventLastRan(name,i),2)} ago)
		    %else:
		    This event has not ran since it loaded.
		    %endif
		    
		    
		    %if module[i]['trigger'].startswith("!time"):
		    <br><b>Next Run:</b>
		    ${unitsofmeasure.strftime(get_time(module[i]['trigger']))|h}</b></p>
		    %endif
	  </dd>
	%endif
	
	%if module[i]['resource-type'] == 'page':
	  <dt>
	       <b\
	       %if i.startswith('__'):
	       class="specialentry"\
	       %endif
	       >${util.split_escape(i,'/')[-1]|h}    
		%if usrpages.getPageErrors(name,i):
		<span class="error">[${len(usrpages.getPageErrors(name,i))} Errors]</span>
		%endif
		</b>(Page) <a href="/pages/${url(name)}/${url(i)}">Go to page</a>|<a href="/modules/module/${url(name)}/resource/${url(i)}">Edit Page</a></dt>
	  <dd>
        %if 'require-permissions' in module[i] and module[i]['require-permissions']:
	  <b>Permissions:</b>
	  %for x in module[i]['require-permissions']:
	  ${x|h}
	  %endfor
	  %endif
	  </dd>
	%endif
	
       %if module[i]['resource-type'] == 'permission':
       
      <dt><a href="/modules/module/${url(name)}/resource/${url(i)}">${util.split_escape(i,'/')[-1]|h}</a>(permission)<dt>
 
	%endif
	
     %if module[i]['resource-type'] == 'directory':
       
      <dt><b><a href="/modules/module/${url(name)}/resource/${url(i)}">${util.split_escape(i,'/')[-1]|h}</a></b> (folder)<dt>
 
	%endif
	<hr>
%endif
%endfor
</div>


<%include file="/pagefooter.html"/>