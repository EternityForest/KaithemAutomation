<%!
from src.unitsofmeasure import siFormatNumber
from src.util import url
from src.modules import getModuleHash,fileResourceAbsPaths, external_module_locations
from src import pages,newevt,usrpages,unitsofmeasure,util,scheduling,modules_state,registry,modules
import time,os
%>

<%include file="/pageheader.html"/>

<%
def getDesc():
    try:
        return module['__description']['text']
    except:
        return "No module description found"
%>
<h2>Module ${name|h}</h2>
<p class="help">Note: Your changes are saved temporarily to RAM until either a configured autosave(Off by default), or a manual save of the server state.</p>
<title>Module: ${name|h}</title>
<section>
<form action="/modules/module/${url(name)}/update" method="POST" name="user">
MD5 Sum: <b>${getModuleHash(name)}</b></br>
<a href="/modules/download/${url(name)}.zip">Download this module as a zip file</a><br>
<a href="/modules/yamldownload/${url(name)}.zip">Download this module as a zip file with YAML resources(not compatible with older versions)</a><br>
<a href="/modules/module/${url(name)}/obj/module">View the module namespace object(requires edit permission, beware shoulder surfers)</a>
</section>
<h3>Basic Information</h3>
<div class="sectionbox">

<p class="help">Changing the name of a module will invalidate all external references to the module by its old name. Also, if the name is in use it will be overwritten. Be Careful.</p><hr>
<h4>Name:</h4>
<input required="required" class="modulename" name="name" type="text" value="${name|h}">
<h4>Info:</h4>
<textarea name="description" class="description" rows=5>${getDesc()|h}</textarea>
<h4>Save Location(blank=default):</h4>
<input name="location" title="Enter a directory name on the server's local filesystem" value="${external_module_locations.get(name,"")|h}"></input>
<hr>
%if pages.canUserDoThis("/admin/modules.edit"):
<input type="submit" value="Save Changes"></input>
%else:
<p class="warning">You must have the "/admin/modules.edit" permission to make changes. Are you logged in?</p>
%endif>
</form>
</div>



<br>

<h3 id="resources">Resources in ${"/".join([name]+path)|h}</h3>
<div class="sectionbox">
<div class="menubar">

<a class="button createbutton addeventbutton" href="/modules/module/${url(name)}/addresource/event/${url('/'.join(path))}">Event</a>
<a class="button createbutton addpermissionbutton" href="/modules/module/${url(name)}/addresource/permission/${url('/'.join(path))}">Permission</a>
<a class="button createbutton addpagebutton" href="/modules/module/${url(name)}/addresource/page/${url('/'.join(path))}">Page</a>
<a class="button createbutton addfolderbutton" href="/modules/module/${url(name)}/addresource/directory/${url('/'.join(path))}">Folder</a>
<a class="button createbutton" href="/modules/module/${url(name)}/addfileresource/${url('/'.join(path))}">File</a>

%for i in modules.additionalTypes:
%if modules.additionalTypes[i].createButton:
<a class="button createbutton" href="/modules/module/${url(name)}/addresource/${i|u}/${url('/'.join(path))}">${modules.additionalTypes[i].createButton|h}</a>
%endif
%endfor
<a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource">Delete Resource</a>
%if external_module_locations.get(name,""):
<a class="button savebutton" href="/modules/savemodule/${name}">Save Module</a>
%endif
<form style="display:inline;" action="/modules/search/${url(name)}"><input name="search" placeholder="Search this module"/><input type=submit value="search"/></form>

</div>


<p class="pathnav">Path:
<%
temp_p = ""
%>
<a class="button" href="/modules/module/${url(name)}#resources">${name|h}</a>
%if path:
%for i in util.split_escape(path[0],"/","\\"):
<%
temp_p+= i+'/'
%>\
<a class="button" href="/modules/module/${url(name)}/resource/${url(temp_p[:-1])}#resources">${i|h}</a>
%endfor
%endif
</p>
<p class="help">This module contains the following resources.</p>

<%!
def get_time(ev):
  try:
      return newevt.EventReferences[ev].nextruntime or 0
  except Exception as e:
      return -1

#n is the module name
#f is the folder we are checking if it is in, including the module name
#r is the path of the resource
def in_folder(r,f,n):
     #Get the path as a list, including the module name
     r = [n]+util.split_escape(r,'/','\\')
     #Get the path of the folder
     f = util.split_escape(f,'/','\\')
     #make sure the resource path is one longer than module
     if not len(r)==len(f)+1:
	  return False
     x = 0
     for i in f:
	  if not r[x] == i:
	       return False
	  x +=1
     return True
%>
<dl>
%if path and len(util.split_escape(path[0],"/","\\"))>1:
<dt class="specialentry"><a href="/modules/module/${name|h}/resource/${"/".join( [i.replace("\\","\\\\").replace("/","\\/") for i in util.split_escape(path[0],"/","\\")[:-1]] )|u}#resources">..</a></dt>
<hr>
%endif
%for i in sorted(sorted(modules_state.ls_folder(name,'/'.join(path))), key=lambda x: module[x]['resource-type']):
%if in_folder(i,fullpath,name):

%if isinstance(module[i],weakref.ref):
    <%
        x=module[i]()
    %>
    %if x:
        %try:
        <dt><b><span class="virtual">${util.split_escape(i,'/','\\')[-1]|h}(Virtual)</span></b></dt>
        <dd>${module[i]().__html_repr__()}</dd>
        %except Exception as e :
        <dt></b><span class="virtual">${util.split_escape(i,'/','\\')[-1]|h}(Virtual)</span></b></dt>
        <dd>ERROR:${e|h}</dd>
        %endtry
    %else:
        <dt></b><span class="virtual">${util.split_escape(i,'/','\\')[-1]|h}(Virtual)</span></b></dt>
        <dd>Deleted VirtualResource</dd>
    %endif

    <hr>

<%
continue
%>
%endif


%if not 'resource-type' in module[i]:
<p class=error>OBJECT ${i|h} MISSING resource-type</p>
<%
continue
%>
%endif

%if module[i]['resource-type'] == 'event':
	  <dt>
	       <span class="event-icon"></span><b>\
%if (name,i) in modules.unsaved_changed_obj:
*\
%endif
<a href="/modules/module/${url(name)}/resource/${url(i)}#setupheading">${util.split_escape(i,'/','\\')[-1]|h}</a>\
	       %if not module[i].get('enable',"True"):
	       (disabled)
	       %endif
       </b>

<a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource/${url(i)}">Delete</a>
<a class="button playbutton" href="/modules/module/${url(name)}/runeventdialog/${url(i)}">Run Now</a>
	       %if newevt.fastGetEventErrors(name,i):
	       <span class="error">[${len(newevt.fastGetEventErrors(name,i))} Errors]</span>
	       %endif
	  </dt>
	  <dd>
          <p class="resource-docstring">${newevt.getEventInfo((name,i))|h}</p>
	       <b>Trigger:</b>  <code>${module[i]['trigger']|h}</code><br>
            %try:

    		    <b>Last Ran:</b>
    		    %if newevt.getEventLastRan(name,i):
    		    <code>${unitsofmeasure.strftime(newevt.getEventLastRan(name,i))|h}
    		    (${unitsofmeasure.formatTimeInterval(time.time()-newevt.getEventLastRan(name,i),2)} ago)</code>
    		    %else:
    		    This event has not ran since it loaded.
    		    %endif
            %except Exception as e:
            <b>${e.__class__|h} getting last runtime. Event likely has an error and has never been fully initialized</b>
            %endtry

		    %if module[i]['trigger'].startswith("!time") and module[i].get('enable',"True"):
		    <br><b>Next Run:</b>
            <%
            xyz= get_time((name,i))
            unitsofmeasure.strftime()
            if xyz ==0:
                xyz= "<b>Not Scheduled to Run</b>"
            elif xyz == -1:
                xyz="Error getting next run time, try refreshing page again."
            else:
                xyz =unitsofmeasure.strftime(xyz)
            %>
		    <code>${xyz}</code></p>
		    %endif
	  </dd>
	%endif

	%if module[i]['resource-type'] == 'page':
	  <dt>
          %if (name,i) in modules.unsaved_changed_obj:
          *\
          %endif
	       <span class="page-icon"></span><b\
	       %if i.startswith('__'):
	       class="specialentry page"\
	       %endif
	       >${util.split_escape(i,'/','\\')[-1]|h}
		%if usrpages.getPageErrors(name,i):
		<span class="error">[${len(usrpages.getPageErrors(name,i))} Errors]</span>
		%endif
		</b><a class="button gobutton" href="${usrpages.url_for_resource(name,i)}">Go to page</a><a class="button editbutton"
        href="/modules/module/${url(name)}/resource/${url(i)}#pagebody">

		Edit Page</a><a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource/${url(i)}">Delete</a>
    </dt>
	  <dd>
          <p class="resource-docstring">${usrpages.getPageInfo(name,i)|h}</p>

      %if 'require-permissions' in module[i] and module[i]['require-permissions']:
	  <b>Permissions:</b>
	  %for x in module[i]['require-permissions']:
	  ${x|h}
	  %endfor
	  %endif
	  </dd>
	%endif

       %if module[i]['resource-type'] == 'permission':

      <dt><span class="permission-icon"></span>\
  %if (name,i) in modules.unsaved_changed_obj:
  *\
  %endif
<a href="/modules/module/${url(name)}/resource/${url(i)}">${util.split_escape(i,'/','\\')[-1]|h}</a>
<a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource/${url(i)}">Delete</a>
<dt>

	%endif
    %if module[i]['resource-type'] == 'internal-fileref':

       <dt>\
    %if (name,i) in modules.unsaved_changed_obj:
    *\
    %endif
    <a href="/modules/module/${url(name)}/getfileresource/${url(i)}">${i}</a>
    <a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource/${url(i)}">Delete</a>
    %try:
    <span>Size: ${siFormatNumber(os.path.getsize(fileResourceAbsPaths[name,i]))}</span>\
    %except Exception as e:
    <span>File could not be acessed: ${e}</span>\
    %endtry
    <dt>

     %endif



    %if module[i]['resource-type'] not in ['event','permission','page','directory','internal-fileref'] and not i.startswith("__"):

           <dt><span></span>\
        %if (name,i) in modules.unsaved_changed_obj:
        *\
        %endif
        <a href="/modules/module/${url(name)}/resource/${url(i)}">${util.split_escape(i,'/','\\')[-1]|h}</a>
        <a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource/${url(i)}">Delete</a>
        <dt>

     %endif

     %if module[i]['resource-type'] == 'directory':

      <dt>
%if (name,i) in modules.unsaved_changed_obj or [True for j in modules.unsaved_changed_obj if isinstance(j,tuple) and j[0]==name and j[1].startswith(i)]:
*\
%endif
<span class="directory-icon"></span><b><a href="/modules/module/${url(name)}/resource/${url(i)}#resources">${util.split_escape(i,'/')[-1]|h}</a></b>
<a class="button deletebutton" href="/modules/module/${url(name)}/deleteresource/${url(i)}">Delete</a><dt>

	%endif
	<hr>
%endif
%endfor
</div>


<%include file="/pagefooter.html"/>
