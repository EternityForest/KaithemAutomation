<%!
from src.util import url
from src import auth,pages
from src import usrpages,pages,util
from src.config import config
import cherrypy
%>

<%
#I really am not a fan of having separate mobile and desktop versions. It's really often garbage
#Here we don't have much of an option, monaco only supports desktop.
using_js_editor = config['enable-js'] and auth.getUserSetting(pages.getAcessingUser(),'useace') and not "Mobile" in cherrypy.request.headers['User-Agent']
%>

<%include file="/pageheader.html"/>
%if using_js_editor:
<script src="/static/js/vs/loader.js"></script>
<script>
    	require.config({ paths: { 'vs': '/static/js/vs' }});
</script>
%endif

<title>Edit: ${util.split_escape(name,'/','\\')[-1] | h}</title>
<h2>Editing remote squirrel prog: ${util.split_escape(name,'/','\\')[-1] | h}</h2>
<p class=pathnav>Path:
<%
temp_p = ""
path = util.split_escape(name,"/","\\")
%>
<a class="button" href="/modules/module/${url(module)}#resources">${module|h}</a>
%if path:
%for i in path[:-1]:
<%
temp_p+= i+'/'
%>\
<a class="button" href="/modules/module/${url(module)}/resource/${url(temp_p[:-1])}#resources">${i|h}</a>
%endfor
%endif
<b>${path[-1]|h}</b>
</p>
<section>

<form action="/modules/module/${url(module)}/updateresource/${url(name)}" method="POST"\
%if using_js_editor:
onsubmit="document.getElementById('box').value = editor.getValue()"\
%endif
>
<h3>Program ID</h3>
<input title="The program ID for this squirrel program" name="prgid" value="${data['prgid']|h}" style="width:90%" maxlength="15"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
></input><br>
<input title="The device(As a configured device name, not the IP addr)" name="device" value="${data['device']|h}" style="width:90%" 
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
></input>
<h3>Squirrel Code</h3>
%if pages.canUserDoThis("/admin/modules.edit"):
You have write permissions.
%else:
<p class="warning">You will not be able to save any change made as you are either not logged in or do not have permissions.</p>
%endif
<br>
<p class="help">
This is a Squirrel language program meant to run on devices compatible with the Kaithem for Devices protocol. Devices may have very limited RAM.
</p>

<textarea id="box" name="code" rows=25 class="htmlcode"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
>${data["code"]|h}</textarea>

%if using_js_editor:
<div id="monacobox" style="width:100%;height:30em;border:1px solid grey"></div>
<script src="${config['monaco-theme-url']}"></script>
<script src="/static/js/monaco-actions.js"></script>
<script src="/static/js/tidy.js"></script>


<script src="/static/js/beautify/beautify.js"></script>
<script src="/static/js/beautify/beautify-css.js"></script>
<script src="/static/js/beautify/beautify-html.js"></script>

<script>
	require(['vs/editor/editor.main'], function() {      
		editor = monaco.editor.create(document.getElementById('monacobox'), {
			value: document.getElementById("box").value,
			language: 'java',
            insertSpaces: true,
            renderIndentGuides: true,
	        fontSize: 12,
            scrollBeyondLastLine: false,
            theme:'kaithem',
%if not pages.canUserDoThis("/admin/modules.edit"):
            readOnly:true
%endif
		});
        add_actions(editor);
        add_mako_format(editor);

	});


//Hide the box, it's jut there to subit the data from the actual editor
document.getElementById("box").style="display:none;";
</script>
%endif

<p class="help">
<span class="settings-icon">These extra settings let you control the behavior of the program.
</p>
<div class="scrollbox">

</div>
<h2>Runtime Info</h2>
%if printout:
<h3>Output(${len(printout)} bytes)</h3>
<pre>${printout|h}</pre>
%endif
<p class="help">
Saving this module will cause kaithem to load the program into RAM on the remote device if possible. It will not be saved to flash memory unless you do so manually.
</p>
%if pages.canUserDoThis("/admin/modules.edit"):
<input type="submit" value="Save Changes and go back">
<label><input type="checkbox"  name="tabtospace"
     %if auth.getUserSetting(pages.getAcessingUser(),'tabtospace'):
        checked="yes"
     %endif
    %if not pages.canUserDoThis("/admin/modules.edit"):
        disabled=1\
    %endif
   ></input>Convert tabs to spaces on saving</label>
</input>
%else:
<p class="warning">You must have the "/admin/modules.edit" permission to make changes. Are you logged in?</p>
%endif
</form>
</section>


<%include file="/pagefooter.html"/>
