<%!
from src.util import url
from src import auth,pages
from src import usrpages,pages,util
from src.config import config
import cherrypy,traceback
%>

<%
#I really am not a fan of having separate mobile and desktop versions. It's really often garbage
#Here we don't have much of an option, monaco only supports desktop.
using_js_editor = config['enable-js'] and auth.getUserSetting(pages.getAcessingUser(),'usemonaco') and not "Mobile" in cherrypy.request.headers['User-Agent']
%>

<%include file="/pageheader.html"/>
%if using_js_editor:
<script src="/static/js/vs/loader.js"></script>
<script>
    	require.config({ paths: { 'vs': '/static/js/vs' }});
</script>
%endif

<title>Edit: ${util.split_escape(name,'/','\\')[-1] | h}</title>
<h2>Editing page: ${util.split_escape(name,'/','\\')[-1] | h}</h2>
<p class=pathnav>Path:
<%
temp_p = ""
path = util.split_escape(name,"/","\\")
%>
<a class="button" href="/modules/module/${url(module)}#resources">${module|h}</a>
%if path:
%for i in path[:-1]:
<%
temp_p+= i+'/'
%>\
<a class="button" href="/modules/module/${url(module)}/resource/${url(temp_p[:-1])}#resources">${i|h}</a>
%endfor
%endif
<b>${path[-1]|h}</b>
</p>
Page URL: <a class="gobutton" href="${usrpages.url_for_resource(module,name)}">${''+usrpages.url_for_resource(module,name)}</a>
<section>

<form action="/modules/module/${url(module)}/updateresource/${url(name)}" method="POST"\
%if using_js_editor:
onsubmit="document.getElementById('box').value = editor.getValue()"\
%endif
>
<h3>Path</h3>
<input title="Backslashes are escapes and / is the path separator. You can move this resource to another directory by renaming." name="name" value="${name|h}" style="width:90%"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
></input>
<h3>Page Body</h3>

%if pages.canUserDoThis("/admin/modules.edit"):
<input type="submit" name="GoNow" value="Save Changes and go to page" onclick="wasChanged=false">
</input>
%else:
<p class="warning">You will not be able to save any change made as you are either not logged in or do not have permissions.</p>
%endif
<br>
<p class="help">
This page body will be interpreted as <a href="/makohelp">Mako template code</a>.
The <a href="/docs#kaithemobject">kaithem object</a> is availible as "kaithem" to python code embedded in markup.
If any extra path components after the url to the page were added, they are availible as "path".
Any keyword arguments from forms etc are availible as a dict called "kwargs".
Information about the actual HTTP request is availble by acessing the cherrypy.request object which is aliased to "request" in user page code.
Please see cherrypy's documentation for more info.
</p>

<script>
wasChanged = false;

window.onbeforeunload = function(){
    if(wasChanged)
    {
        return "Are you sure you want to exit?";
    }
}
</script>

<textarea data-editor="html" id="box" name="body" rows=25 class="htmlcode"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
>${page["body"]|h}</textarea>

%if using_js_editor:
<div id="monacobox" style="width:100%;height:30em;border:1px solid grey"></div>
<script src="${config['monaco-theme-url']}"></script>
<script src="/static/js/monaco-actions.js"></script>
<script src="/static/js/tidy.js"></script>


<script src="/static/js/beautify/beautify.js"></script>
<script src="/static/js/beautify/beautify-css.js"></script>
<script src="/static/js/beautify/beautify-html.js"></script>

<script>
	require(['vs/editor/editor.main'], function() {      
		editor = monaco.editor.create(document.getElementById('monacobox'), {
			value: document.getElementById("box").value,
			language: 'html',
            insertSpaces: true,
            renderIndentGuides: true,
	        fontSize: 14,
            scrollBeyondLastLine: false,
            theme:'kaithem',
%if not pages.canUserDoThis("/admin/modules.edit"):
            readOnly:true
%endif
		});
        add_actions(editor);
        add_mako_format(editor);

        editor.model.onDidChangeContent((event) => {
        wasChanged=true;
        });
    }
    
);


//Hide the box, it's jut there to subit the data from the actual editor
document.getElementById("box").style="display:none;";
</script>
%endif

<p class="help">
<span class="settings-icon">These extra settings let you control the display or permissions of the page
</p>
<div class="scrollbox">

<input type="checkbox"  name="no-navheader" value="true"
         %if 'no-navheader' in page:
            %if page['no-navheader'] == True:
            checked="yes"
            %endif
        %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Don't show the navigation header on this page<br>

<input type="checkbox"  name="no-header" value="true"
         %if 'no-header' in page:
            %if page['no-header'] == True:
            checked="yes"
            %endif
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Don't add any additional content(raw plaintext/webservice mode)<br>

<input type="checkbox"  name="dont-show-in-index" value="true"
         %if 'dont-show-in-index' in page:
            %if page['dont-show-in-index'] == True:
            checked="yes"
            %endif
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Don't show this page in the page index<br>

Preprocess Engine:<select name="template-engine"

        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       >
    <option value="mako" ${'selected' if page.get('template-engine','mako')== 'mako' else ''}>Mako templating(default)</option>
    <option value="markdown" ${'selected' if  page.get('template-engine','mako')== 'markdown' else ''}>Display markdown</option>
    <option value="none" ${'selected' if  page.get('template-engine','mako')== 'none' else ''}>Serve text as-is</option>   
    </select><br>

<input type="checkbox"  name="allow-GET" value="true"
         %if 'require-method' in page:
            %if 'GET' in page['require-method']:
            checked="yes"
            %endif
         %else:
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Make this page acessable by GET requests<br>

<input type="checkbox"  name="allow-POST" value="true"
         %if 'require-method' in page:
            %if 'POST' in page['require-method']:
            checked="yes"
            %endif
         %else:
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Make this page acessable by POST requests<br>

<input type="checkbox"  name="autoreload" value="true"
         %if 'auto-reload' in page:
            %if page['auto-reload']:
                checked="yes"
            %endif
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>This page should auto-refresh every

<input type="number" step=0.1 name="autoreloadinterval" size=6em
        %if 'auto-reload-interval' in page:
                value= ${page['auto-reload-interval']}
        %else:
                value= 5.0
        %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input> seconds. (this could create a lot of server traffic. don't DDoS yourself!)<br>


MIME type:<input step=0.1 name="mimetype" size=6em
        %if 'mimetype' in page:
                value= ${page['mimetype']|h}
        %else:
                value= "text/html"
        %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input><br>


<input type="checkbox" name="allow-xss"
        %if 'allow-xss' in page:
            %if page['allow-xss']:
                checked="yes"
            %endif
        %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Allow cross-origin requests from(comma separated, * means any)<
<%
origins = ""
if 'allow-origins' in page:
    for i in page['allow-origins']:
        origins = origins+i+", "
    origins = origins[:-2]
else:
    origins = "*"
%>
<input type="text"  name="allow-origins"
        value= "${origins|h}"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
        ></input>
</div>

<p class="help"><span class="permission-icon"></span>Require the following permissions to access this page</p>
<div class="scrollbox">
<ul>
%for i in sorted(auth.Permissions.keys()):
    <li> <input type="checkbox"  name="Permission${i}" value="true"
        %if i in requiredpermissions:
            checked="yes"
        %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
        ></input>${i|h}</li>
%endfor
</ul>
</div>
%if usrpages.getPageErrors(module,name):
%if (pages.canUserDoThis("/users/logs.view") or  pages.canUserDoThis("/admin/modules.edit") or pages.canUserDoThis("/admin/errors.view")):
<h3>Errors</h3>
<p class ="help">
This section shows up to the most recent 25 errors that occured while rendering the page.
</p>
%try:
<div class="scrollbox">
%for i in usrpages.getPageErrors(module,name):
    <h4>${i[0]|h}</h4>
<pre>
%if pages.canUserDoThis("/users/logs.view"):
${str(i[2])|h}
%endif
${str(i[1])|h}
</pre>
%endfor
</div>
%except:
<pre class="error">${traceback.format_exc()|h}</pre></div>
%endtry
%else:
<p class="error">Some Errors Hidden because you are not logged in or do not have the permissions to view them.</p>
%endif
%endif

<%
p = usrpages.getPageOutput(module,name)
%>

%if p:
<h3>Output(${len(p)} bytes)</h3>
<pre>${p|h}</pre>
%endif
<p class="help">
Saving this module will cause it to be immediately acessable from the web.
</p>
%if pages.canUserDoThis("/admin/modules.edit"):
<input type="submit" value="Save Changes and go back" onclick="wasChanged=false">
<label><input type="checkbox"  name="tabtospace"
     %if auth.getUserSetting(pages.getAcessingUser(),'tabtospace'):
        checked="yes"
     %endif
    %if not pages.canUserDoThis("/admin/modules.edit"):
        disabled=1\
    %endif
   ></input>Convert tabs to spaces on saving</label>
</input>
%else:
<p class="warning">You must have the "/admin/modules.edit" permission to make changes. Are you logged in?</p>
%endif
</form>
</section>

%if not(config['enable-js'] and auth.getUserSetting(pages.getAcessingUser(),'usemonaco') and not "Mobile" in cherrypy.request.headers['User-Agent']):
<script src="/static/js/src-min-noconflict/ace.js"></script>
<script src="/static/js/jquery3.js"></script>

<script>
    // Hook up ACE editor to all textareas with data-editor attribute
    $(function () {
        $('textarea[data-editor]').each(function () {
            var textarea = $(this);
            var mode = textarea.data('editor');
            var editDiv = $('<div>', {
                position: 'absolute',
                width: textarea.width(),
                height: textarea.height(),
                'class': textarea.attr('class')
            }).insertBefore(textarea);
            textarea.css('display', 'none');
            var editor = ace.edit(editDiv[0]);
            editor.renderer.setShowGutter(false);
            editor.getSession().setValue(textarea.val());
            editor.getSession().setMode("ace/mode/" + mode);
            // editor.setTheme("ace/theme/idle_fingers");
            editor.setOptions({
             fontFamily: "Hack",
            fontSize: "12pt"
            });

            editor.getSession().on('change', function() {
                wasChanged=true;
            })
            %if not pages.canUserDoThis("/admin/modules.edit"):
            editor.setReadOnly(true)
            %endif
            // copy back to textarea on form submit...
            textarea.closest('form').submit(function () {
                textarea.val(editor.getSession().getValue());
            })
        });
    });
</script>
%endif
<%include file="/pagefooter.html"/>
