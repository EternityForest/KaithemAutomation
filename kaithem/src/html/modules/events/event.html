<%!
from src.util import url
from src import newevt,unitsofmeasure,pages,auth,modules_state,pages,widgets,scheduling
from collections import defaultdict
import traceback,time
from src.config import config
from src import util
import cherrypy
%>


<%include file="/pageheader.html"/>
<%
using_js_editor = config['enable-js'] and auth.getUserSetting(pages.getAcessingUser(),'useace') and not "Mobile" in cherrypy.request.headers['User-Agent']
%>

%if using_js_editor:
<script src="/static/js/vs/loader.js"></script>
<script>
    	require.config({ paths: { 'vs': '/static/js/vs' }});
</script>
%endif

<title>Event: ${util.split_escape(name,'/','\\')[-1] | h}
</title>
<h2>Event ${util.split_escape(name,'/','\\')[-1] | h} of module <a href="/modules/module/${url(module)}">${module|h}</a>
%try:
<span class=error>${"(stopped)" if (newevt.EventReferences[module,name].disable) else ""}</span>\
%except Exception as e:
%endtry
</h2>
<p class=pathnav>Path:
<%
temp_p = ""
path = util.split_escape(name,"/","\\")
%>
<a class="button" href="/modules/module/${url(module)}#resources">${module|h}</a>
%if path:
%for i in path[:-1]:
<%
temp_p+= i+'/'
%>\
<a class="button" href="/modules/module/${url(module)}/resource/${url(temp_p[:-1])}#resources">${i|h}</a>
%endfor
%endif
<b>${path[-1]|h}</b>
</p>
%try:
<small>(Loaded in ${round(newevt.EventReferences[module,name].timeTakenToLoad,2)|h}s)</small>\
%except Exception as e:
(Load time unknown)
%endtry
%if not (module,name) in newevt.EventReferences:
<span class="error">Event not active, An error prevented this event from loading.</span>
%endif
%if not version == '__live__':
<p class="warning">This is an unsaved recovered draft version, that could not load because of errors.
not the actual version that is loaded on the server. Please correct any errors and try saving again,
or go to the working copy and save that to delete this draft.</p>
<p class="menubar">
<a class="button" href="/modules/module/${url(module)}/resource/${url(name)}/__live__">Go to Live Version</a>
<p>
%endif
<section>
<script>
    presubmit =function()
    {
    document.getElementById('setupbox').value = setupeditor.getValue();
    document.getElementById('actionbox').value = actioneditor.getValue();
    }
</script>
<form action="/modules/module/${url(module)}/updateresource/${url(name)}" method="POST"
%if using_js_editor:
onsubmit="presubmit()"
%endif
>
<h3>Basic</h3>
<label><b>Path:</b><input title="Backslashes are escapes and / is the path separator. You can move this resource to another directory by renaming." name="name" value="${name|h}" style="width:90%;"
%if not pages.canUserDoThis("/admin/modules.edit"):
            disabled=1\
%endif
></input></label><br>
 <label><input type="checkbox"  name="enable" value="false"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
         %if 'enable' in event:
            %if event['enable'] == True:
            checked="yes"
            %endif
        %else:
            checked="yes"
         %endif
       ></input>Enable</label>
<h3 id="setupheading">Setup Code</h3>
<p class="help">Enter python code. It will execute in the event <b>global</b> scope when it loads. If there is any problem,
the other events will load then this will be retried. This is also how <a href="/docs#dependancies">dependancies</a> are reoslved.
You will need to use the global keyword in the event action to overwrite a variable defined here.
%if not pages.canUserDoThis("/admin/modules.edit"):
<br>
<span class="warning">You will not be able to save any change made as you are either not logged in or do not have permissions.</span>
%endif
</p>

<%
if 'setup' in event:
    xyz = event['setup']
else:
    xyz = "pass"
%>
<textarea rows=3 class="pythoncode" name="setup" id="setupbox"
%if not pages.canUserDoThis("/admin/modules.edit"):
            disabled=1\
%endif
>${xyz|h}</textarea>

%if using_js_editor:
<div id="monacosetupbox" style="width:100%;height:30em;border:1px solid grey"></div>
<script src="${config['monaco-theme-url']}"></script>
<script src="/static/js/monaco-actions.js"></script>
<script>
	require(['vs/editor/editor.main'], function() {
		setupeditor = monaco.editor.create(document.getElementById('monacosetupbox'), {
			value: document.getElementById("setupbox").value,
			language: 'python',
            insertSpaces: true,
            renderIndentGuides: true,
	        fontSize: 12,
            scrollBeyondLastLine: false,
            theme:'kaithem',
%if not pages.canUserDoThis("/admin/modules.edit"):
            readOnly:true
%endif

		});
        add_actions(setupeditor);

	});

//Hide the box, it's jut there to subit the data from the actual editor
document.getElementById("setupbox").style="display:none;";
</script>
%endif


<h3>Trigger\
%try:
(Currently ${newevt.EventReferences[module,name]._prevstate|h})\
%except Exception as e:
${e}
%endtry
</h3>
<p class="help">Enter the trigger here. The trigger may either be a python expression. Only one copy of each event will poll at a time.
(by default, event runs when trigger goes from false to true), or a <a href="/docs#trigger">special trigger expression</a>
</p>


<input class="pythoncode event-trigger-edit-box" id="triggerbox" type="text" name="trigger" value="${event['trigger']|h}"
%if not pages.canUserDoThis("/admin/modules.edit"):
            disabled=1\
%endif
></input>

%if event['trigger'].startswith("!time"):
%try:
<p style="font-size:90%">Next Run for "${event['trigger'][5:]|h}":
${unitsofmeasure.strftime(newevt.dt_to_ts(newevt.EventReferences[module,name].nextruntime,newevt.EventReferences[module,name].tz))|h}</p>
%except Exception as e:
${e}
%endtry
%endif
<p style="display:none" id="rrule">Next Run: <span id="rrulespan"></span></p>


<h3>Additional Trigger Options</h3>
<div class="scrollbox">
    <input type="checkbox"  name="continual" value="false"
         %if 'continual' in event:
            %if event['continual'] == True:
            checked="yes"
            %endif
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>Do the action repeatedly while the trigger is true<br>
       Do the action at most every:
           <input type="number"  name="ratelimit" step=0.01
         %if 'rate-limit' in event:
            value="${event['rate-limit']|h}"
         %else:
            value="0"
         %endif
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
       ></input>seconds. Does not affect poll rate(To avoid missing short events). <br>
        <%
        priority = defaultdict(str)
        if 'priority' in event:
            if event['priority'] in ['realtime','interactive','high','medium','low','verylow']:
                priority[event['priority']] = 'selected="selected"'
        else:
            priority["interactive"] = 'selected="selected"'
        %>
       Polling Priority(to reduce CPU usage, use the lowest possible rate):<select name="priority"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
        >
        <option value="realtime" ${priority['realtime']}>Realtime(as fast as possible)</option>
        <option value="interactive" ${priority['interactive']}>Interactive(no noticable delay in response)</option>
        <option value="high" ${priority["high"]}>High(response within a second)</option>
        <option value="medium" ${priority["medium"]}>Medium(response within a few seconds)</option>
        <option value="low" ${priority["low"]}>Low(response within a minute)</option>
        <option value="verylow" ${priority["verylow"]}>Very Low(response within a few minutes)</option>
        </select>

</div>

<h3>Action</h3>
<p class="help">
This code will be executed when the trigger condition is met. Polling will be suspended until the action completes.
<b>NOTE: The Action is scoped like a function body. If you want to assign to variables and have them stay around next time the function runs,
you may need to use the global keyword. You may also need to use the global keyword if you get UnboundLocal errors.

</b>
</p>

<textarea id="actionbox" name="action" rows=50 class="pythoncode"
        %if not pages.canUserDoThis("/admin/modules.edit"):
                    disabled=1\
        %endif
>${event["action"]|h}</textarea>

%if using_js_editor:
<div id="monacoactionbox" style="width:100%;height:30em;border:1px solid grey"></div>
<script>
	require(['vs/editor/editor.main'], function() {
		actioneditor = monaco.editor.create(document.getElementById('monacoactionbox'), {
			value: document.getElementById("actionbox").value,
			language: 'python',
            insertSpaces: true,
            renderIndentGuides: true,
	        fontSize: 12,
            scrollBeyondLastLine: false,
%if not pages.canUserDoThis("/admin/modules.edit"):
            readOnly:true
%endif
		});
        add_actions(actioneditor);

	});

//Hide the box, it's jut there to subit the data from the actual editor
document.getElementById("actionbox").style="display:none;";
</script>
%endif


%if newevt.getEventErrors(module,name) and version == "__live__":
%if (pages.canUserDoThis("/users/logs.view") or  pages.canUserDoThis("/admin/modules.edit") or pages.canUserDoThis("/admin/errors.view")):
<h3 class="error">Errors[${len(newevt.getEventErrors(module,name))}]</h3>
<p class ="help">
This section the most recent errors that ocurred while executing the event or trigger.
</p>
<div class="scrollbox">
%for i in newevt.getEventErrors(module,name):
    <h4>${i[0]|h}</h4>
    <pre>${i[1]|h}</pre>
%endfor
</div>
%else:
<p class="error">Some Errors Hidden because you are not logged in or do not have the permissions to view them.</p>
%endif
%endif
<hr>

<%
p = newevt.getPrintOutput((module,name))
%>

%if p and pages.canUserDoThis("/admin/eventoutput.view"):
<h3>Output(${len(p)} bytes)</h3>
<pre>${p|h}</pre>
%endif
<h3>Info</h3>
<p>
This event last ran:
%if newevt.getEventLastRan(module,name):
<b>${unitsofmeasure.strftime(newevt.getEventLastRan(module,name))|h}
(about ${unitsofmeasure.formatTimeInterval(time.time()-newevt.getEventLastRan(module,name),2)} ago)
</b>

%try:
%if newevt.EventReferences[module,name].lastcompleted>newevt.EventReferences[module,name].lastran:
<br>Completed in ${round(newevt.EventReferences[module,name].lastcompleted-newevt.EventReferences[module,name].lastran,3)|h}s
%else:
<span class="highlight">Still Running</span>
%endif
%except Exception as e:
%endtry


%else:
<b>This event has not ran since it loaded.</b>
%endif



</p>
<hr>
<p class="help">
Saving this module will case it to completely reload, including its local scope. Other resources will not be affected.
</p>
%if pages.canUserDoThis("/admin/modules.edit"):
<a href="/modules/module/${url(module)}/obj/event/${url(name)}">View the event's namespace(requires edit permission, beware shoulder surfers)</a></br>
<input type="submit" value="Save Changes"></input>
<label><input type="checkbox"  name="tabtospace"
     %if auth.getUserSetting(pages.getAcessingUser(),'tabtospace'):
        checked="yes"
     %endif
   ></input>Convert tabs to spaces on saving</label>
%else:
<p>You must have the "/admin/modules.edit" permission to make changes. Are you logged in?</p>
%endif
</form>
</section>

%if config['enable-js'] and auth.getUserSetting(pages.getAcessingUser(),'useace'):


%endif
<%include file="/pagefooter.html"/>
