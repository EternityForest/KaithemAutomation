<%include file="/pageheader.html"/>
<%
import traceback
import json
from src import unitsofmeasure,tagpoints
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')


specialKeys={

        'subclass',
        'name',
        'type'
}
%>
<script type="text/javascript" src="/static/widget.js"></script>

<script type="text/javascript" src="/static/js/jquery3.js"></script>
<script type="text/javascript" src="/static/js/editTable/editTable.min.js"></script>
<link rel="stylesheet" href="/static/js/editTable/editTable.min.css">


<datalist id="k_tags">
        %for i in tagpoints.allTagsAtomic:
        <option>${i|h}</option>
        %endfor
</datalist>

<datalist id="k_tlocal">
        %for i in obj.tagPoints:
        <option>${i|h}</option>
        %endfor
</datalist>


<h1>Device Inspector: ${name}</h1>
<div class="sectionbox">
<a class="button" href="/devices/discoveryStep?type=${url(data.get('type',''))}&devname=${url(name)}">Search for auto-setup configurations</a>

<form method="POST" action="/devices/updateDevice/${url(name)}">

%if obj.parentModule:
<h2>Module/Resource</h2>
<p>This device is part of a module, rather than the global devices list.</p>
<input name="module" disabled value="${obj.parentModule|h}"><input name="module" disabled value="${obj.parentResource|h}">
%endif
<h2>Basic</h2>
<table border="1" style="width:40em">

<tr>
        <td>Device Type</td>
        <td><input name="type" disabled value="${data.get('type','')}"></td>
</tr>
<tr>
        <td>Device Name</td>
        <td><input name="name" value="${name}"></td>
</tr>

</table>
<input type="hidden" name="type" value="${data.get('type','')}">
<h2>Help</h2>
<ul>
<li><a href="/devices/devicedocs/${url(name)}">README for this device type</a></li>
<li><a href="/docs/mdtemplate?page=devices.md">Generic Device API and Subclassing</a></li>
</ul>
<title>${name|h}</title>


<h2>Bindings</h2>

<p class="help">A binding lets you make a data point of a device mirror an external point.  Following a publish subscribe model, 
        all of these devices are one way. The device will be updated when the tag point changes.  For the local point, 
        use the short name.  For the external point, use the long name.
</p>

<p class="help">As per the usual tag features, the tag does not actually have to exist, and you can use an expression like
"=tv("/some/tag/name") + 50" to create a virtual tag.
</p>

<p class="help">If either the external or device tag point exists, you can leave the type field blank.</p>


<textarea name="temp.kaithem.inputbindings" id="bindings" style="display: none">
${json.dumps(data.get('kaithem.input_bindings',[])) or '[]'|h}
</textarea>

<h2>Device Specific</h2>



%try:
<%
manageForm=''
if hasattr(obj,"getManagementForm"):
        manageForm = obj.getManagementForm()
%>
%except:
<pre>
${traceback.format_exc()}
</pre>
%endtry

%if manageForm.strip():
${manageForm}
%else:

<table>
%for i in sorted([i for i in obj.config.keys() if not i in specialKeys and not i.startswith("kaithem.")] ):
<tr>
        <td>${i|h}</td>
        <td><input name="${i|h}" value="${obj.config[i]|h}"></td>
</tr>
%endfor
</table>
%endif
<h2>Alerts</h2>
<p class="help">This section lists all alerts supported by the device and
        allows you to change the priorities for each.
</p>
<p class="help">For new device types, the alarms will likely be configured via the corresponding
        tag point.
</p>

<table border="1" style="width:40em">
<tr><td>Name</td><td>Priority</td><td>Status</td></tr>

%for i in obj.alerts:
<tr><td>${i|h}</td>
        <td>
        %if hasattr(obj,'_noSetAlarmPriority'):
        ${obj.alerts[i].priority}
        %else:
        <select name="alerts.${i}.priority">
                <option value="debug" ${"selected" if obj.alerts[i].priority=="debug" else ""}>Debug</option>
                <option value="info" ${"selected" if obj.alerts[i].priority=="info" else ""}>Info</option>
                <option value="warning" ${"selected" if obj.alerts[i].priority=="warning" else ""}>Warning</option>
                <option value="error" ${"selected" if obj.alerts[i].priority=="error" else ""} >Error</option>
                <option value="critical" ${"selected" if obj.alerts[i].priority=="critical" else ""}>Critical</option>
        </select>
        %endif
        </td>
        <td>${obj.alerts[i].sm.state}</td>
</tr>
%endfor
</table>

<h2>Tag Points</h2>
<p class="help">This section lists all the tag points owned 
</p>
<table border="1" style="width:40em">
<tr><td>Name</td><td>Value</td><td>Active Claim</td></tr>

%for i in obj.tagPoints:
<tr><td><a href="/tagpoints/${url(obj.tagPoints[i].name)}">${i|h}</a></td>
        %if len(obj.tagPoints)>8:
        <td>${str(obj.tagPoints[i].value)[:48]|h}</td>
        %elif hasattr(obj.tagPoints[i],'meterWidget'):
        <td>${obj.tagPoints[i].meterWidget.render()}</td>
        %else:
        <td>${obj.tagPoints[i].spanWidget.render()}</td>
        %endif

        <td>${obj.tagPoints[i].activeClaim().name|h}</td>
</tr>
%endfor
</table>
<h2>Messages</h2>
<p class="help">
        These are not logged. Add a message with device.print(message). Old messages
        are deleted. Most recent is first.
</p>
${obj.logWindow.render()}




<input type="submit" value="Save settings">

</form>



</div>

<script>
var mytable = $('#bindings').editTable({
    data: [['']],           // Fill the table with a js array (this is overridden by the textarea content if not empty)
    tableClass: 'inputtable',   // Table class, for styling
    jsonData: false,        // Fill the table with json data (this will override data property)
    headerCols: ['Device Point(dest)','Type(blank=auto)', 'External Point(source)'],      // Fix columns number and names (array of column names)
    maxRows: 999,           // Max number of rows which can be added
    first_row: true,        // First row should be highlighted?
    row_template: false,    // An array of column types set in field_templates
    field_templates: {
        'tag' : {
            html: '<input list="k_tags" style="width:25em"/>',
            getValue: function (input) {
                return $(input).val();
            },
            setValue: function (input, value) {
                //I hate ths
                return $('<input list="k_tags" value="'+value+'"style="width:25em"/>')
            }
        },
        'local' : {
            html: '<input list="k_tlocal"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_tlocal" value="'+value+'"style="width:25em"/>')
            }
        }
    },
    row_template: ['local', 'text', 'tag'],

    // Validate fields
    validate_field: function (col_id, value, col_type, $element) {
        return true;
    }
});

mytable.loadData(${json.dumps(data.get('kaithem.input_bindings',[])+ [['','','']])})
</script>
<%include file="/pagefooter.html"/>