<%include file="/pageheader.html"/>
<%
import traceback
import json
from src import unitsofmeasure,tagpoints, devices
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')


specialKeys={

        'subclass',
        'name',
        'type'
}
%>
<script type="text/javascript" src="/static/widget.js"></script>

<script type="text/javascript" src="/static/js/jquery3.js"></script>
<script type="text/javascript" src="/static/js/editTable/editTable.min.js"></script>
<link rel="stylesheet" href="/static/js/editTable/editTable.min.css">


<datalist id="k_tags">
        %for i in tagpoints.allTagsAtomic:
        <option>${i|h}</option>
        %endfor
</datalist>

<datalist id="k_tlocal">
        %for i in obj.tagPoints:
        <option>${i|h}</option>
        %endfor
</datalist>


<h1>Device Inspector: ${name} <span style="color: aquamarine;">${'(cross-framework)' if isinstance(obj, devices.CrossFrameworkDevice) else ''}</span>
</h1>
<div class="sectionbox">
<form method="post" action="/devices/discoveryStep?type=${url(data.get('type',''))}&devname=${url(name)}">
        <button type="submit">Search for auto-setup configurations</button>
</form>

<form method="POST" action="/devices/updateDevice/${url(name)}">

%if obj.parentModule:
<h2>Module/Resource</h2>
<p>This device is part of a module, rather than the global devices list.</p>
<input name="module" disabled value="${obj.parentModule|h}"><input name="module" disabled value="${obj.parentResource|h}">
%endif
<h2>Basic</h2>
<table border="1" style="width:40em">

<tr>
        <td>Device Type</td>
        <td><input name="type" disabled value="${data.get('type','')}"></td>
</tr>
<tr>
        <td>Device Name</td>
        <td><input name="name" value="${name}"></td>
</tr>

</table>

%if hasattr(obj,'description') and obj.description:
<h3>Description</h3>
<p>
        ${str(obj.description)[:8192]|h}
</p>
%endif

<input type="hidden" name="type" value="${data.get('type','')}">
<h2>Help</h2>
<ul>
<li><a href="/devices/devicedocs/${url(name)}">README for this device type</a></li>
</ul>
<title>${name|h}</title>


<h2>Bindings</h2>

<p class="help">A binding lets you make a data point of a device mirror an external point.  Following a publish subscribe model, 
        all of these devices are one way. The device will be updated when the tag point changes.  For the local point, 
        use the short name.  For the external point, use the long name.
</p>
<p class="help">As per the usual tag features, the tag does not actually have to exist, and you can use an expression like
"=tv("/some/tag/name") + 50" to create a virtual tag.
</p>

<p class="help">If either the external or device tag point exists, you can leave the type field blank.</p>


<textarea name="temp.kaithem.inputbindings" id="bindings" style="display: none">
${json.dumps(data.get('kaithem.input_bindings',[])) or '[]'|h}
</textarea>

<h2>Device Specific</h2>



%try:
<%
manageForm=''
if hasattr(obj,"getManagementForm"):
        manageForm = obj.getManagementForm()
%>
%except:
<pre>
${traceback.format_exc()}
</pre>
%endtry

%if manageForm.strip():
${manageForm}
%else:

<table>
%for i in sorted([i for i in obj.config.keys() if not i in specialKeys and not i.startswith("kaithem.")] ):
<tr>
        %if i.startswith('device.'):
        <td>${i[7:]|h}</td>
        %else:
        <td>${i[7:]|h}</td>
        %endif

        <td><input name="${i|h}" value="${obj.config[i]|h}"></td>
</tr>
%endfor
</table>
%endif

%if obj.alerts:
<h2>Alerts</h2>
<p class="help">This section lists all alerts supported by the device.
</p>
<p class="help">For new device types, the alarms will likely be configured via the corresponding
        tag point.
</p>

<table border="1" style="width:40em">
<tr><th>Name</th><th>Priority</th><th>Status</th></tr>

%for i in obj.alerts:
<tr><td>${i|h}</td>
        <td>
        %if hasattr(obj,'_noSetAlarmPriority'):
        ${obj.alerts[i].priority}
        %else:
        <select name="alerts.${i}.priority">
                <option value="debug" ${"selected" if obj.alerts[i].priority=="debug" else ""}>Debug</option>
                <option value="info" ${"selected" if obj.alerts[i].priority=="info" else ""}>Info</option>
                <option value="warning" ${"selected" if obj.alerts[i].priority=="warning" else ""}>Warning</option>
                <option value="error" ${"selected" if obj.alerts[i].priority=="error" else ""} >Error</option>
                <option value="critical" ${"selected" if obj.alerts[i].priority=="critical" else ""}>Critical</option>
        </select>
        %endif
        </td>
        <td>${obj.alerts[i].sm.state}</td>
</tr>
%endfor
</table>

%endif

<h2>Tag Points</h2>
<p class="help">This section lists all the tag points owned.  Controls do not work if
        the tag has been overriden by some high priority claim.
</p>
<table border="1" style="width:40em">
<tr><td>Name</td><td>Value</td><td>Controls.</td></tr>


<script>

        triggerCounters = {}
</script>
%for i in obj.tagPoints:
<tr><td><a href="/tagpoints/${url(obj.tagPoints[i].name)}">${i|h}</a></td>
        %if len(obj.tagPoints)>8:
        <td>${str(obj.tagPoints[i].value)[:48]|h}</td>
        %elif hasattr(obj.tagPoints[i],'meterWidget'):
        <td>${obj.tagPoints[i].meterWidget.render()}</td>
        %else:
        <td>${obj.tagPoints[i].spanWidget.render()}</td>
        %endif
        %if obj.tagPoints[i].activeClaim().priority > 50:
        <td>
                Overridden: ${obj.tagPoints[i].activeClaim().name}
        </td>
        %else:
        <td><div style="display: flex; flex-wrap: wrap;" class="buttonbar">
                %if (not hasattr(obj.tagPoints[i],"_dev_ui_writable")) or obj.tagPoints[i]._dev_ui_writable:
                %if obj.tagPoints[i].subtype == 'bool' or obj.tagPoints[i].subtype == 'boolean':
                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Set 0</button>
                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">Set 1</button>
                %elif obj.tagPoints[i].subtype == 'trigger':
                <button  type="button"  onclick="triggerCounters['${i|h}'] = (triggerCounters['${i|h}']||0)+1; _generic_ws_channel.send(['set', '${i|h}', triggerCounters['${i|h}']])">Trigger</button>
                %elif obj.tagPoints[i].subtype == 'color':
                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', prompt('New value?')])">Set Hex</button>
                <button  type="button"  style="background-color: black;  color: lightblue;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#000000'])">Blk</button>
                <button  style="background-color: #FF0000;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#FF0000'])">Red</button>
                <button   style="background-color: #FFDD00;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#FFDD00'])">Yel</button>
                <button   style="background-color: #00FF00;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#00FF00'])">Grn</button>
                <button   style="background-color: #0000FF;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#0000FF'])">Blu</button>
                <button   style="background-color: #8F17E5;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#8F17E5'])">Prp</button>
                <button  type="button"  style="background-color: white;  color: darkgray;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#FFFFFF'])">Wht</button>
                %else:
                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', prompt('New value?')])">Set val</button>
                        %if obj.tagPoints[i].max==1 and obj.tagPoints[0].min==0:
                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Set 0</button>
                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">Set 1</button>
                        %endif
                %endif
                %endif
                <button type="button" onclick="_generic_ws_channel.send(['refresh', '${i|h}'])">Refresh</button>
        </div>
        %if obj.tagPoints[i].subtype == 'color':
        <div class="buttonbar">
                <button  type="button"   style="background-color: #fafafa;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#fafafa'])">Argent</button>
                <button  type="button"   style="background-color: #ffe066;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#ffe066'])">Or</button>
                <button  type="button"   style="background-color: #f0dc82;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#f0dc82'])">Buff</button>
                <button  type="button"   style="background-color: #7c1c05;  color: lightblue;"" onclick="_generic_ws_channel.send(['set', '${i|h}', '#7c1c05'])">Copper</button>
        </div>
        <div class="buttonbar">
                <button  type="button"  style="background-color: #d7374a;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#d7374a'])">Gules</button>
                <button  type="button"  style="background-color: #333333; color: lightblue;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#333333'])">Sable</button>
                <button  type="button"  style="background-color: #377cd7;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#377cd7'])">Azure</button>
                <button  type="button"   style="background-color: #26c061;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#26c061'])">Vert</button>
                <button  type="button"   style="background-color: #522d5b;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#522d5b'])">Purpure</button>               
        </div>
        <div  class="buttonbar">
                <button  type="button"   style="background-color: #85185b;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#85185b'])">Murrey</button>
                <button  type="button"   style="background-color: #b63a3a;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#b63a3a'])">Sanguine</button>
                <button  type="button"   style="background-color: #cc7f19;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#cc7f19'])">Tenné</button>
                <button  type="button"   style="background-color: #F27900;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#F27900'])">Orange</button>
                <button  type="button"   style="background-color: #FEC3AC;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#FEC3AC'])">Carnation</button>
                <button  type="button"   style="background-color: #797673; color: lightblue;"" onclick="_generic_ws_channel.send(['set', '${i|h}', '#797673'])">Cendrée</button> 
        </div>
        %endif


        </td>

        %endif
</tr>
%endfor
</table>

<h2>Messages</h2>
<p class="help">
        These are not logged. Add a message with device.print(message). Old messages
        are deleted. Most recent is first.
</p>
${obj.logWindow.render()}

<h2>Permissions</h2>
<div>
<p class="help">
Set a default for all tag points exposed by this device.  You can further refine this in the tag points manager.
It is preferable to do things at the device-level, as devices can be bundle into modules, and you don't have to handle
settings individually for every tag.  Leave blank to disable.  These are used to make data points show up in the 
</p>

<p class="help">
Currently this is only supported for the newer cross-framework devices.
 </p>

<div class="buttonbar">
<label>Read:<input name="kaithem.read_perms" value="${data.get('kaithem.read_perms','')|h}" placeholder="__never__"></label>
<label>Write:<input name="kaithem.write_perms" value="${data.get('kaithem.write_perms','')|h}" placeholder="__never__"></label>
</div>
</div>
<hr>
<input type="submit" value="Save settings">

</form>



</div>

${obj._admin_ws_channel.render("_admin_ws_channel")}
${obj._generic_ws_channel.render("_generic_ws_channel")}

<script>


function send_ui_message(m)
{
        _admin_ws_channel.send(m)
}

function set_ui_message_handler(f)
{
        _admin_ws_channel.upd=f
}

var mytable = $('#bindings').editTable({
    data: [['']],           // Fill the table with a js array (this is overridden by the textarea content if not empty)
    tableClass: 'inputtable',   // Table class, for styling
    jsonData: false,        // Fill the table with json data (this will override data property)
    headerCols: ['Device Point(dest)','Type(blank=auto)', 'External Point(source)'],      // Fix columns number and names (array of column names)
    maxRows: 999,           // Max number of rows which can be added
    first_row: true,        // First row should be highlighted?
    row_template: false,    // An array of column types set in field_templates
    field_templates: {
        'tag' : {
            html: '<input list="k_tags" style="width:25em"/>',
            getValue: function (input) {
                return $(input).val();
            },
            setValue: function (input, value) {
                //I hate ths
                return $('<input list="k_tags" value="'+value+'"style="width:25em"/>')
            }
        },
        'local' : {
            html: '<input list="k_tlocal"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_tlocal" value="'+value+'"style="width:25em"/>')
            }
        }
    },
    row_template: ['local', 'text', 'tag'],

    // Validate fields
    validate_field: function (col_id, value, col_type, $element) {
        return true;
    }
});

mytable.loadData(${json.dumps(data.get('kaithem.input_bindings',[])+ [['','','']])})
</script>
<%include file="/pagefooter.html"/>