<%include file="/pageheader.html"/>
<%
import traceback
import json
import os
from kaithem.src import unitsofmeasure,tagpoints, devices,modules_state,auth
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')

def read(f):
    try:
        with open(f) as fd:
                return fd.read()
    except:
        return ""
specialKeys={

        'subclass',
        'name',
        'title',
        'type',
        'is_subdevice',
        'description',
        'notes'
}

%>

<style>
        .inputtable {
                width: 100%;
        }

        .tagbox{
                text-align: center;
        }
</style>
<script type="text/javascript" src="/static/widget.js"></script>
<script type="text/javascript" src="/static/js/mpegts.js"></script>

<link href="/static/js/croppr/croppr.css" rel="stylesheet"/>
<script type="text/javascript" src="/static/js/croppr/croppr.js"></script>


<script type="text/javascript" src="/static/js/jquery3.js"></script>
<script type="text/javascript" src="/static/js/editTable/editTable.min.js"></script>
<script src="/static/showdown.min.js"></script>



<script type="text/javascript" src="/static/js/evm/jsfeat.js"></script>
<script type="text/javascript" src="/static/js/evm/compat.js"></script>
<script type="text/javascript" src="/static/js/evm/color.js"></script>

<link rel="stylesheet" href="/static/js/editTable/editTable.min.css">

<datalist id="k_bindtype">
        <option>auto</option>
        <option>numeric</option>
        <option>string</option>
        <option value="object">JSON-like</option>
</datalist>

<datalist id="k_tags">
        <option value="=1+2*5">Simple expression</option>
        <option value="=tv('/exampleNumericTag')+5">Expression with tag val</option>
        <option value="=stv('/exampleStringTag')">Expression with string tag val</option>

        %for i in tagpoints.allTagsAtomic:
        <option>${i|h}</option>
        %endfor
</datalist>

<datalist id="k_tags_writable">
        %for i in tagpoints.allTagsAtomic:
        %if tagpoints.allTagsAtomic[i]().writable:
        <option>${i|h}</option>
        %endif
        %endfor
</datalist>


<datalist id="k_tlocal">
        %for i in obj.tagPoints:
        <option>${i|h}</option>
        %endfor
</datalist>

<datalist id="k_perms">
<option>/users/devices.write</option>
<option>/users/devices.read</option>

%for i in sorted(auth.Permissions.keys()):
<option>${i|h}</option>
%endfor
</datalist>

<h1 style="text-align: center;">Device Inspector: ${obj.title}
</h1>


<div style="display: flex; flex-wrap: wrap; justify-content: center;">
<div style="flex-basis: 20%; text-align: center;"><div class="decorative-image-settings decorative-image" style="height: 22em; min-width: 22em; max-width: 45vw; margin: auto;"></div></div>
            
<section style="width: 95%;"

%if not hasattr(obj,'_kaithem_is_subdevice'):
<form method="post" action="/devices/discoveryStep?type=${url(data.get('type',''))}&devname=${url(name)}">
        <button type="submit">Search for auto-setup configurations</button>
</form>
%endif
<form method="POST" action="/devices/updateDevice/${url(name)}">

%if obj.parentModule:
<h2>Module/Resource</h2>
<p>This device is part of a module, rather than the global devices list.</p>
<input name="module" disabled value="${obj.parentModule|h}"><input name="module" disabled value="${obj.parentResource|h}">
%endif

<details>
<summary>
<b>Basic</b>
</summary>
<table border="1"  style="width:100%">

<tr>
        <td>Device Type</td>
        <td>${data.get('type','')|h}</td>
</tr>
<tr>
        <td>Device Name</td>
        <td><input name="name" value="${name|h}"  
        %if hasattr(obj,"_kaithem_is_subdevice"):
        disabled
        %endif        
        ></td>
</tr>

<tr>
        <td>Device Title(Blank=use name)</td>
        <td><input name="title" value="${data.get('title','')|h}"  
        ></td>
</tr>

</table>

<h3>Description</h3>

<textarea name="description">${data.get('description','')}</textarea>
</details>

%if hasattr(obj,"device_type") and obj.device_type == "ESPHomeDevice":
<details>
        <summary><b>ESPHome Web UI</b></summary>
        Only works if this page is loaded over plain HTTP, due to browser restrictions.
        Use the <a href="http://${data.get('device.hostname','')}">Direct link</a> if the embedded viewer fails.
        <iframe src="http://${data.get('device.hostname','')}"   class="embedpage" style="width: 98%; height: 30em;"></iframe>
</details>
%endif

<details>
        <summary>
        <b>Notes</b>
        </summary>
        <details class="help"><summary><i class="icofont-question-circle"></i></summary>The notes do not show up in the main devices list. Use it to make your devices more self-describing without
                cluttering the overview page.
        </details>
        <textarea name="notes">${data.get('notes','')}</textarea>
</details>

<input type="hidden" name="type" value="${data.get('type','')}">

<details>
        <summary>
<b><i class="icofont-question-circle"></i>Help</b>
</summary>
%if hasattr(obj,'description') and obj.description:

<p id="desc">${str(obj.description)[:8192]|h}</p>

<script>
        showdown.setFlavor('github');
        var c= document.getElementById("desc").innerHTML;
        var converter = new showdown.Converter();
        document.getElementById("desc").innerHTML=converter.makeHtml(c);
</script>
    
%endif

%if hasattr(obj,'readme') and obj.readme:
<h3>Readme</h3>

<div class="max-h-12rem scroll border" id='readme'>
${obj.readme|h}
</div>

<script>
        showdown.setFlavor('github');
        var c= document.getElementById("readme").innerHTML;
        var converter = new showdown.Converter();
        document.getElementById("readme").innerHTML=converter.makeHtml(c);
</script>
%endif
</details>


<title>${name|h}</title>

<details>

<summary>
<b><i class="icofont-link"></i>Bindings(${len(data.get('kaithem.input_bindings',[])) + len(data.get('kaithem.input_bindings',[])) })</b>
</summary>

<details class="help"><summary><i class="icofont-question-circle"></i></summary>A binding lets you make a data point of a device mirror an external point.  Following a publish subscribe model, 
        all of these devices are one way. The device will be updated when the tag point changes.  For the local point, 
        use the short name.  For the external point, use the long name.
</details>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>As per the usual tag features, the tag does not actually have to exist, and you can use an expression like
"=tv("/some/tag/name") + 50" to create a virtual tag.
</details>

<details><summary><i class="icofont-question-circle"></i></summary>If either the external or device tag point exists, you can leave the type field blank.</details>


<textarea name="temp.kaithem.inputbindings" id="bindings" style="display: none">
${json.dumps(data.get('kaithem.input_bindings',[])) or '[]'|h}
</textarea>



<h2><i class="icofont-link"></i>Output Bindings</h2>

<details class="help"><summary><i class="icofont-question-circle"></i></summary>An output binding is just a command that the destination tag should change whenever the source tag does. 
        The source tag is one that is owned by this device.
</details>

<textarea name="temp.kaithem.outputbindings" id="bindings2" style="display: none">
${json.dumps(data.get('kaithem.output_bindings',[])) or '[]'|h}
</textarea>


</details>


<details>

<summary>
<b><i class="icofont-ui-settings"></i>Settings</b>
</summary>

%try:
<%
manageForm=''
if hasattr(obj,"getManagementForm"):
        manageForm = obj.getManagementForm()
%>
%except:
<pre>
${traceback.format_exc()}
</pre>
%endtry

%if manageForm.strip():
${manageForm}
%else:
<table  style="width:100%">
%for i in sorted([i for i in obj.config.keys() if not i in specialKeys and not i.startswith("kaithem.")] ):
<tr>
        %if i.startswith('device.'):
        <td style="max-width: 30%;">
                %if obj.config_properties.get(i,{}).get("description",''):
                <details><summary><i class="icofont-question-circle"></i><b>${i[7:]|h}</b></summary>${obj.config_properties.get(i,{}).get("description",'')|h}</details>
                %else:
                <b>${i[7:]|h}</b>
                %endif
                </td>
        %else:
        <td> <b>${i|h}</b></td>
        %endif


        <td>
                %if obj.config_properties.get(i,{}).get("type") =='bool':

                <select name="${i|h}">
                        <option>False/Off</option>
                        <option ${'selected' if obj.config[i].lower().strip() in ('true','yes','on','enable','active','enabled' ) else '' } value="true">True/On</option>
                </select>
                %else:
                        %if obj.config_properties.get(i,{}).get("secret",False):
                        <input name="${i|h}" id="property_${i|h}" value="${obj.config[i]|h}" type="password" onfocus="this.type='text'"  onblur="this.type='password'">
                        %else:
                        <input name="${i|h}"  id="property_${i|h}" value="${obj.config[i]|h}" style="width: 100%;">
                        %endif

                %endif

                %if obj.config_properties.get(i,{}).get("type") =='local_fs_dir':

                <a class="button" href="/settings/files/${url(os.path.expanduser(obj.config[i]))}"><i class="icofont-ui-folder"></i>Browse ${os.path.expanduser(obj.config[i])|h}</a>
                %endif

        
        </td>
</tr>
%endfor
</table>
%endif


<h3>Permissions</h3>
<div>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>
Set a default for all tag points exposed by this device.  You can further refine this in the tag points manager.
It is preferable to do things at the device-level, as devices can be bundle into modules, and you don't have to handle
settings individually for every tag.  Leave blank to disable.  These are used to make data points show up in the 
</details>

<details class="help"><summary><i class="icofont-question-circle"></i></summary>
Currently this is only supported for the newer cross-framework devices.
 </details>

<div class="tool-bar">
<label>Read:<input name="kaithem.read_perms" list="k_perms" value="${data.get('kaithem.read_perms','')|h}" placeholder="__never__"></label>
<label>Write:<input name="kaithem.write_perms" list="k_perms" value="${data.get('kaithem.write_perms','')|h}" placeholder="__never__"></label>
</div>

</div>

</details>


%if obj.alerts:

<details>
<summary>
<b><i class="icofont-ui-text-chat"></i>Alerts</b>
</summary>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>This section lists all alerts supported by the device.
</details>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>For new device types, the alarms will likely be configured via the corresponding
        tag point.
</details>

<table border="1" style="width:100%">
<tr><th>Name</th><th>Priority</th><th>Status</th></tr>

%for i in obj.alerts:
<tr><td>${i|h}</td>
        <td>
        %if hasattr(obj,'_noSetAlarmPriority'):
        ${obj.alerts[i].priority}
        %else:
        <select name="alerts.${i}.priority">
                <option value="debug" ${"selected" if obj.alerts[i].priority=="debug" else ""}>Debug</option>
                <option value="info" ${"selected" if obj.alerts[i].priority=="info" else ""}>Info</option>
                <option value="warning" ${"selected" if obj.alerts[i].priority=="warning" else ""}>Warning</option>
                <option value="error" ${"selected" if obj.alerts[i].priority=="error" else ""} >Error</option>
                <option value="critical" ${"selected" if obj.alerts[i].priority=="critical" else ""}>Critical</option>
        </select>
        %endif
        </td>
        <td>
                %if obj.alerts[i].sm.state=='normal':
                <i class="icofont-ui-check"></i>
                %else:
                <i class="icofont-warning"></i>
                %endif

                ${obj.alerts[i].sm.state}
        </td>
</tr>
%endfor
</table>

%endif
</details>

%if hasattr( obj,"text_config_files"):
%for i in obj.text_config_files:
<details>
        <summary>
        <b><i class="icofont-file-alt"></i>${i|h}</b>
        </summary>
<textarea data-editor="${i.split('.')[-1]}" style="height: 40em; width:90%;" name="filedata.${i}">${read(obj.get_config_folder()+"/"+i)|h}</textarea>
</details>
%endfor
%endif

%try:
%if obj.get_config_folder(create=False):
<details>
        <summary>
        <b><i class="icofont-file-alt"></i>Config Folder</b>
        </summary>
<a class="button" href="/settings/files/${url(obj.get_config_folder())}"><i class="icofont-ui-folder"></i>Browse</a>
</details>
%endif
%except:
%endtry


%if hasattr(obj,'metadata') and obj.metadata:
<details>
<summary>
<b><i class="icofont-ui-text-chat"></i>Metadata</b>
</summary>
<table border="1" style="width:100%">
<tr><th>Name</th><th>Value</th></tr>

%for i in obj.metadata:
<tr>
        <td>
                ${i|h}
        </td>
        <td>
        ${obj.metadata[i]|h}
        </td>
</tr>
%endfor
</table>

%endif
</details>

<b><i class="icofont-chart-flow-2"></i>Tag Points</b>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>This section lists all the tag points owned.  Controls do not work if
        the tag has been overriden by some high priority claim.
</details>

<script>

        triggerCounters = {}
</script>
<div style="display: flex; flex-wrap: wrap; flex-direction: row;">
%for i in obj.tagPoints:
%try:

<style>
        .croppr-imageClipped, .croppr-image
        {
                border: none;
        }
</style>

<article class="tagbox" style="margin: 1em; border-style: solid; border-width: 1px; padding: 0.2em; flex-basis: 18em; flex-grow: 0.5;">
<h3 style="font-size: 140%;"><a href="/tagpoints/${url(obj.tagPoints[i].name)}">${i|h}</a></h3>


        %if hasattr(obj.tagPoints[i],'meterWidget'):
        <h4>Current</h4>
        ${obj.tagPoints[i].meterWidget.render_as_span()}

        %elif hasattr(obj.tagPoints[i],'spanWidget'):
        <h4>Current</h4>
        ${obj.tagPoints[i].spanWidget.render()}
  
        %elif hasattr(obj.tagPoints[i],"dataSourceWidget") and obj.tagPoints[i].subtype == 'mpegts' and obj.tagPoints[i].dataSourceWidget:
        <video style="width: 100%" muted controls></video>
        <canvas id="canvas" style="display: none; width: 100%"></canvas>
        <img id="img" style="display: none; width: 100%; border: none;">

        <h4>Regions</h4>
        <div class="tool-bar" id="regions">
        </div>

        <div class="tool-bar">
                <button type="button" onclick="gotoRegionEdit(false)">Region Editor</button>
                <button type="button" onclick="setRegion()">New Region</button>
                <button type="button" onclick="deleteRegion()">Delete selected region</button>

        </div>

        <script>
                rdata = "test=0.1,0.6, 0.5,0.5;"

                var x = document.getElementById("property_device.regions")
                if(x)
                {
                        rdata = x.value;
                }

                selectedRegion = ''

                function deselectInactiveRegions()
                {
                        var x = document.getElementById("regions")
                        for (i of x.childNodes)
                        {
                                i.style = ''
                        }
                }



                rdata = rdata.split(";")

                videoSelectedRegions = {}

                selectedButton = null;

                try{
                for(i of rdata)
                {
                        if(i=='')
                        {
                                continue;
                        }
                        i = i.split('=')
                        n = i[0].trim()
                        i = i[1].split(",")
                        videoSelectedRegions[n] = {x:parseFloat(i[0]), y: parseFloat(i[1]), width: parseFloat(i[2]), height:parseFloat(i[3])}


                }
                }
                catch(e)
                {
                        console.log(e)
                }

                function redrawRegionBar()
                {
                        var x = document.getElementById("regions")
                        x.innerHTML = '';

                        for(i in videoSelectedRegions)
                        {
                                if(i=='')
                                {
                                        continue;
                                }
                                r = videoSelectedRegions[i]
                                button = document.createElement("button")
                                button.innerHTML = i
                                button.id = "regbutton_"+i
                                button.type='button'
                                if(i==selectedRegion)
                                {
                                        button.style='font-weight: bold;'
                
                                }
                                button.onclick = function(e)
                                {
                                        selectedRegion = e.target.innerHTML
                                        gotoRegionEdit(true);
                                        var r = videoSelectedRegions[e.target.innerHTML]

                                        // Fighting with the lib.  The rder and timing seems to matter

                                
                                        setTimeout(() =>{
                                        cropInstance.reset()
                                        cropInstance.moveTo(r.x * cropInstance.cropperEl.clientWidth , r.y *cropInstance.cropperEl.clientHeight )
                                        cropInstance.resizeTo(r.width * cropInstance.cropperEl.clientWidth ,r.height * cropInstance.cropperEl.clientHeight,[0,0])
                                        },10)
                                        deselectInactiveRegions()
                                        e.target.style='font-weight: bold'
                                }
                                x.appendChild(button)
                        }
                }
                redrawRegionBar();

                cropInstance = null

                function gotoRegionEdit(force)
                {
                        if(cropInstance && force)
                        {
                                // already open so return
                                return
                        }

                        if(cropInstance && (!force))
                        {
                                cropInstance.destroy();
                                cropInstance=null;
                                return;
                        }

                var v = document.querySelector('video')

                var canvas = document.createElement('canvas');
                canvas.width = v.videoWidth;
                canvas.height = v.videoHeight;
                canvas.style="border: none";
                var ctx = canvas.getContext('2d');


                //draw image to canvas. scale to target dimensions
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                document.querySelector('video').style="border: none; width: 100%; "

                //convert to desired file format
                var dataURI = canvas.toDataURL('image/jpeg'); // can also use 'image/png'

                document.querySelector('#img').src = dataURI
                document.querySelector('video').style="display: none; width: 100%"
                document.querySelector('#img').style=""

                cropInstance = new Croppr( document.querySelector('#img'), {
                        startSize: [30, 30],
                        returnMode: 'ratio',
                        onCropMove: function(data) {
                                var data = cropInstance.getValue('ratio')
                                videoSelectedRegions[selectedRegion] = data;
                                setRegions();
                        }
                });
                //cropInstance.initialize(document.querySelector('#img'))


                // store info there
                var v = document.querySelector('video')
                cropInstance.width = v.videoWidth;
                cropInstance.height = v.videoHeight;
        }
        
        function deleteRegion()
        {
                delete videoSelectedRegions[selectedRegion];
                selectedRegion = '';
                deselectInactiveRegions();
                redrawRegionBar()
        }

        function setRegion()
        {
                var x = document.getElementById("property_device.regions")
                if(x)
                {
                        var x = prompt("Name for region");
                        if(!x)
                        {
                                return;
                        }
                        x= x.replace(' ','').replace('/','').replace('.','').replace(",",'').replace(';','').replace('$','')
                        selectedRegion = x
                        videoSelectedRegions[selectedRegion] = cropInstance.getValue('ratio');
                }
                setRegions();
                redrawRegionBar();
        }

        function setRegions()
        {
                // Given our data cache set the text representation of the region list
                var x = document.getElementById("property_device.regions")
                if(x)
                {
                        x.value = ''
                        for(i in videoSelectedRegions)
                        {
                                if(i)
                                {
                                        var v =  videoSelectedRegions[i]
                                        x.value += i+'='+v['x']+','+v['y']+','+v['width']+','+v['height']+';'
                                }
                        }
                }
        }
        

        </script>

        <details class="help"><summary><i class="icofont-question-circle"></i></summary>
                The regions property is a semicolon separated list, looking like "name=x,y,w,h;".  To delete a region,
                just delete it's entry in the regions box.  A proper deletion feature coming soon.

        </details>
        <div class="tool-bar">
                <button type="button"  onclick="startEVM(document.querySelector('video'), document.querySelector('canvas'))">Amplify Motion</button>
        </div>
 
        <script> 
                if(!mpegts.isSupported())
                {       alert("MPEG TS Not supported here")
                        kaithemapi.sendErrorMessage("MPEG TS Not supported here")
                }

                video = document.querySelector('video');
                var player = mpegts.createPlayer({
                        type: 'mpegts',  // could also be mpegts, m2ts, flv
                        isLive: true,
                        url: kaithemapi.wsPrefix()+"/widgets/wsraw?widgetid=${obj.tagPoints[i].dataSourceWidget.uuid|u}",
                        liveBufferLatencyChasing: true,
                        liveBufferLatencyMaxLatency: 2,
                        liveBufferLatencyMinRemain: 1,
                        enableStashBuffer: false,
                        lazyLoad: false
                });
                player.attachMediaElement(video);
                player.load();
                player.play()

                function keepUp(){
                        if (video.buffered.length>0 && (video.buffered.end(video.buffered.length-1) -  video.currentTime ) > 2)
                        {
                                video.playbackRate=3
                        }
                        if (video.buffered.length> 0 && (video.buffered.end(video.buffered.length-1) -  video.currentTime ) < 1.5)
                        {
   
                                video.playbackRate=1
                        }

                }

                setInterval(keepUp, 250);

        </script>

        %else:
        Binary data tagpoint cannot be displayed.  
        %if obj.tagPoints[i].subtype == 'mpegts':
        If this is a video feed, you may need to set up Permissions on this device.
        %endif
        %endif

        %if not obj.tagPoints[i].subtype == 'mpegts':
                %if obj.tagPoints[i].activeClaim().priority > 50.5:
                        Overridden: ${obj.tagPoints[i].activeClaim().name}
                %else:
                <div style="display: flex; flex-wrap: wrap;" class="tool-bar">
                        %if (not hasattr(obj.tagPoints[i],"_dev_ui_writable")) or obj.tagPoints[i]._dev_ui_writable:
                                %if obj.tagPoints[i].subtype == 'bool' or obj.tagPoints[i].subtype == 'boolean':
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Off</button>
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">On</button>
                                %elif obj.tagPoints[i].subtype == 'tristate':
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Off</button>
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">On</button>
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', -1])">Unset</button>
                                %elif obj.tagPoints[i].subtype == 'trigger':
                                <button  type="button"  onclick="triggerCounters['${i|h}'] = (triggerCounters['${i|h}']||0)+1; _generic_ws_channel.send(['set', '${i|h}', triggerCounters['${i|h}']])">Trigger</button>
                                %elif obj.tagPoints[i].subtype == 'color':
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', prompt('New value?')])">Set Hex</button>
                                <button  type="button"  style="background-color: black;  color: lightblue;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#000000'])">Blk</button>
                                <button  style="background-color: #FF0000;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#FF0000'])">Red</button>
                                <button   style="background-color: #FFDD00;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#FFDD00'])">Yel</button>
                                <button   style="background-color: #00FF00;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#00FF00'])">Grn</button>
                                <button   style="background-color: #0000FF;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#0000FF'])">Blu</button>
                                <button   style="background-color: #8F17E5;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#8F17E5'])">Prp</button>
                                <button  type="button"  style="background-color: white;  color: darkgray;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#FFFFFF'])">Wht</button>
                                %else:
                                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', prompt('New value?')])">Set val</button>
                                        %if obj.tagPoints[i].max==1 and obj.tagPoints[i].min==0:
                                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Set 0</button>
                                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">Set 1</button>
                                        %endif
                                %endif
                        %else:
                                %if  obj.tagPoints[i].type=='number':
                                        <button type="button"  onclick="setFake('${i|h}', null)" title="Disable faking and use real value">Stop fake</button>

                                        %if obj.tagPoints[i].subtype == 'bool' or obj.tagPoints[i].subtype == 'boolean':
                                                <button type="button"  onclick="setFake('${i|h}', 0)" title="Fake input being zero">Fake Off</button>
                                                <button type="button"  onclick="setFake('${i|h}', 1)" title="Fake input being one">Fake On</button>
                                                <button type="button"  onmousedown="setFake('${i|h}', 1)"  onmouseup="setFake('${i|h}', null)" title="Fake 1 while held">Fake Press</button>
                                        %else:
                                                <button  type="button"  onclick="setFake('${i|h}', prompt('New value?'))">Set fake val</button>
                                        %if obj.tagPoints[i].max==1 and obj.tagPoints[i].min==0:
                                                <button type="button"  onclick="setFake('${i|h}', 0)" title="Fake input being zero">Fake Off</button>
                                                <button type="button"  onclick="setFake('${i|h}', 1)" title="Fake input being one">Fake On</button>
                                        %endif
                                        %endif

                                        %if obj.tagPoints[i].subtype == 'tristate':
                                                <button type="button"  onclick="setFake('${i|h}', -1)" title="Fake input being tristate/-1">Fake Unset</button>
                                        %endif
                                %endif
                        %endif
                        
                        %if callable(obj.tagPoints[i].activeClaim().value):
                        <button type="button" onclick="_generic_ws_channel.send(['refresh', '${i|h}'])">Refresh</button>
                        %else:
                        %endif
                </div>
        %endif

        %if obj.tagPoints[i].subtype == 'color':
        <div class="tool-bar">
                <button  type="button"   style="background-color: #fafafa;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#fafafa'])">Argent</button>
                <button  type="button"   style="background-color: #ffe066;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#ffe066'])">Or</button>
                <button  type="button"   style="background-color: #f0dc82;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#f0dc82'])">Buff</button>
                <button  type="button"   style="background-color: #7c1c05;  color: lightblue;"" onclick="_generic_ws_channel.send(['set', '${i|h}', '#7c1c05'])">Copper</button>
        </div>
        <div class="tool-bar">
                <button  type="button"  style="background-color: #d7374a;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#d7374a'])">Gules</button>
                <button  type="button"  style="background-color: #333333; color: lightblue;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#333333'])">Sable</button>
                <button  type="button"  style="background-color: #377cd7;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#377cd7'])">Azure</button>
                <button  type="button"   style="background-color: #26c061;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#26c061'])">Vert</button>
                <button  type="button"   style="background-color: #854296;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#854296'])">Purpure</button>               
        </div>
        <div  class="tool-bar">
                <button  type="button"   style="background-color: #85185b;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#85185b'])">Murrey</button>
                <button  type="button"   style="background-color: #b63a3a;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#b63a3a'])">Sanguine</button>
                <button  type="button"   style="background-color: #cc7f19;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#cc7f19'])">Tenné</button>
                <button  type="button"   style="background-color: #F27900;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#F27900'])">Orange</button>
                <button  type="button"   style="background-color: #FEC3AC;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#FEC3AC'])">Carnation</button>
                <button  type="button"   style="background-color: #797673; color: lightblue;"" onclick="_generic_ws_channel.send(['set', '${i|h}', '#797673'])">Cendrée</button> 
        </div>
        %endif

        %endif
</article>
%except:
</div>
<div>
<hr><hr>
        ${traceback.format_exc()|h}
<hr><hr>
</div>
%endtry
%endfor

</div>


<h2>Messages</h2>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>
        These are not logged. Add a message with device.print(message). Old messages
        are deleted. Most recent is first.
</details>
${obj.logWindow.render()}



<hr>
<input type="submit" value="Save settings">

</form>



</section>




<div style="flex-basis: 20%; min-width: 12em;"></div>
</div>

${obj._admin_ws_channel.render("_admin_ws_channel")}
${obj._generic_ws_channel.render("_generic_ws_channel")}
<script>

fakesOn = false;
function setFake(k,v)
{
        if(!fakesOn){
                        fakesOn=confirm("Enable faking input values?");
                }
                if(fakesOn)
                {
                        _generic_ws_channel.send(['fake',k, v])
                }
        
}

function send_ui_message(m)
{
        _admin_ws_channel.send(m)
}

function set_ui_message_handler(f)
{
        _admin_ws_channel.upd=f
}

var mytable = $('#bindings').editTable({
    data: [['']],           // Fill the table with a js array (this is overridden by the textarea content if not empty)
    tableClass: 'inputtable',   // Table class, for styling
    jsonData: false,        // Fill the table with json data (this will override data property)
    headerCols: ['Device Point(dest)','Type', 'External Point(source)'],      // Fix columns number and names (array of column names)
    maxRows: 999,           // Max number of rows which can be added
    first_row: true,        // First row should be highlighted?
    row_template: false,    // An array of column types set in field_templates
    field_templates: {
        'tag' : {
            html: '<input list="k_tags" />',
            getValue: function (input) {
                return $(input).val();
            },
            setValue: function (input, value) {
                //I hate ths
                return $('<input list="k_tags" value="'+value+'"/>')
            }
        },
        'local' : {
            html: '<input list="k_tlocal"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_tlocal" value="'+value+'"/>')
            }
        },
        'btype' : {
            html: '<input placeholder="auto" list="k_bindtype"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_bindtype" value="'+value+'"style="width:6em"/>')
            }
        }
    },
    row_template: ['local', 'btype', 'tag'],

    // Validate fields
    validate_field: function (col_id, value, col_type, $element) {
        return true;
    }
});

mytable.loadData(${json.dumps(data.get('kaithem.input_bindings',[])+ [['','','']])})


var mytable2 = $('#bindings2').editTable({
    data: [['','']],           // Fill the table with a js array (this is overridden by the textarea content if not empty)
    tableClass: 'inputtable',   // Table class, for styling
    jsonData: false,        // Fill the table with json data (this will override data property)
    headerCols: ['Device Point(Source)','External Point(dest)'],      // Fix columns number and names (array of column names)
    maxRows: 999,           // Max number of rows which can be added
    first_row: true,        // First row should be highlighted?
    row_template: false,    // An array of column types set in field_templates
    field_templates: {
        'tag' : {
            html: '<input list="k_tags_writable" />',
            getValue: function (input) {
                return $(input).val();
            },
            setValue: function (input, value) {
                //I hate ths
                return $('<input list="k_tags" value="'+value+'"/>')
            }
        },
        'local' : {
            html: '<input list="k_tlocal"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_tlocal" value="'+value+'"/>')
            }
        }
    },
    row_template: ['local', 'tag'],

    // Validate fields
    validate_field: function (col_id, value, col_type, $element) {
        return true;
    }
});

mytable2.loadData(${json.dumps(data.get('kaithem.output_bindings',[])+ [['','']])})


</script>




<script type="text/javascript">
// lets do some fun


function startEVM(video,canvas){

        canvas.style.display="block"

        var alpha = 10, 
        lambda_c = 16, 
        r1 = 0.4, 
        r2 = 0.05, 
        chromAttenuation = 1;

        var exaggeration_factor = 2;

        // document.getElementById('r1').value = r1;
        // document.getElementById('r2').value = r2;
        // document.getElementById('alpha').value = alpha;
        // document.getElementById('lambdac').value = lambda_c;
        // document.getElementById('chroma').value = chromAttenuation;
        // document.getElementById('exa').value = exaggeration_factor;


        // function updateR12(){
        // r1 = +document.getElementById('r1').value;
        // r2 = +document.getElementById('r2').value; 
        // alpha = +document.getElementById('alpha').value;
        // lambda_c = +document.getElementById('lambdac').value;    
        // chromAttenuation = +document.getElementById('chroma').value;    
        // exaggeration_factor = +document.getElementById('exa').value;    
        // }

        try {
        var attempts = 0;
        var readyListener = function(event) {
                findVideoSize();
        };
        var findVideoSize = function() {
                // demo_app(width, height);
                var s = Math.min(640 / video.videoWidth, 480 / video.videoHeight)
                
                var w = Math.floor(video.videoWidth * s >> 3) << 3,
                h = Math.floor(video.videoHeight * s >> 3) << 3;
                // video.style.width = w + 'px'
                // demo_app(Math.max(480, w), Math.max(480, h))
                // demo_app(640, 480)
                demo_app(Math.max(480, w), h)
                canvas.width = w
                canvas.height = h

                compatibility.requestAnimationFrame(tick);
        };

        setTimeout(readyListener, 300);
        } catch (error) {
        console.log(error)
        }

        var current_frame = 0;
        var frames_processed = 0;

        function tick() {
        compatibility.requestAnimationFrame(tick);
        // stat.new_frame();
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // ctx.drawImage(video, 0, 0, 640, 480);
                ctx.fillRect(0, 0, 640, 480)
                var s = Math.min(640 / video.videoWidth, 480 / video.videoHeight)
                // var s = 0.01 // call this number for fun times
                ctx.drawImage(video, 0, 0, video.videoWidth * s, video.videoHeight * s)
                
                evm()
                if(frames_processed == 0){
                lowpass1.iirFilter(img_pyr, 1);
                lowpass2.iirFilter(img_pyr, 1);
                }
                frames_processed++
                
        }
        }
}
</script>

<script src="/static/js/src-min-noconflict/ace.js"></script>
<script src="/static/js/jquery3.js"></script>

<script>
    // Hook up ACE editor to all textareas with data-editor attribute
    $(function () {
        $('textarea[data-editor]').each(function () {
            var textarea = $(this);
            var mode = textarea.data('editor');
            var editDiv = $('<div>', {
                position: 'absolute',
                width: textarea.width(),
                height: textarea.height(),
                'class': textarea.attr('class')
            }).insertBefore(textarea);
            textarea.css('display', 'none');
            var editor = ace.edit(editDiv[0]);
            editor.renderer.setShowGutter(true);
            editor.getSession().setValue(textarea.val());
            editor.getSession().setMode("ace/mode/" + mode);
            // editor.setTheme("ace/theme/idle_fingers");
            editor.setOptions({
             fontFamily: "Hack",
            fontSize: "12pt"
            });
            editor.getSession().on('change', function() {
                wasChanged=true;
            })
            // copy back to textarea on form submit...
            textarea.closest('form').submit(function () {
                textarea.val(editor.getSession().getValue());
            })
        });
    });
</script>
<%include file="/pagefooter.html"/>