<%include file="/pageheader.html"/>
<%
import traceback
import json
from src import unitsofmeasure,tagpoints, devices
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')


specialKeys={

        'subclass',
        'name',
        'type'
}
%>

<style>
        .inputtable {
                width: 100%;
        }

        .tagbox{
                text-align: center;
        }
</style>
<script type="text/javascript" src="/static/widget.js"></script>
<script type="text/javascript" src="/static/js/mpegts.js"></script>

<script type="text/javascript" src="/static/js/jquery3.js"></script>
<script type="text/javascript" src="/static/js/editTable/editTable.min.js"></script>



<script type="text/javascript" src="/static/js/evm/jsfeat.js"></script>
<script type="text/javascript" src="/static/js/evm/compat.js"></script>
<script type="text/javascript" src="/static/js/evm/color.js"></script>

<link rel="stylesheet" href="/static/js/editTable/editTable.min.css">

<datalist id="k_bindtype">
        <option>auto</option>
        <option>numeric</option>
        <option>string</option>
        <option value="object">JSON-like</option>
</datalist>

<datalist id="k_tags">
        <option value="=1+2*5">Simple expression</option>
        <option value="=tv('/exampleNumericTag')+5">Expression with tag val</option>
        <option value="=stv('/exampleStringTag')">Expression with string tag val</option>

        %for i in tagpoints.allTagsAtomic:
        <option>${i|h}</option>
        %endfor
</datalist>

<datalist id="k_tlocal">
        %for i in obj.tagPoints:
        <option>${i|h}</option>
        %endfor
</datalist>


<h1>Device Inspector: ${name} <span style="color: aquamarine;">${'(cross-framework)' if isinstance(obj, devices.CrossFrameworkDevice) else ''}</span>
</h1>
<div class="sectionbox">
<form method="post" action="/devices/discoveryStep?type=${url(data.get('type',''))}&devname=${url(name)}">
        <button type="submit">Search for auto-setup configurations</button>
</form>

<form method="POST" action="/devices/updateDevice/${url(name)}">

%if obj.parentModule:
<h2>Module/Resource</h2>
<p>This device is part of a module, rather than the global devices list.</p>
<input name="module" disabled value="${obj.parentModule|h}"><input name="module" disabled value="${obj.parentResource|h}">
%endif
<h2>Basic</h2>
<table border="1"  style="width:100%">

<tr>
        <td>Device Type</td>
        <td>${data.get('type','')|h}</td>
</tr>
<tr>
        <td>Device Name</td>
        <td><input name="name" value="${name|h}"></td>
</tr>

</table>



<input type="hidden" name="type" value="${data.get('type','')}">
<h2><i class="icofont-question-circle"></i>Help</h2>

%if hasattr(obj,'description') and obj.description:
<h3>Description</h3>
<p>
        ${str(obj.description)[:8192]|h}
</p>
%endif

<ul>
<li><a href="/devices/devicedocs/${url(name)}">README for this device type</a></li>
</ul>
<title>${name|h}</title>


<h2><i class="icofont-link"></i>Bindings</h2>

<p class="help">A binding lets you make a data point of a device mirror an external point.  Following a publish subscribe model, 
        all of these devices are one way. The device will be updated when the tag point changes.  For the local point, 
        use the short name.  For the external point, use the long name.
</p>
<p class="help">As per the usual tag features, the tag does not actually have to exist, and you can use an expression like
"=tv("/some/tag/name") + 50" to create a virtual tag.
</p>

<p class="help">If either the external or device tag point exists, you can leave the type field blank.</p>


<textarea name="temp.kaithem.inputbindings" id="bindings" style="display: none">
${json.dumps(data.get('kaithem.input_bindings',[])) or '[]'|h}
</textarea>

<h2><i class="icofont-ui-settings"></i>Settings</h2>



%try:
<%
manageForm=''
if hasattr(obj,"getManagementForm"):
        manageForm = obj.getManagementForm()
%>
%except:
<pre>
${traceback.format_exc()}
</pre>
%endtry

%if manageForm.strip():
${manageForm}
%else:
<table  style="width:100%">
%for i in sorted([i for i in obj.config.keys() if not i in specialKeys and not i.startswith("kaithem.")] ):
<tr>
        %if i.startswith('device.'):
        <td>${i[7:]|h}</td>
        %else:
        <td>${i|h}</td>
        %endif


        <td>
                %if obj.config_properties.get(i,{}).get("type") =='bool':

                <select name="${i|h}">
                        <option>False/Off</option>
                        <option ${'selected' if obj.config[i].lower().strip() in ('true','yes','on','enable','active','enabled' ) else '' } value="true">True/On</option>
                        
                </select>
                %else:
                <input name="${i|h}" value="${obj.config[i]|h}">
                %endif
        
        
        </td>
</tr>
%endfor
</table>
%endif

%if obj.alerts:
<h2><i class="icofont-ui-text-chat"></i>Alerts</h2>
<p class="help">This section lists all alerts supported by the device.
</p>
<p class="help">For new device types, the alarms will likely be configured via the corresponding
        tag point.
</p>

<table border="1" style="width:100%">
<tr><th>Name</th><th>Priority</th><th>Status</th></tr>

%for i in obj.alerts:
<tr><td>${i|h}</td>
        <td>
        %if hasattr(obj,'_noSetAlarmPriority'):
        ${obj.alerts[i].priority}
        %else:
        <select name="alerts.${i}.priority">
                <option value="debug" ${"selected" if obj.alerts[i].priority=="debug" else ""}>Debug</option>
                <option value="info" ${"selected" if obj.alerts[i].priority=="info" else ""}>Info</option>
                <option value="warning" ${"selected" if obj.alerts[i].priority=="warning" else ""}>Warning</option>
                <option value="error" ${"selected" if obj.alerts[i].priority=="error" else ""} >Error</option>
                <option value="critical" ${"selected" if obj.alerts[i].priority=="critical" else ""}>Critical</option>
        </select>
        %endif
        </td>
        <td>
                %if obj.alerts[i].sm.state=='normal':
                <i class="icofont-ui-check"></i>
                %else:
                <i class="icofont-warning"></i>
                %endif

                ${obj.alerts[i].sm.state}
        </td>
</tr>
%endfor
</table>

%endif

<h2><i class="icofont-chart-flow-2"></i>Tag Points</h2>
<p class="help">This section lists all the tag points owned.  Controls do not work if
        the tag has been overriden by some high priority claim.
</p>

<script>

        triggerCounters = {}
</script>
%for i in obj.tagPoints:
<div class="tagbox" style="margin: 1em; border-style: solid; border-width: 1px; padding: 0.2em;">
<h3 style="font-size: 140%;"><a href="/tagpoints/${url(obj.tagPoints[i].name)}">${i|h}</a></h3>


        %if hasattr(obj.tagPoints[i],'meterWidget'):
        <h4>Current</h4>
        ${obj.tagPoints[i].meterWidget.render()}

        %elif hasattr(obj.tagPoints[i],'spanWidget'):
        <h4>Current</h4>
        ${obj.tagPoints[i].spanWidget.render()}
  
        %elif hasattr(obj.tagPoints[i],"dataSourceWidget") and obj.tagPoints[i].subtype == 'mpegts':
        <video style="width: 100%" muted controls></video>
        <canvas id="canvas" style="display: none; width: 100%"></canvas>

        <h4>Controls</h4>

        <div class="buttonbar">
                <button type="button"  onclick="startEVM(document.querySelector('video'), document.querySelector('canvas'))">Amplify Motion</button>
        </div>
 
        <script> 
                if(!mpegts.isSupported())
                {       alert("MPEG TS Not supported here")
                        kaithemapi.sendErrorMessage("MPEG TS Not supported here")
                }

                video = document.querySelector('video');
                var player = mpegts.createPlayer({
                        type: 'mpegts',  // could also be mpegts, m2ts, flv
                        isLive: true,
                        url: kaithemapi.wsPrefix()+"/widgets/wsraw?widgetid=${obj.tagPoints[i].dataSourceWidget.uuid|u}",
                        liveBufferLatencyChasing: true,
                        liveBufferLatencyMaxLatency: 2,
                        liveBufferLatencyMinRemain: 1,
                        enableStashBuffer: false,
                        lazyLoad: false
                });
                player.attachMediaElement(video);
                player.load();
                player.play()

                function keepUp(){
                        if (video.buffered.length>0 && (video.buffered.end(video.buffered.length-1) -  video.currentTime ) > 2)
                        {
                                video.playbackRate=3
                        }
                        if (video.buffered.length> 0 && (video.buffered.end(video.buffered.length-1) -  video.currentTime ) < 1.5)
                        {
   
                                video.playbackRate=1
                        }

                }

                setInterval(keepUp, 250);

        </script>

        %else:
        Binary data tagpoint cannot be displayed
        %endif

        %if not obj.tagPoints[i].subtype == 'mpegts':
                <h4>Controls</h4>
                %if obj.tagPoints[i].activeClaim().priority > 50:
                        Overridden: ${obj.tagPoints[i].activeClaim().name}
                %else:
                <div style="display: flex; flex-wrap: wrap;" class="buttonbar">
                        %if (not hasattr(obj.tagPoints[i],"_dev_ui_writable")) or obj.tagPoints[i]._dev_ui_writable:
                        %if obj.tagPoints[i].subtype == 'bool' or obj.tagPoints[i].subtype == 'boolean':
                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Off</button>
                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">On</button>
                        %elif obj.tagPoints[i].subtype == 'trigger':
                        <button  type="button"  onclick="triggerCounters['${i|h}'] = (triggerCounters['${i|h}']||0)+1; _generic_ws_channel.send(['set', '${i|h}', triggerCounters['${i|h}']])">Trigger</button>
                        %elif obj.tagPoints[i].subtype == 'color':
                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', prompt('New value?')])">Set Hex</button>
                        <button  type="button"  style="background-color: black;  color: lightblue;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#000000'])">Blk</button>
                        <button  style="background-color: #FF0000;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#FF0000'])">Red</button>
                        <button   style="background-color: #FFDD00;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#FFDD00'])">Yel</button>
                        <button   style="background-color: #00FF00;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#00FF00'])">Grn</button>
                        <button   style="background-color: #0000FF;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#0000FF'])">Blu</button>
                        <button   style="background-color: #8F17E5;" type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#8F17E5'])">Prp</button>
                        <button  type="button"  style="background-color: white;  color: darkgray;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#FFFFFF'])">Wht</button>
                        %else:
                        <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', prompt('New value?')])">Set val</button>
                                %if obj.tagPoints[i].max==1 and obj.tagPoints[0].min==0:
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 0])">Set 0</button>
                                <button  type="button"  onclick="_generic_ws_channel.send(['set', '${i|h}', 1])">Set 1</button>
                                %endif
                        %endif
                        %endif
                        
                        %if callable(obj.tagPoints[i].activeClaim().value):
                        <button type="button" onclick="_generic_ws_channel.send(['refresh', '${i|h}'])">Refresh</button>
                        %else:
                        <button title="Tag does not support refresh" disabled type="button" onclick="_generic_ws_channel.send(['refresh', '${i|h}'])">Refresh</button>
                        %endif
                </div>
        %endif

        %if obj.tagPoints[i].subtype == 'color':
        <div class="buttonbar">
                <button  type="button"   style="background-color: #fafafa;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#fafafa'])">Argent</button>
                <button  type="button"   style="background-color: #ffe066;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#ffe066'])">Or</button>
                <button  type="button"   style="background-color: #f0dc82;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#f0dc82'])">Buff</button>
                <button  type="button"   style="background-color: #7c1c05;  color: lightblue;"" onclick="_generic_ws_channel.send(['set', '${i|h}', '#7c1c05'])">Copper</button>
        </div>
        <div class="buttonbar">
                <button  type="button"  style="background-color: #d7374a;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#d7374a'])">Gules</button>
                <button  type="button"  style="background-color: #333333; color: lightblue;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#333333'])">Sable</button>
                <button  type="button"  style="background-color: #377cd7;"  onclick="_generic_ws_channel.send(['set', '${i|h}', '#377cd7'])">Azure</button>
                <button  type="button"   style="background-color: #26c061;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#26c061'])">Vert</button>
                <button  type="button"   style="background-color: #522d5b;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#522d5b'])">Purpure</button>               
        </div>
        <div  class="buttonbar">
                <button  type="button"   style="background-color: #85185b;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#85185b'])">Murrey</button>
                <button  type="button"   style="background-color: #b63a3a;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#b63a3a'])">Sanguine</button>
                <button  type="button"   style="background-color: #cc7f19;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#cc7f19'])">Tenné</button>
                <button  type="button"   style="background-color: #F27900;  color: lightblue;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#F27900'])">Orange</button>
                <button  type="button"   style="background-color: #FEC3AC;" onclick="_generic_ws_channel.send(['set', '${i|h}', '#FEC3AC'])">Carnation</button>
                <button  type="button"   style="background-color: #797673; color: lightblue;"" onclick="_generic_ws_channel.send(['set', '${i|h}', '#797673'])">Cendrée</button> 
        </div>
        %endif



        %endif
</div>
%endfor

<h2>Messages</h2>
<p class="help">
        These are not logged. Add a message with device.print(message). Old messages
        are deleted. Most recent is first.
</p>
${obj.logWindow.render()}

<h2>Permissions</h2>
<div>
<p class="help">
Set a default for all tag points exposed by this device.  You can further refine this in the tag points manager.
It is preferable to do things at the device-level, as devices can be bundle into modules, and you don't have to handle
settings individually for every tag.  Leave blank to disable.  These are used to make data points show up in the 
</p>

<p class="help">
Currently this is only supported for the newer cross-framework devices.
 </p>

<div class="buttonbar">
<label>Read:<input name="kaithem.read_perms" value="${data.get('kaithem.read_perms','')|h}" placeholder="__never__"></label>
<label>Write:<input name="kaithem.write_perms" value="${data.get('kaithem.write_perms','')|h}" placeholder="__never__"></label>
</div>
</div>
<hr>
<input type="submit" value="Save settings">

</form>



</div>

${obj._admin_ws_channel.render("_admin_ws_channel")}
${obj._generic_ws_channel.render("_generic_ws_channel")}

<script>


function send_ui_message(m)
{
        _admin_ws_channel.send(m)
}

function set_ui_message_handler(f)
{
        _admin_ws_channel.upd=f
}

var mytable = $('#bindings').editTable({
    data: [['']],           // Fill the table with a js array (this is overridden by the textarea content if not empty)
    tableClass: 'inputtable',   // Table class, for styling
    jsonData: false,        // Fill the table with json data (this will override data property)
    headerCols: ['Device Point(dest)','Type', 'External Point(source)'],      // Fix columns number and names (array of column names)
    maxRows: 999,           // Max number of rows which can be added
    first_row: true,        // First row should be highlighted?
    row_template: false,    // An array of column types set in field_templates
    field_templates: {
        'tag' : {
            html: '<input list="k_tags" />',
            getValue: function (input) {
                return $(input).val();
            },
            setValue: function (input, value) {
                //I hate ths
                return $('<input list="k_tags" value="'+value+'"/>')
            }
        },
        'local' : {
            html: '<input list="k_tlocal"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_tlocal" value="'+value+'"/>')
            }
        },
        'btype' : {
            html: '<input placeholder="auto" list="k_bindtype"/>',
            getValue: function (input) {
                return $(input).val()
            },
            setValue: function (input, value) {
                return $('<input list="k_bindtype" value="'+value+'"style="width:6em"/>')
            }
        }
    },
    row_template: ['local', 'btype', 'tag'],

    // Validate fields
    validate_field: function (col_id, value, col_type, $element) {
        return true;
    }
});

mytable.loadData(${json.dumps(data.get('kaithem.input_bindings',[])+ [['','','']])})
</script>




<script type="text/javascript">
// lets do some fun


function startEVM(video,canvas){

        canvas.style.display="block"

        var alpha = 10, 
        lambda_c = 16, 
        r1 = 0.4, 
        r2 = 0.05, 
        chromAttenuation = 1;

        var exaggeration_factor = 2;

        // document.getElementById('r1').value = r1;
        // document.getElementById('r2').value = r2;
        // document.getElementById('alpha').value = alpha;
        // document.getElementById('lambdac').value = lambda_c;
        // document.getElementById('chroma').value = chromAttenuation;
        // document.getElementById('exa').value = exaggeration_factor;


        // function updateR12(){
        // r1 = +document.getElementById('r1').value;
        // r2 = +document.getElementById('r2').value; 
        // alpha = +document.getElementById('alpha').value;
        // lambda_c = +document.getElementById('lambdac').value;    
        // chromAttenuation = +document.getElementById('chroma').value;    
        // exaggeration_factor = +document.getElementById('exa').value;    
        // }

        try {
        var attempts = 0;
        var readyListener = function(event) {
                findVideoSize();
        };
        var findVideoSize = function() {
                // demo_app(width, height);
                var s = Math.min(640 / video.videoWidth, 480 / video.videoHeight)
                
                var w = Math.floor(video.videoWidth * s >> 3) << 3,
                h = Math.floor(video.videoHeight * s >> 3) << 3;
                // video.style.width = w + 'px'
                // demo_app(Math.max(480, w), Math.max(480, h))
                // demo_app(640, 480)
                demo_app(Math.max(480, w), h)
                canvas.width = w
                canvas.height = h

                compatibility.requestAnimationFrame(tick);
        };

        setTimeout(readyListener, 300);
        } catch (error) {
        console.log(error)
        }

        var current_frame = 0;
        var frames_processed = 0;

        function tick() {
        compatibility.requestAnimationFrame(tick);
        // stat.new_frame();
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // ctx.drawImage(video, 0, 0, 640, 480);
                ctx.fillRect(0, 0, 640, 480)
                var s = Math.min(640 / video.videoWidth, 480 / video.videoHeight)
                // var s = 0.01 // call this number for fun times
                ctx.drawImage(video, 0, 0, video.videoWidth * s, video.videoHeight * s)
                
                evm()
                if(frames_processed == 0){
                lowpass1.iirFilter(img_pyr, 1);
                lowpass2.iirFilter(img_pyr, 1);
                }
                frames_processed++
                
        }
        }
}
</script>
<%include file="/pagefooter.html"/>