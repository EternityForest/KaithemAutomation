<%include file="/pageheader.html"/>
<%
import traceback
from src import unitsofmeasure
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')


specialKeys={

        'subclass',
        'name',
        'type'
}
%>
<script type="text/javascript" src="/static/widget.js"></script>

<h1>Device Inspector: ${name}</h1>
<div class="sectionbox">
<a class="button" href="/devices/discoveryStep?type=${url(data.get('type',''))}&devname=${url(name)}">Search for auto-setup configurations</a>

<form method="POST" action="/devices/updateDevice/${url(name)}">

%if obj.parentModule:
<h2>Module/Resource</h2>
<p>This device is part of a module, rather than the global devices list.</p>
<input name="module" disabled value="${obj.parentModule|h}"><input name="module" disabled value="${obj.parentResource|h}">
%endif
<h2>Basic</h2>
<table border="1" style="width:40em">

<tr>
        <td>Device Type</td>
        <td><input name="type" disabled value="${data.get('type','')}"></td>
</tr>
<tr>
        <td>Device Name</td>
        <td><input name="name" value="${name}"></td>
</tr>

</table>
<input type="hidden" name="type" value="${data.get('type','')}">
<h2>Help</h2>
<ul>
<li><a href="/devices/devicedocs/${url(name)}">README for this device type</a></li>
<li><a href="/docs/mdtemplate?page=devices.md">Generic Device API and Subclassing</a></li>
</ul>
<title>${name|h}</title>
<h2>Device Specific</h2>



%try:
<%
manageForm=''
if hasattr(obj,"getManagementForm"):
        manageForm = obj.getManagementForm()
%>
%except:
<pre>
${traceback.format_exc()}
</pre>
%endtry

%if manageForm.strip():
${manageForm}
%else:

<table>
%for i in sorted([i for i in obj.config.keys() if not i in specialKeys] ):
<tr>
        <td>${i|h}</td>
        <td><input name="${i|h}" value="${obj.config[i]|h}"></td>
</tr>
%endfor
</table>
%endif
<h2>Alerts</h2>
<p class="help">This section lists all alerts supported by the device and
        allows you to change the priorities for each.
</p>
<p class="help">For new device types, the alarms will likely be configured via the corresponding
        tag point.
</p>

<table border="1" style="width:40em">
<tr><td>Name</td><td>Priority</td><td>Status</td></tr>

%for i in obj.alerts:
<tr><td>${i|h}</td>
        <td>
        %if hasattr(obj,'_noSetAlarmPriority'):
        ${obj.alerts[i].priority}
        %else:
        <select name="alerts.${i}.priority">
                <option value="debug" ${"selected" if obj.alerts[i].priority=="debug" else ""}>Debug</option>
                <option value="info" ${"selected" if obj.alerts[i].priority=="info" else ""}>Info</option>
                <option value="warning" ${"selected" if obj.alerts[i].priority=="warning" else ""}>Warning</option>
                <option value="error" ${"selected" if obj.alerts[i].priority=="error" else ""} >Error</option>
                <option value="critical" ${"selected" if obj.alerts[i].priority=="critical" else ""}>Critical</option>
        </select>
        %endif
        </td>
        <td>${obj.alerts[i].sm.state}</td>
</tr>
%endfor
</table>

<h2>Customize Code</h2>
<p class="help">Here you can use Python code to create a custom subclass of a device, useful for attaching handlers to callbacks.
</p>
<p class="help">The class must be named CustomDeviceType, and must inherit from DeviceType.  Only this instance of the device type is affected.  Clear this box and make it blank to reset to the example.</p>
<div>
<textarea data-editor="python" name="subclass" style="width:80%" rows=25>${data.get("subclass",'')|h}</textarea>
</div>


<h2>Tag Points</h2>
<p class="help">This section lists all the tag points owned 
</p>
<table border="1" style="width:40em">
<tr><td>Name</td><td>Value</td><td>Active Claim</td></tr>

%for i in obj.tagPoints:
<tr><td><a href="/tagpoints/${url(obj.tagPoints[i].name)}">${i|h}</a></td>
        %if len(obj.tagPoints)>8:
        <td>${str(obj.tagPoints[i].value)[:48]|h}</td>
        %elif hasattr(obj.tagPoints[i],'meterWidget'):
        <td>${obj.tagPoints[i].meterWidget.render()}</td>
        %else:
        <td>${obj.tagPoints[i].spanWidget.render()}</td>
        %endif

        <td>${obj.tagPoints[i].activeClaim().name|h}</td>
</tr>
%endfor
</table>


<input type="submit" value="Save settings">

</form>

<h2>Messages</h2>
<p class="help">
        These are not logged. Add a message with device.print(message). Old messages
        are deleted. Most recent is first.
</p>
${obj.logWindow.render()}

</div>


<script src="/static/js/src-min-noconflict/ace.js"></script>
<script src="/static/js/jquery3.js"></script>

<script>
    // Hook up ACE editor to all textareas with data-editor attribute
    $(function () {
        $('textarea[data-editor]').each(function () {
            var textarea = $(this);
            var mode = textarea.data('editor');
            var editDiv = $('<div>', {
                position: 'absolute',
                width: textarea.width(),
                height: textarea.height(),
                'class': textarea.attr('class')
            }).insertBefore(textarea);
            textarea.css('display', 'none');
            var editor = ace.edit(editDiv[0]);
            editor.renderer.setShowGutter(false);
            editor.getSession().setValue(textarea.val());
            editor.getSession().setMode("ace/mode/" + mode);
            // editor.setTheme("ace/theme/idle_fingers");
            editor.setOptions({
             fontFamily: "Hack",
            fontSize: "12pt"
            });
            editor.getSession().on('change', function() {
                wasChanged=true;
            })
           // %if not pages.canUserDoThis("/admin/modules.edit"):
            //editor.setReadOnly(true)
            //%endif
            // copy back to textarea on form submit...
            textarea.closest('form').submit(function () {
                textarea.val(editor.getSession().getValue());
            })
        });
    });
</script>
<%include file="/pagefooter.html"/>