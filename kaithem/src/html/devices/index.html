<%include file="/pageheader.html"/>

<%! 
from src import devices
import os
from src import directories
driversLocation = os.path.join(directories.vardir,"devicedrivers")
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')

def devStatString(d):
    #TODO this should be the responsibility of the individual devices
    "Misc status info that we can gather from the device typy"
    s = []

    if 'status' in d.tagPoints:
        s.append(str(d.tagPoints['status']())[:32])


    try:

        if 'rssi' in d.tagPoints:
            s.append(d.tagPoints['rssi'].meterWidget.render(label="RSSI"))

       
    except Exception as e:
        s.append(str(e))

   

    if hasattr(d,'pclient'):
        s.append(" offline" if  deviceData[i]().pclient and deviceData[i]().pclient.remoteAddress==None else "")


    return ", ".join(s)
    
%>
<script src="/static/widget.js"></script>


<title>Kaithem Devices</title>

<h2>Devices</h2>
<div class="sectionbox">
<p class="menubar">
<a class="button" href="/settings/files/${driversLocation|u}">Manage Drivers</a>
</p>
<p class="help">
    This section provides an easy way to configure devices supported
    by Kaithem's remote device abstraction layer.
</p>
<table border="1">
<tr>
    <td>Name</td><td>Type</td>  <td>Edit</td> <td>Status</td> <td>Errors</td><td>Delete</td>
</tr>
%for i in sorted(deviceData.keys()):
<tr>
    <td>
        ${i}
    </td>
    <td>
            ${deviceData[i]().deviceTypeName}
    </td>

    <td>
        <a href="device/${url(i)}/manage">Edit</a>
    </td>

    <td>${devStatString(deviceData[i]())}</td>
    

    <td style="color: ${'red' if len(deviceData[i]().errors) else 'black' };">
        ${len(deviceData[i]().errors)}
    </td>


    <td>
        <a href="deleteDevice/${url(i)}">Delete</a>
    </td>
</tr>
%endfor
</table>

%if devices.getZombies():
<h2>Zombie Devices</h2>
%for i in sorted(devices.getZombies()):
<h3>${i}</h3>
<p>

</p>
%endfor
%endif

<datalist id="deviceTypes">
    %for i in devices.builtinDeviceTypes:
    <option value="${i}" title=${devices.builtinDeviceTypes[i].description} >
    %endfor
    %for i in devices.deviceTypes:
    <option value="${i}" title=${devices.deviceTypes[i].description} >
    %endfor
</datalist>

<h2>Create New Device</h2>
<form action="customCreateDevicePage">
<Label>Name:<input name="name"></Label>
<Label>Type:<input name="type" placeholder="Click for dropdown" list="deviceTypes"></Label>
<input type="submit">
</form>

<h2>Available Device Types</h2>
<dl>
    %for i in devices.builtinDeviceTypes:
    <dt><b>${i|h}</b></dt>
    <dd>${devices.builtinDeviceTypes[i].description|h}</dd>
    %endfor



    %for i in devices.deviceTypes:
    <dt><b>${i|h}</b></dt>
    <dd>${devices.deviceTypes[i].description|h}</dd>
    %endfor
</dl>
</div>



</dd>
<%include file="/pagefooter.html"/>

