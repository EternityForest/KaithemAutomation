<%include file="/pageheader.html"/>

<%! 
from kaithem.src import devices,modules_state
import os, gc
from kaithem.src import directories
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')

def devStatString(d):
    #TODO this should be the responsibility of the individual devices
    "Misc status info that we can gather from the device typy"
    s = []

    if 'status' in d.tagPoints:
        s.append(str(d.tagPoints['status']())[:32])


    try:
        if len(d.tagPoints) < 8:
            for i in d.tagPoints:
                if hasattr(d.tagPoints[i],'meterWidget'):
                    if d.tagPoints[i].type == "number":
                        s.append(d.tagPoints[i].meterWidget.render_oneline(label=i+": "))


        else:
            if 'rssi' in d.tagPoints:
                s.append(d.tagPoints['rssi'].meterWidget.render_oneline(label="RSSI: "))
            if 'battery' in d.tagPoints:
                s.append(d.tagPoints['battery'].meterWidget.render_oneline(label="Battery: "))
            if 'powered' in d.tagPoints:
                s.append(d.tagPoints['powered'].meterWidget.render_oneline(label="Powered: "))

            if 'switch' in d.tagPoints:
                s.append(d.tagPoints['switch'].meterWidget.render_oneline(label="Switch: "))
            if 'running' in d.tagPoints:
                s.append(d.tagPoints['running'].meterWidget.render_oneline(label="Running: "))
            if 'record' in d.tagPoints:
                s.append(d.tagPoints['record'].meterWidget.render_oneline(label="Recording: "))
            if 'temperature' in d.tagPoints:
                s.append(d.tagPoints['temperature'].meterWidget.render_oneline(label="Temperature: "))
            if 'humidity' in d.tagPoints:
                s.append(d.tagPoints['humidity'].meterWidget.render_oneline(label="Humidity: "))
            if 'uv_index' in d.tagPoints:
                s.append(d.tagPoints['uv_index'].meterWidget.render_oneline(label="UV Index: "))
            if 'wind' in d.tagPoints:
                s.append(d.tagPoints['wind'].meterWidget.render_oneline(label="Wind: "))

            if 'open' in d.tagPoints:
                s.append(d.tagPoints['open'].meterWidget.render_oneline(label="Open: "))

            if 'on' in d.tagPoints:
                s.append(d.tagPoints['on'].meterWidget.render_oneline(label="On: "))

            if 'leak' in d.tagPoints:
                s.append(d.tagPoints['leak'].meterWidget.render_oneline(label="Leak: "))

            
    except Exception as e:
        s.append(str(e))

   

    if hasattr(d,'pclient'):
        s.append(" offline" if  deviceData[i]().pclient and deviceData[i]().pclient.remoteAddress==None else "")


    return ''.join(['<div>'+i+"</div>" for i in s])
    
%>
<script src="/static/widget.js"></script>

<script src="/static/showdown.min.js"></script>


<script>
    function req(n){
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST",n, true);
        xhttp.send();
    }
</script>
<title>Devices</title>

<h2>Devices</h2>
<section>

<p class="help">
    This section provides an easy way to configure devices supported
    by Kaithem's remote device abstraction layer.
</p>


<%def name="device(i,title='', devObj = None)">
<%

devObj = devObj or deviceData[i]()

if devObj.deviceTypeName == 'UnusedSubdevice':
    greyout  = "opacity: 70%;"
else:
    greyout = ''

%>

%if hasattr(devObj, 'subdevices') and devObj.subdevices:
<hr style="width: 100%;">
%endif
<div class="sectionbox" style="${greyout} margin: 1em; border-radius: inherit;  flex-shrink: 10; flex-grow: 1; flex-basis:0; min-width: fit-content; width: ${'100%;' if (hasattr(devObj, 'subdevices') and devObj.subdevices) else '0px'}; ">
        
    <div class="buttonbar">
        <h3
            title="${devObj.deviceTypeName}"

            %if hasattr(devObj, 'subdevices') and devObj.subdevices:
            class="highlight specialentry"
            %endif

        >
            <a href="device/${url(i)}/manage">${devObj.title|h}

                %if len(devObj.errors):
                <span style="color: ${'red' if len(devObj.errors) else 'inherit' };">
                    ${(str(len(devObj.errors))+" errors")}
                </span>  
                %endif
            </a>

            %if devObj.deviceTypeName == 'UnusedSubdevice':
            (Not found)
            %endif

            

        </h3>
          

        %if 'switch' in devObj.tagpoints:
            <button onclick="req('toggletarget/${url(i)}')"><i class="icofont-light-bulb"></i>Toggle</button>
        %endif

        %if 'start' in devObj.tagpoints and devObj.tagpoints['start'].subtype=='trigger':
        <button onclick="req('triggertarget/${url(i)}/start')"><i class="icofont-light-bulb"></i>Start</button>
        %endif

        %if 'stop' in devObj.tagpoints and devObj.tagpoints['stop'].subtype=='trigger':
        <button onclick="req('triggertarget/${url(i)}/stop')"><i class="icofont-light-bulb"></i>Stop</button>
        %endif

        %if not hasattr(deviceData[i](),'_kaithem_is_subdevice'):
        <a href="deleteDevice/${url(i)}" class="button" style="flex-grow:0"><i class="icofont-ui-delete"></i></a>
        %endif


    </div>
        %if 'color' in devObj.tagpoints and devObj.tagpoints['color'].subtype=='color':

        <div class="buttonbar">
            <button  type="button"   style="background-color: #fafafa;" onclick="req('settarget/${url(i)}/color?value=%23fafafa')">Argent</button>
            <button  type="button"   style="background-color: #ffe066;" onclick="req('settarget/${url(i)}/color?value=%23ffe066')">Or</button>
            <button  type="button"   style="background-color: #f0dc82;" onclick="req('settarget/${url(i)}/color?value=%23f0dc82')">Buff</button>
            <button  type="button"   style="background-color: #7c1c05;  color: lightblue;"" onclick="req('settarget/${url(i)}/color?value=%237c1c05')">Copper</button>
        </div>
        <div class="buttonbar">
                <button  type="button"  style="background-color: #d7374a;"  onclick="req('settarget/${url(i)}/color?value=%23d7374a')">Gules</button>
                <button  type="button"  style="background-color: #333333; color: lightblue;"  onclick="req('settarget/${url(i)}/color?value=%23333333')">Sable</button>
                <button  type="button"  style="background-color: #377cd7;"  onclick="req('settarget/${url(i)}/color?value=%23377cd7')">Azure</button>
                <button  type="button"   style="background-color: #26c061;" onclick="req('settarget/${url(i)}/color?value=%2326c061')">Vert</button>
                <button  type="button"   style="background-color: #854296;  color: lightblue;" onclick="req('settarget/${url(i)}/color?value=%23854296')">Purpure</button>               
        </div>

        <div class="buttonbar">
            <button  type="button" onclick="req('dimtarget/${url(i)}/color?value=0.1')">10%</button>
            <button  type="button" onclick="req('dimtarget/${url(i)}/color?value=0.2')">20%</button>
            <button  type="button" onclick="req('dimtarget/${url(i)}/color?value=0.5')">50%</button>
            <button  type="button" onclick="req('dimtarget/${url(i)}/color?value=1.0')">100%</button>

        </div>


        %endif
    <%
    h=devStatString(devObj)
    %>
    %if h:
    <div style="display: flex; flex-wrap: wrap; flex-direction: column;">${h}</div>
    %endif

    %if devObj.config.get('description',''):
    <p>
        ${devObj.config.get('description')|h}
    </p>
    %endif
    
    </div>

%if hasattr(devObj, 'subdevices') and devObj.subdevices:
%for j in devObj.subdevices:
${device(devObj.subdevices[j].name, devObj=devObj.subdevices[j])}
%endfor
<hr style="width: 100%;">
%endif



</%def>


<div style="display: flex; flex-wrap: wrap; flex-direction: row;">
%for i in sorted(deviceData.keys()):
%if not hasattr(deviceData[i](),'_kaithem_is_subdevice'):
${device(i)}
%endif

%endfor
</div>


<%
d =  devices.getZombies()
%>



%if d:
<h2>Zombie Devices</h2>
%for i in sorted(d):
<h3>${i[0]|h}</h3>
<pre>
    ${gc.get_referrers(i[1])|h}
    ${gc.get_referrers(gc.get_referrers(i[1])[0])}
</pre>
<p>

</p>
%endfor
%endif

<%
del d
%>


<datalist id="deviceTypes">
    %for i in devices.builtinDeviceTypes:
    <option value="${i}" title=${devices.builtinDeviceTypes[i].description} >
    %endfor
    %for i in devices.deviceTypes:
    <option value="${i}" title=${devices.deviceTypes[i].description} >
    %endfor

    %for i in devices.importedDeviceTypes:
    <option value="${i}" title=${i} >
    %endfor
</datalist>

<h2>Create New Device</h2>

<form method="post" action="customCreateDevicePage">
<div class="buttonbar">
<label>Name:<input name="name" size="6" aria-label="new device name"></label>
<label>Type:<input name="type" size="8" placeholder="Click for dropdown" list="deviceTypes" aria-label="new device type"></label>
<input type="submit">
</form>
</div>
<h2>Available Device Types</h2>
<div class="scrollbox">
<dl>
    %for i in devices.builtinDeviceTypes:
    <dt><b>${i|h}</b></dt>
    <dd>${devices.builtinDeviceTypes[i].description|h}</dd>

    %endfor



    %for i in devices.deviceTypes:
    <dt><b>${i|h}</b></dt>
    <dd>${devices.deviceTypes[i].description|h}</dd>
    %endfor


    %for i in  devices.importedDeviceTypes:
    <dt><b>${i|h} from ${devices.importedDeviceTypes[i].get('importable','unknown module')|h}</b></dt>
    <dd id="id_${i.replace('"','')}"> ${devices.importedDeviceTypes[i].get("description","No description set") or "No description"|h}</dd>
    <script>
        showdown.setFlavor('github');
        var c= document.getElementById("id_${i.replace('"','')}").innerHTML;
        var converter = new showdown.Converter();
        document.getElementById("id_${i.replace('"','')}").innerHTML=converter.makeHtml(c);
    </script>
    %endfor
</dl>
</div>
</section>
<%include file="/pagefooter.html"/>

