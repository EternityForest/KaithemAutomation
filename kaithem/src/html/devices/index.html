<%include file="/pageheader.html"/>

<%! 
from src import devices,modules_state
import os
from src import directories
import urllib.parse

def url(u):
    return urllib.parse.quote(u,safe='')

def devStatString(d):
    #TODO this should be the responsibility of the individual devices
    "Misc status info that we can gather from the device typy"
    s = []

    if 'status' in d.tagPoints:
        s.append(str(d.tagPoints['status']())[:32])


    try:

        if 'rssi' in d.tagPoints:
            s.append(d.tagPoints['rssi'].meterWidget.render(label="RSSI"))
        if 'switch' in d.tagPoints:
            s.append(d.tagPoints['switch'].meterWidget.render(label="Switch"))
        if 'running' in d.tagPoints:
            s.append(d.tagPoints['running'].meterWidget.render(label="Running"))
        if 'record' in d.tagPoints:
            s.append(d.tagPoints['record'].meterWidget.render(label="Recording"))



            
    except Exception as e:
        s.append(str(e))

   

    if hasattr(d,'pclient'):
        s.append(" offline" if  deviceData[i]().pclient and deviceData[i]().pclient.remoteAddress==None else "")


    return ''.join(['<div>'+i+"</div>" for i in s])
    
%>
<script src="/static/widget.js"></script>

<script src="/static/showdown.min.js"></script>

<title>Kaithem Devices</title>

<h2>Devices</h2>
<div class="sectionbox">

<p class="help">
    This section provides an easy way to configure devices supported
    by Kaithem's remote device abstraction layer.
</p>


<%def name="device(i,title='')">
    <dt> 
        <div class="buttonbar">
            <a href="device/${url(i)}/manage"><i class="icofont-pencil"></i>${title or i|h}

            %if len(deviceData[i]().errors):
            <span style="color: ${'red' if len(deviceData[i]().errors) else 'inherit' };">
                ${(str(len(deviceData[i]().errors))+" errors")}
            </span>
</a>
            %endif
            <a href="deleteDevice/${url(i)}" class="button" style="flex-grow: 0.1;"><i class="icofont-ui-delete"></i>Delete</a>

        </div>
    </dt>
    <dd>

    <h4>Type</h4>
            ${deviceData[i]().deviceTypeName}
            %if  deviceData[i]().deviceTypeName =='unsupported':
            (${deviceData[i]().data.get('type','UndefinedType')})
            %endif
    <h4>Action</h4>

    <%
    h=devStatString(deviceData[i]())
    %>
    %if h:
    <h4>Status</h4>
    <div style="display: flex;">${h}</div>
    %endif

    %if hasattr(deviceData[i](), 'subdevices') and deviceData[i]().subdevices:
    <div>
        <dl>
            %for j in deviceData[i]().subdevices:
            ${device(deviceData[i]().subdevices[j].name,title=j)}
            %endfor
        </dl>
    </div>
    %endif

</dd>
</%def>

<dl>

%for i in sorted(deviceData.keys()):
%if not hasattr(deviceData[i](),'_kaithem_is_subdevice'):
${device(i)}
%endif

%endfor
</dl>







%if devices.getZombies():
<h2>Zombie Devices</h2>
%for i in sorted(devices.getZombies()):
<h3>${i}</h3>
<p>

</p>
%endfor
%endif

<datalist id="deviceTypes">
    %for i in devices.builtinDeviceTypes:
    <option value="${i}" title=${devices.builtinDeviceTypes[i].description} >
    %endfor
    %for i in devices.deviceTypes:
    <option value="${i}" title=${devices.deviceTypes[i].description} >
    %endfor

    %for i in devices.importedDeviceTypes:
    <option value="${i}" title=${i} >
    %endfor
</datalist>

<h2>Create New Device</h2>

<form method="post" action="customCreateDevicePage">
<div class="buttonbar">
<label>Name:<input name="name" size="6" aria-label="new device name"></label>
<label>Type:<input name="type" size="8" placeholder="Click for dropdown" list="deviceTypes" aria-label="new device type"></label>
<input type="submit">
</form>
</div>
<h2>Available Device Types</h2>
<div class="scrollbox">
<dl>
    %for i in devices.builtinDeviceTypes:
    <dt><b>${i|h}</b></dt>
    <dd>${devices.builtinDeviceTypes[i].description|h}</dd>

    %endfor



    %for i in devices.deviceTypes:
    <dt><b>${i|h}</b></dt>
    <dd>${devices.deviceTypes[i].description|h}</dd>
    %endfor


    %for i in  devices.importedDeviceTypes:
    <dt><b>${i|h} from ${devices.importedDeviceTypes[i].get('importable','unknown module')|h}</b></dt>
    <dd id="id_${i.replace('"','')}"> ${devices.importedDeviceTypes[i].get("description","No description set") or "No description"|h}</dd>
    <script>
        showdown.setFlavor('github');
        var c= document.getElementById("id_${i.replace('"','')}").innerHTML;
        var converter = new showdown.Converter();
        document.getElementById("id_${i.replace('"','')}").innerHTML=converter.makeHtml(c);
    </script>
    %endfor
</dl>
</div>
</div>



</dd>
<%include file="/pagefooter.html"/>

