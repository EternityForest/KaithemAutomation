<style type="text/css">
h2 {
	background-color: rgba(200, 255, 220, 0.4);
}

h3 {
	margin-top: 1em !important;
	margin-bottom: 1em !important;
	background-color: rgba(255, 255, 255, 0.3);
}

h4 {
	margin-top: 0.5em !important;
	margin-bottom: 0.5em !important;
	background-color: rgba(220, 220, 220, 0.25);
}
</style>
<%include file="/pageheader.html"/>
<title>Kaithem Help</title>
<h1>FAQ</h1>

<div class="sectionbox">


<h3>Where does Kaithem store data?</h3>
<p>By default, kaithem stores all variable data in kaithem/var(inside it's directory) It does not use the
    windows registry, APPDATA, a database, or any other central means of storage. However, keeping your data in
    kaithems "unzip and run" folder has a few problems. First and most important, it makes it hard to update,
    since if you download a new version it will not have your data.</p>
<p>To avoid this, we recommend that you copy kaithem/var someplace else, and use the site-data-dir config
    option to point to the new location. If you copy var to /home/juan/ then site-data-dir should equal
    /home/juan/var</p>

<h3>How do I let users upload to a a page</h3>
<p>Use kwargs['myfileinputname'].file.read()</p>

<h3>How do I use custom configuration files?</h3>
<p>Create your file, then, when you start Kaithem, use the -c command line argument to point to it. Example:

<pre>python3 kaithem.py -c myconfigfile</pre> Kaithem uses the YAML format for configuration files, which is a
very simple and easy to read format. YAML example: <pre>
#this is a comment
option-name: this is the option value

another-option: 42

a-long-string-as-an-option: |
That pipe symbol after the colon lets us start
a big multiline string on the next line


an-option-with-a-list-as-a-value:
-uno
-dos
-tres</pre>


</p>
<p>
    NOTE: Kaithem will <b>only</b> load the configuration file on startup and you must reload kaithem for the
    changes to take effect.
</p>
<h3>My message bus data is not being saved to the log files! Help!</h3>
<p>Kaithem only saves topics to the hard drive if they are in the list of things to save. Go to the logging
    page and select the channels you are interested in. This</p>

<h3>What is with these security certificate errors?</h3>
<p>
    Kaithem comes with a default security certificate in the kaithem/var/ssl directory. Becuase it is publicly
    known, it provides <b>ABSOLUTELY NO SECURITY</b>. The intent is to let you test out Kaithem easily, but if
    you want to actually deploy an instance, you <b>MUST</b> replace the security key with a real one and keep it
    secret. There are plenty of TLS/SSL Certificate tutorials,
    and equally important is that you ensure that the permissions on the private key file are truly set to private.
</p>

<h3>How do I make an event that triggers at a certain time?</h3>
<p>To make an event that goes off at Noon, simply create a normal event and set the trigger to
    "kaithem.time.hour() == 12"</p>


<h3>
    <a id="static" name="static"></a>How do I tell Kaithem to serve a static file?
</h3>
<p>Add something like this to your configuration file
<pre>
serve-static:
images: /home/piper/My Pictures
images2: /home/piper/My Other Pictures
</pre> Now the url /usr/static/images/page.jpg will point to the file /home/piper/My Pictures/page.jpg<br> All
user-created static directories are mounted under /usr/static. Be VERY careful what you choose to serve
statically, because anyone will be able to access them. If you need a secure way to serve a file, you are better
off creating a page with the appropriate permissions, and using <a href="#servefile">kaithem.web.serveFile()</a>
</p>

<h3>I am getting "permission denied" errors on the web interface</h3>
<p>You don't have permission to access that page. If you are admin, go to the authorization page and give
    yourself that permission.</p>

<h3>I am not using flash memory, and would like to set up autosave</h3>
<p>By default, Kaithem tries to avoid automatic disk writes. This is to avoid wearing out low-cost flash
    storage on devices such as the RasPi. However, if you would like to configure the server to save the state
    on an interval, you can set the
<pre>autosave-state</pre> option in the configuration to an interval specified like "1 hour" or "1 day" or 1 day 3 minutes.
</p>

<p>Valid units are second,minute,hour,day,week,month,year. Autosaving will not happen more than onceper minute no
    matter the setting and if data is unchanged disk will be untouched. A "month" when used as a length of time, is a year/12.</p>

<p><b>autosave-state does not touch log files. Use autosave-log for that. It's semantics are the same.</b></p>

<p>In addition to periodic saves, you might want to consider setting
<pre>save-before-shutdown</pre> to <pre>yes</pre>This will tell the server to save everything including log
dumps before shutting down.
</p>

<h3>I would like to back up the code that I wrote in Kaithem</h3>
<p>At the moment, the easiest way to do this is just to make a copy of the folder where your variable data
    is kept.</p>
<p>The modules directory within that dir uses a format designed to work well with git.</p>

<h3>How exactly does logging work?</h3>
<p>Logging is now disabled by default. To enable it, set log-format to 'normal' in the configuration. We
now use python's standard logging module. You can view all output of the root logger from the logging page,
but only log output from the logger named "system" at INFO and above will be logged to file, to avoid issues with libraries that spam
large amounts to the log files.</p>

<p>A disadvantage of python's logging module is that you cannot really delete a logger in an officially supported way.
As loggers are reasonably lightweight this should not be an issue, but don't create huge amounts of loggers.
</p>

<p>Until a better solution is implemented, Using one or two loggers per module will likely not cause any problems.</p>

<p>In general, traffic to kaithem's system log should remain low. HTTP acesses, normal things that happen more than
once a minute, etc should not be logged there. Even when errors are occuring, only the first few in a minute should be logged.</p>

<p>Try not to create too much traffic on the root logger either in normal use. Posting a debug message
to root for every error is fine, because normally there should not be dozens of errors a second. But
don't just spam it all the time, the root logger's debug output should be readable and reasonably 
understandable in real time.</p>

<pre>keep-log-files</pre> configuration option deterimines how much space log files will consume before the
oldest are deleted. The default is <pre>256m</pre> or 256 Megabytes. You can use the suffixes k,m,and g, and if
you don't supply a suffix, the number will be interpreted as bytes(!)
</p>

<p>Log files are kept in ram until manually dumped, automatically dumped by the autosave-logs timer, or the total number of log entries exceeds the log-buffer value in the config,
at which point they are dumped to logging/dumps in the kaithem vardir. It is 25000 by default. Set it to 1
to write all logs immediately to the file, but only if you are using a hard disk or high endurance SSD.</p>

<p> log-dump-size determines how many entries to log to each file before starting a new one. It is also 25000 
by default.</p>
</p>

Logs can also be compressed with the option
<pre>log-compress</pre> This option can take any of:
<ul>
    <li>none</li>
    <li>gzip</li>
    <li>bz2</li>
</ul> Compressed files will have the extension <pre>.json.gz or .json.bz2</pre>
</p>


<p>The old JSON direct logging of message bus topics is no longer supported. </p>


<h3>Can I customize Kaithem's appearance for my specific deployment?</h3>
<p>Certainly! Kaithem was designed with theming and customization in mind from the start. You will probably
    want to do some or all of the following.
<h4>Change the Top Banner</h4>
<p>Changing the top banner is pretty simple. All you need to do is add a line in your configuration file
    like:
<pre>
top-banner-html: |
&ltdiv id="topbanner"&gt&lth1 align="center"&gtYOUR TEXT HERE&lt/h1&gt&lt/div&gt
</pre> Of course, you can add whatever HTML you like, this is just an example. You can even add images(see "<a href="#static">How
    do I tell Kaithem to serve a static file?</a>")
</p>

<h4>Changing the front page text</h4>
<p>This is equally easy. The top box on the front page is fully customizable. the front-page-banner
    attribute in your config file can contain any HTML. The default is:
<pre>
front-page-banner: |
&ltb&gtKaithem is free software licensed under the GPLv3.&ltbr&gt
Kaithem was not designed for mission critical or safety of life systems and no warranty is expressed
or implied.&ltbr&gt Use entirely at your own risk.&lt/b&gt
</pre>
</p>

<h4>Change the actual CSS theme</h4>
<p>This is a bit harder. The default CSS file is called scrapbook.css, found in /kaithem/data/static. What
    you will need to do is to create a new theme file, serve it as a static file, and then use the "theme-url"
    option in your config file to point to the new theme. You will likely just want to modify the existing
    scrapbook.css because it is a 100+ line file and there are some things that don't quite look right with the
    browser defaults.</p>

<h4>Rewrite the HTML</h4>
<p>The HTML is pretty simple, and most pages include the header src/html/pageheader.html.
The only trouble with modifying things is updatability, and the easiest way to fix that is probably using a version control tool like Git.
Modifying the HTML might be the best option for more extensive customizations.</p>

<h3>What can I do to make Kaithem more reliable?</h3>
<p>Watch out for things that have to be turned on,left on for a while, and then turned off. Don't depend on
    high frame rates. Keep in mind that the server may need to restart at some time for updates. Everything
    should start with sane defaults immediately on loading. Keep in mind that the order in which events and
    modules load is not currently defined(this should be adressed soon), however an event will never run before
    it's setup section, and almost all dependancy issues should be handled by the automatic retry.</p>

 <p>An error in a setup section will cause that event to be skipped,
 the rest of the events to be loaded, then the failed ones will be retried up to the max attempts(default 25)
 </p>

 <p>On a related note, watch out for dependancies between events and modules.
 The order in which modules or events load is currently not defined.
 Dependancies are handled automatically in most cases.</p>

 <p>Also, keep in mind what happens when Kaithem shuts down or restarts:
 any events currently executing finish up, but no new events are run.
 (except events triggered by the /system/shutdown message)</p>

 <p>Put an emphasis on automatic management, detection, and recovery, and keep in mind external services may undergo downtime.
 Example: If you need a serial port, don't just set it up when kaithem loads. Create a manager event that periodically checks to make
 sure all is well and if not tries to reopen the port. Remember you may want to run Kaithem for months without a reboot,
 and conversely you may want to handle rebooting without manual intervention.</p>

 <p>Blocks of code that must be atomic should not depend on things that might be deleted or changed before the event is finished, such a
	!function event or anything using a "weakref and proxy" based interface.</p>

<p>If you really do have something that must be atomic, such as a firmware update via a serial port to some device,
   the best way to handle it is by containing the critical part in a single event that does not depend on !function events or plugins.</p>

<p>The kaithem.globals namespace contents are not subject to any kind of automatic cleanup,
   and the module object is a real object and not a weak reference.
   !function events may still go away and raise an error, however,
   so declare anything you need to use in a block that must be atomic as a plain old function and assign it to something that won't go away.</p>


 <h3>Can I run multiple instances of Kaithem?</h3>
 <p>Quite possibly. It has not been tested though.
 If you do, they should probably have different directories for variable data.</p>

 <h3>What happens if two people edit something at the same time?</h3>
 <p>Kaithem was not designed as a large-scale collaboration system.
 At the moment,If two people edit something at the same time, the last person to click save "wins",
  not unlike having two open text editors open to the same file. There should, however,
 be no issue with two users editing different resources at once. At present there are no plans to change this behavior.
 </p>

 <h3>How do unencrypted pages work?</h3>
 <p>
 Kaithem will allow unencrypted acess to any page that does not require any permissions.
 Kaithem will also allow unencrypted acess to any page that the special user "__guest__" could access, if such a user exists.
 All other pages may only be acessed over HTTPS.
 use the 'http-port' and 'http-thread-pool' options to change the number of threads assigned and the port used
 for unsecure access.
 </p>

 <h3>How can I change the port in which kaithem serves?</h3>
 <p>
 Kaithem normally serves on two different ports, one for HTTP(plaintext) and one for HTTPS(Secure) connections.
 use the http-port and https-port configuration options to set each respectively. Use an integer value.</p>
 </p>

 <h3>How should I deploy Kaithem in a real application?</h3>

 <p>First, keep in mind that while Kaithem is fairly reliable, it was not designed for
 anything like medical equipment or nuclear plants. With that in mind, deploying Kaithem is pretty easy.
You will most likely want an always-on server, probably running linux(The Raspberry Pi is a great server),
and you will probably want to set up a static IP.
 </p>

 <p>Since, at the moment, Kaithem lacks an installer,
 the recommended installation procedure is to install git, create a new linux user just for the server,
 and clone into the new user's home directory. Give the user any permisions needed to acess your automation hardware.
 </p>

 <p>Be sure to use real SSL keys, and to change the default passwords.</p>

 <p>You will almost certainly want to automatically start on boot, and the easiest way to do this is to
 make an entry in the Kaithem user's crontab.</p>

 <p>To update Kaithem, simply go into the Kaithem install folder in the user's home dir, and do a git pull.</p>

 <p>Be careful updating, 100% backwards compatibility is not guaranteed at this stage of the project,
  and some config options might gte deprecated and your settings may be ignored.
 That said, backwards compatibility is an important goal, and release notes should include and known issues.</p>

 <p>You should make a copy of kaithem/var,  put it somewhere else, and change the
 <pre>site-data-dir</pre>

 In your config file to point to it. Also change ssl-dir to point to whereever you put the certificate.cert and certificate.key files of your private key.
 If you don't do this, it will write your data(modules,pages,events,settings) directly into the cloned repo, which may cause an error when you try to update via git.
 </p>

  <p>If you are doing web kiosks or datalogging or anything else wherer you need to reliably track changing data, the
        "keep everything in ram and periodically save" model may not work. You might want to consider using a spinnin drive or good SSD and SQLite. for rapidly changing data.</p>
 <h3>Audio is not working on the RasPi</h3>

 <p>At least on the version of Raspbian used for testing, SoX will not work unless you set the following environment variables
<pre>
AUDIODEV=hw:0
AUDIODRIVER=alsa
</pre>
 </p>
 <p>
 Also,the user that kaithem is running under must be in the audio group, use
 <pre>sudo usermod -a -G audio USERS_NAME</pre>
 to fix that. The default user had this enables already but if you made a new user you may need to use the command.
 <p>


<h3>How does the polling mechanism manage CPU time and prevent "hogging"?</h3>

<p>The short answer is that Kaithem attempts to distribute CPU time fairly, and make sure all
events continue to run even when some are vastly slower than others. In general, the
programmer should be able to imagine that each event has its on thread even though the thread pool model is used.
 The long answer in more technical.</p>

<p>The current poll management system is based on the kaithem thread pool. The thread pool
is a set of threads fed by a threadsafe queue. Function objects are placed in the queue and
threads take them out and execute them.
</p>

<p> In kaithem, a polling cycle is called a frame. Every frame,
kaithem puts the poll function of every event that needs to be polled into the queue. Should a thread get a
poll function and find out that another thread is already polling it, that event is simply skipped to prevent a slow event clogging
the pool by causing many threads to wait on the last thread to be done ith it so they can poll it.</p>

<p>After the manager thread has inserted all the poll functions into the queue, it inserts a special sentinel.
The manager thread will not start the next frame until this sentinel has run. The sentinel running lets us know that
everything we put in the queue has been taken out. If a slow event is still running at this point, it will continue to run,
and another copy of it should never be queued up in any way until the current one finished.</p>

<p>The one known case in which slow tasks can bog down the system is if there are more slow tasks than there are threads in the pool.
In this case the system may be unresponsive for a time until the tasks finish. This is unlikely as the odds of having dozens of tasks at the same time
that are very slow is low in most systems.

</p>

<a id="dependancies" name="dependancies"></a><h3>How does Kaithem handle dependancies between resources?</h3>
<p>With pages, it's not much of an issue.
Pages are compiled the first time they get accessed, and if that fails due to a dependancy,
the compiling will be retried next time someone tries to access it.
It is hard to imagine pages depending on each other in any major way anyway, because pages are usually not the place to write libraries.
</p>

<p>Events are another story. Since kaithem implements "running some code at startup", including user created
functions, as an event, events may have any amount of dependancy on each other.</p>

<p>The way that kaithem handles this, is that when an exception occurs in an event's setup code(while loading the event),
kaithem simply stops, moves on with the rest of the list of events that need loading, and then comes back to the event that failed, up to
a number of times set in the config.</p>

<p>This means that you should almost never need to deal with dependancy resolution issues yourself,
they are handled as a consequence of kaithem's auto-retry mechanism. However, to imporove load time, you may want
to make dependancies more explicit by adding something like this:
<pre>
depends = kaithem.globals.ThingThisEventExpectsToBePresent
depends = FunctionCallThatWillFailIfDependacyNotMet()
</pre>

to the beginning of the setup function. These lines will raise errors if there are unmet dependancies.
causeing kaithem to exit immediatly, instead of after having wasted more time. It's also valuable documentation.

But in general, don't worry about dependancies. Just keep in mind that your setup functions might get retried.

</p>

<h3>Help! My setup code executes twice!</h3>
<p>Internally, the setup code is run once during the 'test compile', then once when actually creating the event.
The object created in the test compile is deteted, so all deleters are honored.
Your setup setions should be retry tolerant anyway, but this issue may be fixed later</p>

<h3>I need better data reliability than simple autosave</h3>
<p>Then you should probably use sqlite, which is built into python, or another transactional database.</p>
</div>

<%include file="/pagefooter.html"/>
