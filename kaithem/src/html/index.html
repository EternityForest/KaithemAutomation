<%!
from src import notifications,auth,unitsofmeasure,pages,alerts
import time
import cherrypy
from src.config import config
from src.unitsofmeasure import formatTimeInterval


pcolor={
    "critical": "pink",
    "error": 'red',
    "warning": 'orange',
    "info": 'lightgreen'
}
iclass={
    "critical": "critical-icon",
    "error": 'error-icon',
    "warning": 'warning-icon',
    "info": 'info-icon'
}
scolor={
    'active':'yellow',
    'acknowledged':'orange',
    "cleared":'blue'
}
%>
    <%include file="/pageheader.html"/>
<title>Kaithem Automation</title>

<div class="sectionbox">
<p>${config['front-page-banner']}</p>
</div>
<script src="/static/js/vue2.js"></script>
<script src="/static/widget.js"></script>
<script src="/static/js/strftime-min.js"></script>

${api.render("api")}
${alertsapi.render("alertapi")}

<style>
    span.grey{
        opacity: 70%;
    }
</style>
<main>

    <h2>Active/Unacknowledged Alarms</h2>

    <div class="scrollbox sectionbox" style="max-height: 25em;height:auto;width:fit-content;">
        <p class="help">Anyone who can see the main page can see all alarms, regardless of alarm-specific permssions, as alarms are not meant for private data.</p>

        <%
        if "ackalarm" in cherrypy.request.params:
            alerts.all[cherrypy.request.params['ackalarm']].API_ack()
        toshow = {}
        l = []
  
        for i in alerts.unacknowledged.values():
            i = i()
            if not i:
                continue
            toshow[i.id]=0
            l.append(i)
        try:
            del i
        except:
            pass

        for i in alerts.active.values():
            i = i()
            if not i:
                continue
            if not i.id in toshow:
                if not i.priority==debug:
                    toshow[i.id]=0
                    l.append(i)
        try:
            del i
        except:
            pass

        l = sorted(l, key=lambda i: (0 if (i.priority in ('error', 'critical')) else 1, i.sm.state=="acknowledged", i.priority, i.zone, i.name))
        %>

        %for i in l:
        <div style="padding: 4px; ;margin:8px; border-radius: 12px; border: 1px solid; ;block-size:fit-content;word-wrap: break-word;">
            <div>
                <b><span style="font-size:120%;">${i.name}</span></b> is: <span style="font-size:120%">${i.sm.state}</span><br>

                <span class="grey">
            Priority: ${i.priority}, Zone: ${i.zone},</span> <br><span class="grey">
            Tripped at:${unitsofmeasure.strftime(i.trippedAt)}(about <b>${formatTimeInterval(time.time()-i.trippedAt,2)}
                ago</b>)<br>
            Trip Message:<b>${i.tripMessage}</b></span>
            </div>


            <div style="flex-grow:99"></div>

            <div style="align-self: flex-end;">${i.notificationHTML()}</div>

            %if not i.sm.state=="acknowledged":
            <div style="align-self: center;">
                <form action="?ackalarm=${i.id}" method="post"><button style="align-self: center;" href=".">ACK</button></form>
            </div>
            %else:
            <div style="align-self: center;">
                <button disabled>ACK</button>
            </div>
            %endif

        </div>
        %endfor

        <%
            try:
                del i
                del l
            except:
                pass
        %>
            </div>

            <h2> System Notifications</h2>
            <div id="app">
                <div class="scrollbox sectionbox" style="max-height: 25em; block-size: fit-content;" id="notifications">
                    <div v-for="i in notifications.slice().reverse()" v-bind:class="getClass(i)" style="border-radius: 12px; padding: 4px; margin: 8px;">
                        <b>{{formatTime(i[0])}}</b>
                        <p>{{i[2]}}</p>
                    </div>
                </div>
            </div>
            </main>



            <script>
                var app = new Vue({
                    el: '#app',
                    data: {
                        notifications: [],
                        getClass: function(i) {
                            if (i[1].includes("errors")) {
                                return 'error'
                            }
                            if (i[1].includes("important")) {
                                return 'highlight'
                            }
                            if (i[1].includes("warnings")) {
                                return 'warning'
                            }
                        },

                        formatTime: function(t) {
                            var date = new Date(t * 1000);
                            return date.strftime("%b %m %Y  %I:%M:%S%p %Z")
                        }
                    }
                });

                api.upd = function(msg) {
                    if (msg[0] == "all") {
                        app.$data.notifications = msg[1]
                    }
                    if (msg[0] == 'notification') {
                        app.$data.notifications.push(msg[1])
                        app.$data.notifications = app.$data.notifications.slice(-100)
                        setTimeout(() => {
                            document.getElementById("notifications").scroll(0, 10000)
                        }, 250);
                    }
                }

                alertapi.upd = function(msg) {

                }
                setTimeout(() => {
                    document.getElementById("notifications").scroll(0, 10000)
                }, 1000);
            </script>
            <%include file="/pagefooter.html"/>