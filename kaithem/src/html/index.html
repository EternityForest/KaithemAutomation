<%!
from src import notifications,auth,unitsofmeasure,pages,alerts
import time
import cherrypy
from src.config import config
from src.unitsofmeasure import formatTimeInterval
%>
<%include file="/pageheader.html"/>
<title>Kaithem Automation</title>

<div class="sectionbox">
<p>${config['front-page-banner']}</p>
</div>
<script src="/static/js/kaithem/src/js/vue-2.5.16.min.js"></script>


%if 'auth' in cherrypy.request.cookie:
%if cherrypy.request.cookie['auth'].value in auth.Tokens:
    <div class="sectionbox">
        <p>Logged into Kaithem Automation as user: <b>${auth.whoHasToken(cherrypy.request.cookie['auth'].value)|h}</b></p>
    </div>
%endif
%endif

    <h2>Active/Unacknowledged Alarms</h2>
    <div class="scrollbox sectionbox">
        <%
        if "ackalarm" in cherrypy.request.params:
            alerts.all[cherrypy.request.params['ackalarm']].API_ack()
        toshow = {}
        l = []
  
        for i in alerts.unacknowledged.values():
            i = i()
            if not i:
                continue
            if pages.canUserDoThis(i.permissions):
                toshow[i.id]=0
                l.append(i)

        for i in alerts.active.values():
            i = i()
            if not i:
                continue
            if pages.canUserDoThis(i.permissions):
                if not i.id in toshow:
                    toshow[i.id]=0
                    l.append(i)

        l = sorted(l, key=lambda i: (i.sm.state=="acknowledged", i.priority, i.zone, i.name))
        %>
    
        %for i in l:
        <div style="background-color:rgba(255,240,220,0.2);border-style:solid;"><b>${i.name}</b> Priority: ${i.priority}, Zone: ${i.zone} 
            
        %if not i.sm.state=="acknowledged":    
        <a class="button" href=".?ackalarm=${i.id}">ACK</a>
        %endif
        </div>
        %endfor

        <%
            try:
                del i
                del l
            except:
                pass
        %>
    </div>


    <h2> System Notifications</h2>
    <div class="scrollbox sectionbox"  style="max-height: 25em">
        %for i in reversed(notifications.notificationslog):
            %if 'important' in i[1]:
            <div class="highlight">
            %elif 'errors' in i[1]:
            <div class="error">
            %elif 'warnings' in i[1]:
            <div class="warning">
            %else:
            <div>
            %endif
            <b>${unitsofmeasure.strftime(i[0])}(about ${formatTimeInterval(time.time()-i[0],2)} ago)</b>
            <p>${i[2]|h}</p>
            </div>
            %if len(notifications.notificationslog)>1:
                <hr>
            %endif
        %endfor
    </div>

<%include file="/pagefooter.html"/>
