<%!
from kaithem.src import notifications,auth,unitsofmeasure,pages,alerts
import time
import cherrypy
from kaithem.src.config import config
from kaithem.src.unitsofmeasure import formatTimeInterval


pcolor={
    "critical": "pink",
    "error": 'red',
    "warning": 'orange',
    "info": 'lightgreen'
}
iclass={
    "critical": "critical-icon",
    "error": 'error-icon',
    "warning": 'warning-icon',
    "info": 'info-icon'
}
scolor={
    'active':'yellow',
    'acknowledged':'orange',
    "cleared":'blue'
}


%>
    <%include file="/pageheader.html"/>
<meta http-equiv="refresh" content="240" />

<title>Kaithem Automation</title>

<div style="display: flex; flex-wrap: wrap; justify-content: center;">

    <div style="flex-basis: 20%; text-align: center;"><div class="decorative-image-main decorative-image" style="height: 16em; width:16em; max-width: 45vw; margin: auto;"></div></div>

    <section style="flex-basis: 60%; max-width: 32em;  min-width: 22em;">
    <p>${config['front-page-banner']}</p>
    </section>

    <div style="flex-basis: 20%; min-width: 12em;"></div>
</div>


<script src="/static/js/vue2.js"></script>
<script src="/static/widget.js"></script>
<script src="/static/js/strftime-min.js"></script>

${api.render("api")}
${alertsapi.render("alertapi")}

<style>



.notificationstg-move, /* apply transition to moving elements */
.notificationstg-enter-active,
.notificationstg-leave-active {
  transition: all 0.6s ease;
}

.notificationstg-enter-from,
.notificationstg-leave-to {
  opacity: 0%;
  transform: translateX(30px) !important;
}

/* ensure leaving items are taken out of layout flow so that moving
   animations can be calculated correctly. */
.notificationstg-leave-active {
  position: absolute;
}

</style>
<main>
    <h2>Active/Unacknowledged Alerts</h2>

    <div class="max-h-12rem scroll border window" style="max-height: 25em;height:auto;width:fit-content;">
        <details class="help"><summary><i class="icofont-question-circle"></i></summary>Anyone who can see the main page can see all alarms, regardless of alarm-specific permssions, as alarms are not meant for private data.</details>

        <%
        if "ackalarm" in cherrypy.request.params:
            alerts.all[cherrypy.request.params['ackalarm']].API_ack()
        toshow = {}
        l = []
  
        for i in alerts.unacknowledged.values():
            i = i()
            if not i:
                continue
            toshow[i.id]=0
            l.append(i)
        try:
            del i
        except:
            pass

        for i in alerts.active.values():
            i = i()
            if not i:
                continue
            if not i.id in toshow:
                if not i.priority==debug:
                    toshow[i.id]=0
                    l.append(i)
        try:
            del i
        except:
            pass

        l = sorted(l, key=lambda i: (0 if (i.priority in ('error', 'critical')) else 1, i.sm.state=="acknowledged", i.priority, i.zone, i.name))

        def getClass(i):
            if i.sm.state in ("acknowledged", "active"):
                if i.priority  in ('error', 'critical'):
                    return "error"
                if i.priority  in ('warning'):
                    return "warning"
            return ""
        %>

        %for i in l:
        <div class="${getClass(i)}" style="padding: 4px; ;margin:8px; border-radius: 12px; border: 1px solid; ;block-size:fit-content;word-wrap: break-word;">
            <div>
                <span style="font-size:120%;">${i.name}</span><span style="font-size:120%">:${i.sm.state}</span><br>

                <span class="grey">
            Priority: ${i.priority}</span> <br><span class="grey">
            Tripped at: ${unitsofmeasure.strftime(i.trippedAt)}(about ${formatTimeInterval(time.time()-i.trippedAt,2)}
                ago)<br>
            Trip Message: ${i.trip_message}</span>
            </div>


            <div style="flex-grow:99"></div>

            <div style="align-self: flex-end;">${i.notificationHTML()}</div>

            %if not i.sm.state=="acknowledged":
            <div style="align-self: center;">
                <form action="?ackalarm=${i.id}" method="post"><button style="align-self: center;" href=".">ACK</button></form>
            </div>
            %else:
            <div style="align-self: center;">
                <button disabled>ACK</button>
            </div>
            %endif

        </div>
        %endfor

        <%
            try:
                del i
                del l
            except:
                pass
        %>
            </div>

            <h2> System Notifications</h2>
            <div id="app">
                <div class="max-h-12rem scroll border window" style="max-height: 25em; block-size: fit-content;" id="notifications">
                    <transition-group name="notificationstg" tag="div">
                            <div v-for="i in notifications.slice().reverse()" :key="i[0]">
                                <div v-bind:class="getClass(i)" style="border-radius: 12px; padding: 4px; margin: 8px;">
                                    <small>{{formatTime(i[0])}}</small>
                                    <p>{{i[2]}}</p>
                                </div>
                            </div>
                    </transition-group>
                </div>
            </div>
            </main>



            <script>
                var app = new Vue({
                    el: '#app',
                    data: {
                        notifications: [],
                        getClass: function(i) {
                            if (i[1].includes("errors")) {
                                return 'error notification'
                            }
                            else if (i[1].includes("important")) {
                                return 'highlight notification'
                            }
                            else if (i[1].includes("warnings")) {
                                return 'warning notification'
                            }
                            else{
                                return "notification"
                            }
                        },

                        formatTime: function(t) {
                            var date = new Date(t * 1000);
                            return date.strftime("%b %m %Y  %I:%M:%S%p %Z")
                        }
                    }
                });

                api.upd = function(msg) {
                    if (msg[0] == "all") {
                        app.$data.notifications = msg[1]
                    }
                    if (msg[0] == 'notification') {
                        app.$data.notifications.push(msg[1])
                        app.$data.notifications = app.$data.notifications.slice(-100)
                        setTimeout(() => {
                            document.getElementById("notifications").scroll(0, 0)
                        }, 250);
                    }
                }

                alertapi.upd = function(msg) {

                }
                setTimeout(() => {
                    document.getElementById("notifications").scroll(0, 0)
                }, 1000);
            </script>
            <%include file="/pagefooter.html"/>