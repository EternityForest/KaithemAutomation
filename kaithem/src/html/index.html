<%!
from src import notifications,auth,unitsofmeasure,pages,alerts
import time
import cherrypy
from src.config import config
from src.unitsofmeasure import formatTimeInterval
%>
<%include file="/pageheader.html"/>
<title>Kaithem Automation</title>

<div class="sectionbox">
<p>${config['front-page-banner']}</p>
</div>
<script src="/static/js/vue2.js"></script>
<script src="/static/widget.js"></script>
<script src="/static/js/strftime-min.js"></script>

${api.render("api")}
${alertsapi.render("alertapi")}


<main id="app">
%if 'auth' in cherrypy.request.cookie:
%if cherrypy.request.cookie['auth'].value in auth.Tokens:
    <div class="sectionbox">
        <p>Logged into Kaithem Automation as user: <b>${auth.whoHasToken(cherrypy.request.cookie['auth'].value)|h}</b></p>
    </div>
%endif
%endif

    <h2>Active/Unacknowledged Alarms</h2>
    <div class="scrollbox sectionbox">
        <%
        if "ackalarm" in cherrypy.request.params:
            alerts.all[cherrypy.request.params['ackalarm']].API_ack()
        toshow = {}
        l = []
  
        for i in alerts.unacknowledged.values():
            i = i()
            if not i:
                continue
            if pages.canUserDoThis(i.permissions):
                toshow[i.id]=0
                l.append(i)
        try:
            del i
        except:
            pass

        for i in alerts.active.values():
            i = i()
            if not i:
                continue
            if pages.canUserDoThis(i.permissions):
                if not i.id in toshow:
                    if not i.priority==debug:
                        toshow[i.id]=0
                        l.append(i)
        try:
            del i
        except:
            pass

        l = sorted(l, key=lambda i: (i.sm.state=="acknowledged", i.priority, i.zone, i.name))
        %>
    
        %for i in l:
        <div style="background-color:rgba(255,240,220,0.2);border-style:solid;"><b>${i.name}</b>
             Priority: ${i.priority}, Zone: ${i.zone}, State: ${i.sm.state}<br>
             Tripped at:${unitsofmeasure.strftime(i.trippedAt)}(about ${formatTimeInterval(time.time()-i.trippedAt,2)} ago)<br>
        %if not i.sm.state=="acknowledged":    
        <a class="button" href=".?ackalarm=${i.id}">ACK</a>
        %endif
        </div>
        %endfor

        <%
            try:
                del i
                del l
            except:
                pass
        %>
    </div>

    <h2> System Notifications</h2>
    <div class="scrollbox sectionbox"  style="max-height: 25em">
       <div v-for="i in notifications.slice().reverse()" v-bind:class="getClass(i)">
            <b>{{formatTime(i[0])}}</b>
            <p>{{i[2]}}</p>
            <hr>
        </div>
    </div>

</main>



<script>
    var app = new Vue({
        el: '#app',
        data: {
        notifications: [],
        getClass: function(i)
        {
            if (i[1].includes("errors"))
            {
                return 'error'
            }
            if (i[1].includes("important"))
            {
                return 'highlight'
            }
            if (i[1].includes("warnings"))
            {
                return 'warning'
            }
        },

        formatTime: function(t)
        {
            var date = new Date(t*1000);
            return date.strftime("%b %m %Y  %I:%M:%S%p %Z")
        }
    }});
    
    api.upd = function (msg) {
            if (msg[0] == "all") {
                app.$data.notifications= msg[1]
            }
            if(msg[0]=='notification')
            {
                app.$data.notifications.push(msg[1])
                app.$data.notifications = app.$data.notifications.slice(-100)
            }
        }

    alertapi.upd = function (msg) {
            
        }

    </script>
<%include file="/pagefooter.html"/>
