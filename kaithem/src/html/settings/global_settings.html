<%include file="/pageheader.html"/>
<%!
from src import config,registry,sound,persist,directories,geolocation,alerts
import yaml,os

jacksettingsfile = os.path.join(directories.vardir, "system.mixer", "jacksettings.yaml")
jacksettings = persist.getStateFile(jacksettingsfile)

location = geolocation.getLocation('default')

%>
<h2>Options</h2>


<title>Options</title>
<div class="sectionbox">
    <details>
        <summary>Saving info</summary>
        Most changes are saved temporarily to RAM until either a configured autosave, or a manual save of the server state.
    
    </details> 

<a href="/settings/save">Save server state to disk</a><br>
<a href="/settings/clearerrors">Clear all errors from pages and events</a><br>
<a href="/settings/reloadcfg">Reload the configuration file(Not all options take effect without restart)</a>

</div>

<h2>Port Forwarding</h2>
<section>
<p class="help">
This allows you to use UPnP to allow access to kaithem from the internet. Only HTTPS
is supported. Use at your own risk. Don't make kaithem publically acessible unless all user
passwords are very strong. This will open a port on all discovered routers if enabled.</a>
</p>
<form method="POST" action="/settings/changeupnptarget">
<table border=1>
<tr>
<td>HTTPS WAN Port(0 to disable forwarding)</td>
<td><input name="exposeport" value="${registry.get('/system/upnp/expose_https_wan_port',0)}".></td>
</tr>
</table>
<input type="submit" >
</form>
</section>



<h2>JACK/PipeWire Audio</h2>
<section>

<details>

    <summary>Audo help</summary>
<p>
Kaithem can use JACK audio, including automaticallly giving soundcards persistant JACK
names.  Using this is required for Kaithem's integrated sound mixer to work correctly.  Settings for external usb cards are set via the mixer.
</p>

<p >
If you have PipeWire running, kaithem will just detect and use that and these settings will be ignored.
</p>

<p><b>Note:</b>Managing the jack server is only supported with Jackd2, not the original implementation! On some versions of raspbian you may need to use Pi "dummy" compatibility mode which runs the main card as if it were a USB</p>
<p>Compatibility mode may allow better performance.</p>
</details>

<form method="POST" action="/settings/changejacksettingstarget">
<table border=1>
    <tr>
        <td>JACK Mode</td>
        <td>
            <select name="jackmode">
                <option title="Kaithem will ignore JACK" value="off" ${'selected' if  jacksettings.get('jackMode','off')=='off' else ''}>off</option>
                <option title="Kaithem will start PipeWire if it is not already running" value="pipewire" ${'selected' if jacksettings.get('jackMode','off')=='pipewire' else ''}>PipeWire</option>

                <option title="Kaithem will start and manage jackd" value="manage" ${'selected' if jacksettings.get('jackMode','off')=='manage' else ''}>manage</option>
                <option title="Kaithem will start and manage jackd in pi compatibility mode" value="dummy" ${'selected' if jacksettings.get('jackMode','off')=='dummy' else ''}>manage in compatibility mode</option>
                <option title="Kaithem will use an existing jackd/pipewire instance, but can manage USB cards" value="use" ${'selected' if jacksettings.get('jackMode','off')=='use' else ''}>Use Existing</option>
            </select>
           
        </td>
    </tr>

    <tr>
        <td>JACK Primary sound device(use a persistent alias, not a raw ALSA name)</td>
        <td>
            <input name="jackdevice" value="${jacksettings.get('jackDevice','')|h}">
        </td>
    </tr>


    <tr>
        <td>Use Additional Soundcards</td>
        <td>
            <select name="jackuseadditional">
                <option title="Only use primary JACK device" value="off" ${'selected' if  jacksettings.get('useAdditionalSoundcards','on')=='off' else ''}>off</option>
                <option title="Use all soundcards with alsa_io" value="yes" ${'selected' if jacksettings.get('useAdditionalSoundcards','on') in ('on','yes','true') else ''}>yes</option>
            </select>
           
        </td>
    </tr>

    <tr>
        <td>PulseAudio Sharing</td>
        <td>
            <select name="pulsesharing">
                    <option title="Only Kaithem's user" value="off" ${'selected' if  jacksettings.get('sharePulse','off')=='disable' else ''}>off</option>
                    <option title="Network share with any user on this machine" value="localhost" ${'selected' if  jacksettings.get('sharePulse','disable')=='localhost' else ''}>localhost</option>
                    <option title="Network share with entire local network" value="network" ${'selected' if jacksettings.get('sharePulse','disable')=='network' else ''}>network</option>
                    <option title="Run pulse in system-wide mode(May be needed to use Pulse as root)" value="system-wide" ${'selected' if jacksettings.get('sharePulse','disable')=='system-wide' else ''}>system-wide</option>
                    <option title="Do not use pulseaudio, prevent it from running at all" value="disable" ${'selected' if jacksettings.get('sharePulse','disable')=='disable' else ''}>disable</option>
                </select>
        </td>
    </tr>
    <%
    psize = jacksettings.get('jackPeriodSize',512)
    periods  = jacksettings.get('jackPeriods',3)
    %>
    <tr>
        <td>
            Period Size(Lower is less laggy, higher is more reliable)
        </td>
        <td>
            <select name="jackperiodsize">
                <option value="64" ${'selected' if psize==64 else ''}>64(Usually doesn't work)</option>
                <option value="128" ${'selected' if psize==128 else ''}>128(Some raspberry pi versions can't handle)</option>
                <option value="256" ${'selected' if psize==256 else ''}>256(Usually works, but laggy)</option>
                <option value="512" ${'selected' if psize==512 else ''}>512(Really laggy but even less dropouts)</option>
                <option value="1024" ${'selected' if psize==1024 else ''}>1024</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>
            Periods(Usually 2 or 3, Lower is less laggy, higher is more reliable)
        </td>
        <td>
            <select name="jackperiods">
                <option value="2" ${'selected' if periods==2 else ''}>2(Sometimes works, sometimes choppy)</option>
                <option value="3" ${'selected' if periods==3 else ''}>3(Usually works)</option>
                <option value="4" ${'selected' if periods==4 else ''}>4</option>
                <option value="5" ${'selected' if periods==5 else ''}>5</option>
                <option value="6" ${'selected' if periods==6 else ''}>6</option>
                <option value="7" ${'selected' if periods==7 else ''}>7</option>
                <option value="8" ${'selected' if periods==8 else ''}>8</option>

            </select>
        </td>
    </tr>

</table>
<input type="submit" >
</form>
</section>





<h2>Server Location</h2>
<section>
<p class="help">
This is mostly used for astronomical calculations. Get Location uses <a href="http://ip-api.com/">ip-api.com</a>
</p>
<form method="POST" action="/settings/changesettingstarget">
<table border=1>
<tr>
<tr>
<td>City</td>
<td><input name="city" value="${location['city']}".></td>
</tr>
<td>Lattitude</td>
<td><input name="lat" value="${location['lat']}".></td>
</tr>
<tr>
<td>Longitude</td>
<td><input name="lon" value="${location['lon']}".></td>
</tr>
</table>
<input type="submit" >
</form>
<form method="post" action="/settings/ip_geolocate">
<button type="submit">Get Location now</button>
</form>
</section>

<h2>Alerts</h2>
<div class="sectionbox">
<p class="help">
    Use the sound device __disable__ to turn off alert sounds.
</p>


<h3>Sound</h3>
<form action="/settings/changealertsettingstarget" method="POST">
<table border=1>
<tr>
    <td>Beep interval(Warnings)</td><td><input type="number" name="warningbeeptime" value="${alerts.file['warning']['interval']}"></input></td>
</tr>
<tr>
    <td>Sound file(Warnings)</td><td><input name="warningsound" value="${alerts.file['warning']['file']}"></input></td>
</tr>
<tr>
<td>Beep interval(Errors)</td><td><input type="number" name="errorbeeptime" value="${alerts.file['error']['interval']}"></input></td>
</tr>
<tr>
<td>Sound file(Errors)</td><td><input name="errorsound" value="${alerts.file['error']['file']}"></input></td>
    </tr>
<tr>
<td>Beep interval(Critical)</td><td><input type="number" name="critbeeptime" value="${alerts.file['critical']['interval']}"></input></td>
</tr>
<td>Sound file(Critical)</td><td><input name="critsound" value="${alerts.file['critical']['file']}"></input></td>
    </tr>
<tr>
<td>Sound Device(All)</td><td><input list="cards" name="soundcard" value="${alerts.file['all']['soundcard']}">
    <datalist id="cards">
        <option value=""></option>
        <option value="__disable__""></option>
    </datalist>

</input></td>
    </tr>

</table>
<input type="submit" value="Save sound settings">
</form>
</div>

<h2>Current Configuration Settings</h2>
<div class="sectionbox">
<p class="help">
Because some of these settings could cause instabilty if set incorrectly, they can currently only be
changed by actually changing the configuration file and resetting the server.</p>

<pre>
${yaml.dump(config.config,width=120,indent=4,default_flow_style=False)|h}
</pre>

</div>
<%include file="/pagefooter.html"/>
