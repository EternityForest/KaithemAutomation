<%include file="/pageheader.html"/>
<%!
from src import config,registry,sound,persist,directories
import yaml,os

jacksettingsfile = os.path.join(directories.vardir, "system.mixer", "jacksettings.yaml")
jacksettings = persist.getStateFile(jacksettingsfile)

%>
<h2>Options</h2>
<p class="help">Note: Your changes are saved temporarily to RAM until either a configured autosave(Off by default), or a manual save of the server state.</p>
<title>Options</title>
<div class="sectionbox">
<p class="help">
You need the <i>/admin/settings.edit</i> permission to perform these actions. <b>Note that "saving" settings on this page will not be saved to disk unless you then use save server state to disk, or an autosave occurs</b> </p>
<a href="/settings/restart">Completely restart the whole server(!)</a><br>
%if not config.config['save-before-shutdown']:
<p class="warning">Kaithem is not currently configured to save before shutting down. Restarting will lose any unsaved changes to modules, the registry, users and groups, and settings.</p>
%else:
<a href="/settings/restart_nosave">Completely restart the whole server without saving first(!)</a><br>
%endif
<br>
<a href="/settings/save">Save server state to disk</a><br>
<a href="/settings/clearerrors">Clear all errors from pages and events</a><br>
<a href="/settings/reloadcfg">Reload the configuration file(Not all options take effect without restart)</a>

</div>

<h2>Port Forwarding</h2>
<section>
<p class="help">
This allows you to use UPnP to allow access to kaithem from the internet. Only HTTPS
is supported. Use at your own risk. Don't make kaithem publically acessible unless all user
passwords are very strong. This will open a port on all discovered routers if enabled.</a>
</p>
<form method="POST" action="/settings/changeupnptarget">
<table border=1>
<tr>
<td>HTTPS WAN Port(0 to disable forwarding)</td>
<td><input name="exposeport" value="${registry.get('/system/upnp/expose_https_wan_port',0)}".></td>
</tr>
</table>
<input type="submit" >
</form>
</section>



<h2>JACK Audio</h2>
<section>
<p class="help">
Kaithem can use JACK audio, including automaticallly giving soundcards persistant JACK
names.  Using this is required for Kaithem's integrated sound mixer to work correctly.  Settings for external usb cards are set via the mixer.
</p>

<p class="help"><b>Note:</b>Managing the jack server is only supported with Jackd2, not the original implementation! On some versions of raspbian you may need to use Pi "dummy" compatibility mode which runs the main card as if it were a USB</p>
<p class="help">Compatibility mode may allow better performance.</p>
<form method="POST" action="/settings/changejacksettingstarget">
<table border=1>
    <tr>
        <td>JACK Mode</td>
        <td>
            <select name="jackmode">
                <option title="Kaithem will ignore JACK" value="off" ${'selected' if  jacksettings.get('jackMode','off')=='off' else ''}>off</option>
                <option title="Kaithem will start and manage jackd" value="manage" ${'selected' if jacksettings.get('jackMode','off')=='manage' else ''}>manage</option>
                <option title="Kaithem will start and manage jackd in pi compatibility mode" value="dummy" ${'selected' if jacksettings.get('jackMode','off')=='dummy' else ''}>manage in compatibility mode</option>
                <option title="Kaithem will use an existing jackd instance, but manage USB cards" value="use" ${'selected' if jacksettings.get('jackMode','off')=='use' else ''}>Use Existing</option>
            </select>
           
        </td>
    </tr>

    <tr>
        <td>JACK Primary sound device(use a persistent alias, not a raw ALSA name)</td>
        <td>
            <input name="jackdevice" value="${jacksettings.get('jackDevice','')|h}">
        </td>
    </tr>


    <tr>
        <td>Use Additional Soundcards</td>
        <td>
            <select name="jackuseadditional">
                <option title="Only use primary JACK device" value="off" ${'selected' if  jacksettings.get('useAdditionalSoundcards','on')=='off' else ''}>off</option>
                <option title="Use all soundcards with alsa_io" value="yes" ${'selected' if jacksettings.get('useAdditionalSoundcards','on') in ('on','yes','true') else ''}>yes</option>
            </select>
           
        </td>
    </tr>

    <tr>
        <td>PulseAudio Sharing</td>
        <td>
            <select name="pulsesharing">
                    <option title="Only Kaithem's user" value="off" ${'selected' if  jacksettings.get('sharePulse','off')=='disable' else ''}>off</option>
                    <option title="Network share with any user on this machine" value="localhost" ${'selected' if  jacksettings.get('sharePulse','disable')=='localhost' else ''}>localhost</option>
                    <option title="Network share with entire local network" value="network" ${'selected' if jacksettings.get('sharePulse','disable')=='network' else ''}>network</option>
                    <option title="Run pulse in system-wide mode(May be needed to use Pulse as root)" value="system-wide" ${'selected' if jacksettings.get('sharePulse','disable')=='system-wide' else ''}>system-wide</option>
                    <option title="Do not use pulseaudio, prevent it from running at all" value="disable" ${'selected' if jacksettings.get('sharePulse','disable')=='disable' else ''}>disable</option>
                </select>
        </td>
    </tr>
    <%
    psize = jacksettings.get('jackPeriodSize',512)
    periods  = jacksettings.get('jackPeriods',3)
    %>
    <tr>
        <td>
            Period Size(Lower is less laggy, higher is more reliable)
        </td>
        <td>
            <select name="jackperiodsize">
                <option value="64" ${'selected' if psize==64 else ''}>64(Usually doesn't work)</option>
                <option value="128" ${'selected' if psize==128 else ''}>128(Some raspberry pi versions can't handle)</option>
                <option value="256" ${'selected' if psize==256 else ''}>256(Usually works, but laggy)</option>
                <option value="512" ${'selected' if psize==512 else ''}>512(Really laggy but even less dropouts)</option>
                <option value="1024" ${'selected' if psize==1024 else ''}>1024</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>
            Periods(Usually 2 or 3, Lower is less laggy, higher is more reliable)
        </td>
        <td>
            <select name="jackperiods">
                <option value="2" ${'selected' if periods==2 else ''}>2(Sometimes works, sometimes choppy)</option>
                <option value="3" ${'selected' if periods==3 else ''}>3(Usually works)</option>
                <option value="4" ${'selected' if periods==4 else ''}>4</option>
                <option value="5" ${'selected' if periods==5 else ''}>5</option>
                <option value="6" ${'selected' if periods==6 else ''}>6</option>
                <option value="7" ${'selected' if periods==7 else ''}>7</option>
                <option value="8" ${'selected' if periods==8 else ''}>8</option>

            </select>
        </td>
    </tr>

</table>
<input type="submit" >
</form>
</section>





<h2>Server Location</h2>
<section>
<p class="help">
This is mostly used for astronomical calculations. Get Location uses <a href="http://ip-api.com/">ip-api.com</a>
</p>
<form method="POST" action="/settings/changesettingstarget">
<table border=1>
<tr>
<tr>
<td>City</td>
<td><input name="city" value="${registry.get('system/location/city','')}".></td>
</tr>
<td>Lattitude</td>
<td><input name="lat" value="${registry.get('system/location/lat','')}".></td>
</tr>
<tr>
<td>Longitude</td>
<td><input name="lon" value="${registry.get('system/location/lon','')}".></td>
</tr>
</table>
<input type="submit" >
</form>
<form method="post" action="/settings/ip_geolocate">
<button type="submit">Get Location now</button>
</form>
</section>

<h2>Alerts</h2>
<div class="sectionbox">
<p class="help">
    Use the sound device __disable__ to turn off alert sounds.
</p>


<p class="warning">
    Kaithem no longer supports multiple sound cards with anything besides JACK!! The sound card alias mechanism is gone.  Multiple JACK outputs remain as a core use case.
</p>

<h3>Sound</h3>
<form action="/settings/changealertsettingstarget" method="POST">
<table border=1>
<tr>
    <td>Beep interval(Warnings)</td><td><input type="number" name="warningbeeptime" value="${registry.get('system/alerts/warning/soundinterval',60*25)}"></input></td>
</tr>
<tr>
    <td>Sound file(Warnings)</td><td><input name="warningsound" value="${registry.get('system/alerts/warning/soundfile','error.ogg')}"></input></td>
</tr>
<tr>
<td>Beep interval(Errors)</td><td><input type="number" name="errorbeeptime" value="${registry.get('system/alerts/error/soundinterval',120)}"></input></td>
</tr>
<tr>
<td>Sound file(Errors)</td><td><input name="errorsound" value="${registry.get('system/alerts/error/soundfile','error.ogg')}"></input></td>
    </tr>
<tr>
<td>Beep interval(Critical)</td><td><input type="number" name="critbeeptime" value="${registry.get('system/alerts/critical/soundinterval',12.6)}"></input></td>
</tr>
<td>Sound file(Critical)</td><td><input name="critsound" value="${registry.get('system/alerts/critical/soundfile','error.ogg')}"></input></td>
    </tr>
<tr>
<td>Sound Device(All)</td><td><input list="cards" name="soundcard" value="${registry.get('system/alerts/soundcard','default')}">
    <datalist id="cards">
        <option value=""></option>
        <option value="__disable__""></option>
    </datalist>

</input></td>
    </tr>

</table>
<input type="submit" value="Save sound settings">
</form>
</div>

<h2>Mailroom</h2>
<div class="sectionbox">
<h3>Email Account</h3>
<p class="help">You must configure an email account for kaithem to use. Most free email services
allow SMTP access. Gmail and Yahoo both work. You can also run your own SMTP server
Unencrypted connections are not supported. Please note: the email password must be stored in plaintext in a kaithem registry file.</p>
<form action="/settings/savemail" method="POST">
<table border=1>
<tr>
<td>SMTP Server</td><td><input name="smtpserver" value="${registry.get("system/mail/server")}"></input></td>
</tr>
<tr>
<td>Port</td><td><input name="smtpport" value="${registry.get("system/mail/port")}"></input></td>
</tr><tr>
<td>Login/email address</td><td><input name="smtpaddress" value="${registry.get("system/mail/address")}"></input></td>
</tr><tr>
<td>New Password(blank for no change)</td><td><input type="password" name="smtpassword1"}"></input></td>
</tr><tr>
<td>Confirm: New Password</td><td><input type="password" name="smtpassword2"}"></input></td>
</tr>
</table>

<%mail= registry.get("system/mail/lists",{})%>

<h3>Mailing Lists</h3>
<p class="help">Mailing lists are identified by UUID.</p>
<table border=1>
<tr><td>Name</td><td>Info</td><td>UUID</td><td>Delete</td></tr>
%for i in mail:
<tr>
<td>
<input name="mlist_name${i|h}" value="${mail[i]['name']}">
</td>
<td>
<input name="mlist_desc${i|h}" value="${mail[i]['description']}">
</td>
<td>
${i|h}
</td>
<td>
<input type="submit" name="del_${i}" value="Delete"></input>
</td>
</tr>
%endfor
</table>

<input type="submit" name="newlist" value="New list"></input>
<input type="submit" value="save mail settings"></input>

</form>
<h3>Send Test Email</h3>
<form method="post" action="/settings/testmail">

<input name="to" placeholder="Destination Address"></input><input type="submit" value="Test Email"></input>
</form>

<h3>Send Message To List</h3>
<form method="post" action="/settings/listmail">
<input name="list" placeholder="List UUID"></input>
<input name="subj" placeholder="Subject"></input><br>
<textarea name="msg" class="code" placeholder="Message Here"></textarea>
<input type="submit" value="Send(To entire list) Email">


</form>
</div>

<h2>Current Configuration Settings</h2>
<div class="sectionbox">
<p class="help">
Because some of these settings could cause instabilty if set incorrectly, they can currently only be
changed by actually changing the configuration file and resetting the server.</p>

<pre>
${yaml.dump(config.config,width=120,indent=4,default_flow_style=False)|h}
</pre>

</div>
<%include file="/pagefooter.html"/>
