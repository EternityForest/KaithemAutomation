<%include file="/pageheader.html"/>
<%!
from kaithem.src import config,sound,persist,directories,geolocation,alerts,settings
import yaml,os

jacksettingsfile = os.path.join(directories.vardir, "system.mixer", "jacksettings.yaml")
jacksettings = persist.getStateFile(jacksettingsfile)


upnpsettingsfile = os.path.join(
    directories.vardir, "core.settings", "upnpsettings.yaml")

upnpsettingsfile = persist.getStateFile(upnpsettingsfile)

location = geolocation.getLocation('default')

%>
<h2>Options</h2>


<title>Options</title>
<div class="sectionbox">
    <details>
        <summary>Saving info</summary>
        Most changes are saved temporarily to RAM until either a configured autosave, or a manual save of the server state.
    
    </details> 

<a href="/settings/save">Save server state to disk(Flushes logs, users, and groups)</a><br>
<a href="/settings/clearerrors">Clear all errors from pages and events</a><br>
<a href="/settings/reloadcfg">Reload the configuration file(Not all options take effect without restart)</a>

</div>

<h2>Port Forwarding</h2>
<section>
<p class="help">
This allows you to use UPnP to allow access to kaithem from the internet. Only HTTPS
is supported. Use at your own risk. Don't make kaithem publically acessible unless all user
passwords are very strong. This will open a port on all discovered routers if enabled.</a>
</p>
<form method="POST" action="/settings/changeupnptarget">
<table border=1>
<tr>
<td>HTTPS WAN Port(0 to disable forwarding)</td>
<td><input name="exposeport" value="${upnpsettingsfile.get('wan_port',0)}".></td>
</tr>
</table>
<input type="submit" >
</form>
</section>



<h2>Alternate Homepage</h2>
<section>
<p class="help">
This lets you make the root go to a different page.  Use /index to access the normal homepage.
</p>
<form method="POST" action="/settings/changeredirecttarget">
<table border=1>
<tr>
<td>URL to redirect / to</td>
<td><input name="url" value="${settings.redirects.get('/',{}).get('url','')}".></td>
</tr>
</table>
<input type="submit" >
</form>
</section>


<h2>Screen Rotate</h2>
<section>
    <form method="POST" action="/settings/changerotationtarget">

<label>Rotate<select name="rotate">
    <p class="help">

        Sets the screen rotation.  You should not use this on multi-display systems, the result is undefined
        as to which one it will affect.  This may be fixed later.
    </p>
            <option value=""
            %if settings.redirects.get('__first__',{}).get('Rotate','').strip()=='':
            selected\
            %endif
            >
            Unset
            </option>

            <option value="left"
            %if settings.redirects.get('__first__',{}).get('Rotate','').strip()=='left':
            selected\
            %endif
            >
            Left
            </option>

            <option value="right"
            %if settings.redirects.get('__first__',{}).get('Rotate','').strip()=='right':
            selected\
            %endif
            >
            Right
            </option>

            <option value=""
            %if settings.redirects.get('__first__',{}).get('Rotate','').strip()=='invert':
            selected\
            %endif
            >
            Invert
            </option>

            <option value="normal"
            %if settings.redirects.get('__first__',{}).get('Rotate','').strip()=='normal':
            selected\
            %endif
            >
            Normal
            </option>
        </select></label>
        <input type="submit" >

    </form>
</section>



<h2>Server Location</h2>
<section>
<p class="help">
This is mostly used for astronomical calculations. All are optional.
Get Location uses <a href="http://ip-api.com/">ip-api.com</a>
</p>
<form method="POST" action="/settings/changesettingstarget">
<table border=1>
<tr>
<tr>

<td>Country Code</td>
    <td><input name="country" value="${location['countryCode']}".></td>
</tr>

<tr>
    <td>Region</td>
    <td><input name="region" value="${location['regionName']}".></td>
</tr>

<tr>
    <td>Timezone</td>
    <td><input name="timezone" value="${location['timezone']}".></td>
</tr>


<tr>
    <td>City</td>
    <td><input name="city" value="${location['city']}".></td>
</tr>

<td>Lattitude</td>
    <td><input name="lat" value="${location['lat']}".></td>
</tr>
<tr>
<td>Longitude</td>
    <td><input name="lon" value="${location['lon']}".></td>
</tr>
</table>
<input type="submit" >
</form>
<form method="post" action="/settings/ip_geolocate">
<button type="submit">Get Location now</button>
</form>
</section>

<h2>Alerts</h2>
<div class="sectionbox">
<p class="help">
    Use the sound device __disable__ to turn off alert sounds.
</p>


<h3>Sound</h3>
<form action="/settings/changealertsettingstarget" method="POST">
<table border=1>
<tr>
    <td>Beep interval(Warnings)</td><td><input type="number" name="warningbeeptime" value="${alerts.file['warning']['interval']}"></input></td>
</tr>
<tr>
    <td>Sound file(Warnings)</td><td><input name="warningsound" value="${alerts.file['warning']['file']}"></input></td>
</tr>
<tr>
<td>Beep interval(Errors)</td><td><input type="number" name="errorbeeptime" value="${alerts.file['error']['interval']}"></input></td>
</tr>
<tr>
<td>Sound file(Errors)</td><td><input name="errorsound" value="${alerts.file['error']['file']}"></input></td>
    </tr>
<tr>
<td>Beep interval(Critical)</td><td><input type="number" name="critbeeptime" value="${alerts.file['critical']['interval']}"></input></td>
</tr>
<td>Sound file(Critical)</td><td><input name="critsound" value="${alerts.file['critical']['file']}"></input></td>
    </tr>
<tr>
<td>Sound Device(All)</td><td><input list="cards" name="soundcard" value="${alerts.file['all'].get('soundcard','')}">
    <datalist id="cards">
        <option value=""></option>
        <option value="__disable__""></option>
    </datalist>

</input></td>
    </tr>

</table>
<input type="submit" value="Save sound settings">
</form>
</div>

<h2>Current Configuration Settings</h2>
<div class="sectionbox">
<p class="help">
Because some of these settings could cause instabilty if set incorrectly, they can currently only be
changed by actually changing the configuration file and resetting the server.</p>

<pre>
${yaml.dump(config.config,width=120,indent=4,default_flow_style=False)|h}
</pre>

</div>
<%include file="/pagefooter.html"/>
