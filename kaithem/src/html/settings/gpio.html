<%include file="/pageheader.html"/>
<%!

%>
<title>GPIO</title>
<div class="sectionbox">
  <script type="text/javascript" src="/static/widget.js"></script>
  <style>
    button.bold{
      font-weight: bolder;
      text-shadow: 5px;
      
    }
  </style>


  ${api.render("api")}

  <div id="app" style="min-width: 80%; max-width: 10000%; ">
   
    <h2>Digital Inputs in Use</h2>
    <p class="help">
        Only inputs via kaithem.gpio are shown.  You can "Mock" a pin, effectivly switching the pin into a virtual
        mode where it ignores real input and only watches your virtual commands.
    </p>
    <p class="help">
        Note that GPIOZero natively supports active-low pins. A pin is active when the voltage matches the configured active state,
        which can be high or low. Active low pins are "active" when the raw input is low.
    </p>
    <table border="1">
       <tr>
           <th>Pin</th>
           <th title="If the pin is active, NOT the raw val">Current State</th>
           <th>Comment</th>
           <th>Mocked</th>
           <th>Active High</th>
           <th>Tools</th>
       </tr>

       <tr v-for="i in dictView(inputs, ['p'])">
           <td>{{i[0]}}</td>
           <td title="If the pin is active, NOT the raw voltage input">
            <img src="/zipstatic/img/icons/fugue.zip/light-bulb.png" v-if="i[1].v">
            <img src="/zipstatic/img/icons/fugue.zip/light-bulb-off.png" v-if="!i[1].v">
            {{i[1].v ? 'active':"inactive"}}</td>
           <td>{{i[1].c}}</td>
           <td><img src="/zipstatic/img/icons/fugue.zip/wrench.png" v-if="i[1].m">
            <img src="/zipstatic/img/icons/fugue.zip/leaf.png" v-if="!i[1].m">
            {{i[1].m ? 'Mocked':"Live"}}



           </td>
           <td title="Is the pin active when the voltage is high?">{{i[1].a_s}}</td>
           <td><button v-on:click="promptMock(i[0],1)" title="Fake the raw input voltage being high">Mock pin high/3.3v</button>
            <button v-on:click="promptMock(i[0],0)" title="Fake the raw input voltage being low">Mock 0V</button>
            <button v-on:click="promptMock(i[0],-1)" title="Stop faking inputs">Unmock</button>
        
        </td>
       </tr>

   </table>

   <h2>Digital Outputs in Use</h2>
   <p class="help">
       Only outputs via kaithem.gpio are shown.
   </p>
   <p class="help">
       Note that GPIOZero natively supports active-low pins. An active output is set to the active state which may be low or high.
   </p>
   <table border="1">
      <tr>
          <th>Pin</th>
          <th title="If the pin is active, NOT the raw val">Current State</th>
          <th>Comment</th>
          <th>Overridden</th>
          <th>Active High</th>
          <th>Tools</th>
      </tr>

      <tr v-for="i in dictView(outputs, ['p'])">
          <td>{{i[0]}}</td>
          <td title="If the pin is active, NOT the raw voltage input">
           <img src="/zipstatic/img/icons/fugue.zip/light-bulb.png" v-if="i[1].v">
           <img src="/zipstatic/img/icons/fugue.zip/light-bulb-off.png" v-if="!i[1].v">
           {{i[1].v ? 'active':"inactive"}}</td>
          <td>{{i[1].c}}</td>
          <td><img src="/zipstatic/img/icons/fugue.zip/wrench.png" v-if="i[1].m">
           <img src="/zipstatic/img/icons/fugue.zip/leaf.png" v-if="!i[1].m">
           {{i[1].m ? 'Mocked':"Live"}}



          </td>
          <td title="Does the acrive state cause a high output voltage?">{{i[1].a_s}}</td>
          <td><button v-on:click="promptOverride(i[0],1)" title="Force Active">Force Active</button>
           <button v-on:click="promptOverride(i[0],0)" title="Force Inactive">Force Inactive</button>
           <button v-on:click="promptOverride(i[0],-1)" title="Return to normal operation">Unforce</button>

       </td>
      </tr>

  </table>

   <button v-on:click="api.send(['refresh'])">Refresh</button>
</div>



<script src="/static/js/vue2.js"></script>


<script>
  var app = new Vue({
    el: '#app',
    data: {
      connections: [],
      status: {},
      api:api,
      inputs: {},
      outputs:{},

      'promptMock':function(m,v)
      {
            var x = parseInt(m)
            if (!isNaN(x))
            {
                m=x;
            }
            
            //If we are not mocked, ask if we really want to
            //Also confim before unmock
            if((!app.$data.inputs[m].m) | v==-1)
            {
                var r = confirm("Are you sure you want to enable or disable mocking?")
            }
            else
            {
                var r=true;
            }

            if (r!=null)
            {
                r = parseInt(r);
                if(v==-1)
                {
                    api.send(['unmock', m])
                }
                else
                {
                    api.send(['mock', m,v])
                }
            }
      },
      'promptForce':function(m,v)
      {
            var x = parseInt(m)
            if (!isNaN(x))
            {
                m=x;
            }
            
            //If we are not mocked, ask if we really want to
            //Also confim before unmock
            if((!app.$data.ouputs[m].m) | v==-1)
            {
                var r = confirm("Are you sure you want to enable or disable forcing?")
            }
            else
            {
                var r=true;
            }

            if (r!=null)
            {
                r = parseInt(r);
                if(v==-1)
                {
                    api.send(['unforce', m])
                }
                else
                {
                    api.send(['force', m,v])
                }
            }
      },
      'dictView': function(dict, sorts)
        {
            //Given a dict  and a list of sort keys sorts,
            //return a list of [key,value] pairs sorted by the sort 
            //keys. Earlier sort keys take precendence.

            //Keys starting with ! are interpreted as meanng to sort in descending order

            var o = []
            Object.keys(dict).forEach(
                function(key, index)
                {
                    o.push([key, dict[key]])
                })

            var l = []
            for (var i of sorts)
            {
                //Convert to (reverse, string) tuple where reverse is -1 if str started with an exclamation point
                //Get rid of the fist char if so
                l.push([
                    i[0] == '!' ? -1 : 1,
                    i[0] == "!" ? i.slice(1) : i
                ])
            }

            o.sort(function(a, b)
            {
                //For each of the possible soft keys, check if they
                //are different. If so, compare and possible reverse the ouptut

                var d = a[1]
                var d2 = b[1]
                for (i of l)
                {
                    var key = i[1]
                    var rev = i[0]
                    if (!(d[key] == d2[key]))
                    {
                        return (d[key] > d2[key] ? 1 :-1) * rev
                    }

                }
                return 0
            });
            return (o)
        }

  }}
  );

  api.upd = function (msg) {
        if (msg[0] == "inputs") {
            app.$data.inputs= msg[1]
        }
        if (msg[0] == "outputs") {
            app.$data.outputs= msg[1]
        }
        if (msg[0] == "v") {
            app.$data.inputs[msg[1]].v=msg[2]
        }
        if (msg[0] == "o") {
            app.$data.outputs[msg[1]].v=msg[2]
        }
        if (msg[0] == "ipin") {
            app.$data.inputs[msg[1]]=msg[2]
        }
        if (msg[0] == "opin") {
            app.$data.inputs[msg[1]]=msg[2]
        }
    }

 var refresh=function(){ api.send(['refresh']);}

 setInterval(refresh,5000);
 api.send(['refresh'])
</script>

</div>
<%include file="/pagefooter.html"/>