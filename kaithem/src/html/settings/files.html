<%include file="/pageheader.html"/>
<%
from kaithem.src import unitsofmeasure,util,directories
import os,urllib

def size(f):
    try:
        return unitsofmeasure.siFormatNumber(os.path.getsize(os.path.join(dir,f)),1)
    except Exception as e:
        return str(e)
%>
<h1>File Manager</h1>
<div class="window">

<a href="/settings/files/${util.url(os.path.split(dir)[0])}">Up One Level</a><br>

<pre>${dir|h}</pre>
<details class="help"><summary><i class="icofont-question-circle"></i></summary>Unpacking puts all zip contents into the current dir, without creating a new subdir 
"foo" in the zip becomes "DIR/foo".  If a destination file exists, it is overwritten.</details>
<form enctype="multipart/form-data" action="/settings/files/${util.url(dir)}" method="POST">

<p class="menubar">
Upload File:
<input type="file" name="file">
<input type="submit">
</p>
</form>

<form enctype="multipart/form-data" action="/settings/files/${util.url(dir)}" method="POST">
<p class="menubar">
Upload zip and unpack:
<input type="file" name="zipfile">
<input type="submit">
</p>
</form>

<div class="help">
    These options allow you to download a video file, for legal archival purposes only, from popular video sharing sites.</br>
    To download the first YouTube search result, use "ytsearch: some text"</br>

    Otherwise, you can directly specify a YouTube(Or just about any other site) URL.  These features require youtube-dl to be installled and up-to-date.
</div>

<form enctype="multipart/form-data" action="/settings/files/${util.url(dir)}" method="POST">
    <p class="menubar">
    Download Audio File(legal only!)
    <input name="youtubedl" value="ytsearch: ">
    <input type="submit">
    </p>
</form>

<form enctype="multipart/form-data" action="/settings/files/${util.url(dir)}" method="POST">
    <p class="menubar">
    Download video File(legal only!)
    <input name="youtubedl" value="ytsearch: ">
    <input type="submit">
    </p>
</form>

<table border=1>
<tr><th>Path</th><th>Size</th><th>Action</th></tr>
%for i in sorted(os.listdir(dir)):

<tr><td><a href="/settings/files/${util.url(os.path.join(dir,i))}">${i+("/" if os.path.isdir(os.path.join(dir,i)) else '')|h}</a></td>
<td>${size(i)}B</td>\

<td><div style="display: flex; flex-direction:column;"><a class="button" href="/settings/cnfdel/${util.url(os.path.join(dir,i))}">Delete</a>

%if i.endswith("m3u8"):
<a class="button" href="/settings/hlsplayer/${util.url(os.path.join(dir,i))}">Play in browser</a>
%endif

%if i.endswith(".sqlite"):
<a class="button" href="/database/${util.url(os.path.join(dir,i))}/">Browse</a>
%endif

%if dir.startswith(os.path.join(directories.vardir,"static")):
    %if i.endswith(".mp4"):
    <a class="button" href="/utils/video_signage?src=${util.url('/user_static/'+os.path.join(dir[len(os.path.join(directories.vardir,'static')):],i))}">Digital Signage link</a>
    <a class="button" href="/utils/video_signage?src=${util.url('/user_static/'+os.path.join(dir[len(os.path.join(directories.vardir,'static')):],i))}&muted=0">Digital Signage(w/ audio)</a>

    %endif

%endif

</div>
</td>

</tr>
%endfor
</table>


</div>
<%include file="/pagefooter.html"/>
