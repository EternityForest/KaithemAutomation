<%include file="/pageheader.html"/>
<%!
from src import systasks
from src import timesync
from src import jackmixer
%>
<title>Mixing Board</title>
<div class="sectionbox" style="height: 80vh">
  <script type="text/javascript" src="/static/widget.js"></script>
  <style>
    div.channel {
      height: 95%;
      border-style: inset;
      border-width: 0.2em;
      display: inline-block;
      margin: 0.2em;
      vertical-align: top;
      width: 24em;

    }

    div.chain {
      border-style: inset;
      border-width: 0.1em;
      margin: 0.2em;
      height: 50%;
      overflow: scroll;


    }

    div.effect {
      border-style: solid;
      border-width: 1px;
      margin: 0.5em;
    }
  </style>


  ${jackmixer.board.api.render("api")}
  ${jackmixer.global_api.render("gapi")}



  <div id="app"
    style="height:95%;overflow-x: scroll; overflow-y: hidden; min-width: 80%; max-width: 10000%; max-height: 98%;     white-space: nowrap;">
    <datalist id="effectTypes">
      <option value="fader">Fader</option>
      <option value="3beq">3-Band EQ</option>
    </datalist>

    <datalist id="inports">
      <option v-for="i in sortedConnectables(inports)">{{i}}</option>
    </datalist>

    <datalist id="outports">
      <option v-for="i in sortedConnectables(outports)">{{i}}</option>
    </datalist>

    <button class="{bold: activePane=='mixer'}" v-on:click="activePane=mixer">Mixer</button>

    <div v-if="activePane=='mixer'">
      <div class="channel" v-for="(channel,channelname) in channels">
        <h3>{{channelname}} <button v-on:click="confirmDelete(channelname)">X</button></h3>
        Connect Input: <input v-model="channel.input" list="outports"
          v-on:input="setInput(channelname, $event.target.value)">
        <div class=" chain">
          <div v-for="effect, index in channel.effects" class="effect">
            <h4 v-bind:title="effect.id">{{effect.displayType}}
              <button v-on:click="moveEffectUp(channelname, index)">Up</button>
              <button v-on:click="moveEffectDown(channelname, index)">Down</button>
              <button v-on:click="deleteEffect(channelname, index)">Del</button>
            </h4>
            <div v-for="param in sortedParams(effect.params)" class="param">
              <div v-if="param.type=='float'">
                <b>{{param.displayName}}</b>({{param.value}}): {{param.min}}<input type="range" v-model.number="param.value"
                  v-bind:min="param.min" v-bind:max="param.max" v-on:input="setParam(channelname,effect.id,param.name,$event.target.value)">{{param.max}}
              </div>
              <div v-if="param.type=='bool'">
                <b>{{param.displayName}}</b>({{param.value}}): {{param.min}}<input type="checkbox" v-model.number="param.value"
                   v-on:input="setParam(channelname,effect.id,param.name,$event.target.value)">{{param.max}}
              </div>
            </div>

          </div>

          <div class="effect">
            <h3>Add Effect</h3>
              <div style="height:8em;overflow: scroll;">
              <div v-for="i in effectTypes">
                <h4>{{i.displayType}}</h4>
                <p>{{i.help}}</p>
                <button v-on:click="api.send(['addEffect', channelname, i.type])">Add</button>
              </div>
              </div>
          </div>

        </div>
    
        <input v-model="channel.fader" v-on:input="setFader(channelname, parseFloat($event.target.value))"
        orient="vertical" type="range" step="0.5" value="-80" min="-80" max="10">
      {{channel.fader}}dB<br>
      Connect output: <input v-model="channel.output" list="inports"
        v-on:input="setOutput(channelname, $event.target.value)">

      </div>


  <div class="channel">
    <h2>Soundboard</h2>
    <p>This is the control strip.<br>
      Kaithem's Soundboard is an</br>
      Emulation of a traditional </br>
      Analog board.</br>
    </p>
    <h3>New Channel</h3>
    <input v-model="newchannelname"><button v-on:click="api.send(['addChannel', newchannelname])">Add</button>
  </div>
</div>

</div>



<script src="/static/js/vue2.js"></script>
<script src="/static/js/sortable.min.js"></script>
<script src="/static/js/vuedraggable.umd.min.js"></script>


<script>
  function compareParams(a, b) {
    if (a.sort > b.sort) return 1;
    if (b.sort < a.sort) return -1;

    return 0;
  };

  function sortedParams(pl) {
    var l = [];
    for (i in pl) {
      pl[i].name = i;
      l.push(pl[i]);
    }
    l.sort(compareParams);
    return (l);
  };



  var app = new Vue({
    el: '#app',
    data: {
      message: 'Hello Vue!',
      inports: {},
      outports: {},
      channels: {},
      api: api,
      newchannelname: "",
      neweffecttype: "",
      activePane: "mixer",
      effectTypes:{},
      confirmDelete: function (c) {
        if (window.confirm("Do you really want to delete this channel?")) {
          api.send(['rmChannel', c]);
        }
      },
      moveEffectUp: function (channel, effectIndex) {
        if (effectIndex > 0) {
          var x = this.channels[channel].effects[effectIndex]
          var y = this.channels[channel].effects[effectIndex - 1]

          this.channels[channel].effects[effectIndex] = y;
          this.channels[channel].effects[effectIndex - 1] = x;
          api.send(['setEffects', channel, this.channels[channel].effects]);

        }
      },

      moveEffectDown: function (channel, effectIndex) {
        if (effectIndex < (this.channels[channel].effects.length-1)) {
          var x = this.channels[channel].effects[effectIndex]
          var y = this.channels[channel].effects[effectIndex +1]

          this.channels[channel].effects[effectIndex] = y;
          this.channels[channel].effects[effectIndex + 1] = x;
          api.send(['setEffects', channel, this.channels[channel].effects]);

        }
      },
      deleteEffect: function (channel, effectIndex) {
          this.channels[channel].effects.splice(effectIndex,1);
          api.send(['setEffects', channel, this.channels[channel].effects]);
      },

      setFader: function (channel, value) {
        api.send(['setFader', channel, value]);
      },

      setOutput: function (channel, value) {
        api.send(['setOutput', channel, value]);
      },

      setParam: function (channel, effect,param,value) {
        api.send(['setParam', channel, effect,param,value]);
      },
      setInput: function (channel, value) {
        api.send(['setInput', channel, value]);
      },
      sortedParams: function (pl) {
        var l = [];
        for (i in pl) {
          pl[i].name = i;
          l.push(pl[i]);
        }
        l.sort(compareParams);
        return (l);
      },

      //Given dict of ports, return every connectable(Port and just client without port)
      sortedConnectables: function (pl) {
        var l = [];
        var clients = {};
        var x = Object.keys(pl);
        x.sort();
        for (i in pl) {
          l.push(i);
          if (!(i.split(':')[0] in clients)) {
            l.push(i.split(":")[0])
            clients[i.split(":")[0]] = 1;
          }
        }
        l.sort();
        return (l);
      }
    }
  });

  api.upd = function (msg) {

    if (msg[0] == "newport") {

      if (msg[3]) {
        app.$data.inports[msg[1]] = msg[2];
      }
      else {
        app.$data.outports[msg[1]] = msg[2];
      }
    }

    if (msg[0] == "rmport") {
      delete app.$data.inports[msg[1]];
      delete app.$data.outports[msg[1]]
    }


    if (msg[0] == "inports") {
      app.$data.inports = msg[1];
    }

    if (msg[0] == "effectTypes") {
      app.$data.effectTypes = msg[1];
    }
    if (msg[0] == "outports") {
      app.$data.outports = msg[1];
    }
    if (msg[0] == "channels") {
      app.$data.channels = msg[1];
    }
  };
  gapi.upd = api.upd;

  api.send(['refresh']);
</script>

</div>
<%include file="/pagefooter.html"/>