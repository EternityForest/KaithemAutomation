<%include file="/pageheader.html"/>

<%!
from src import tagpoints,unitsofmeasure,util,pages
import time
import gc
import collections
import dateutil
import cherrypy


def combineLogs(a):
    op = []

    for i in a:
        for j in a[i]:
            op.append((unitsofmeasure.strftime(j[0]),i,j[1]))
    
    return sorted(op)
    
%>
<%
    logtime=time.time()-3600
    if data and 'logtime' in data:
        logtime = dateutil.parser.parse(data['logtime']).timestamp()

        
        
    pageGCListIgnoreFlag = True


    tagConfig={}
    ald = {}

    if new_numtag:
        tag=tagpoints.Tag(new_numtag)
    elif new_strtag:
        tag=tagpoints.StringTag(new_strtag)

    else:
        if data:
            pages.postOnly()
            with tagpoints.lock:
                loggers = {}
                loggersList = []
                loggerTypes={}

                for i in data:
                    if i.startswith("alarm_"):
                        x = i.split("_",1)[1]
                        if x.count(":")>1:
                            raise ValueError("Likely invalid alarm name containing :")

                        alarmName, alarmProperty =x.split(":")
                        
                        
                        #There's no row yet for the new alarm that might be happening
                        if alarmName=="NEW":
                            alarmName = data['alarm_NEW:name']
                            if not alarmName:
                                continue

                        if not alarmName in ald:
                            ald[alarmName]={}

                        ald[alarmName][alarmProperty] = data[i]


                    if i.startswith("logger_"):
                        x = i.split("_",1)[1]

                        loggerNumber, loggerProperty =x.split(":")

                        # Nonempty props indicate we don't get rid of it
                        if not loggerNumber in loggers:
                            loggers[loggerNumber]={}
                        loggers[loggerNumber][loggerProperty] = data[i]

              
                
                for i in sorted(list(loggers.keys())):
                    interval = float(loggers[i]['interval'])
                    historyLength = float(loggers[i]['historyLength'])
                    accumulate = loggers[i]['accumulate']
                    if interval:
                        #It would create confusing output if you did this
                        if accumulate in loggerTypes:
                            raise RuntimeError("Can't have two loggers of the same type")
                        loggerTypes[accumulate]=True

                        loggersList.append({'interval':interval, 'accumulate':accumulate,'historyLength':historyLength})

                for i in list(ald.keys()):
                    #Changing name to empty
                    #Setting an alarm to  none is how  you delete it  
                    if 'name' in ald[i]:
                        if not ald[i]['name'].strip():
                            ald[i]=None

                        #Rename
                        elif ald[i]['name'] !=  i:
                            ald[ald[i]['name']] =  ald[i]
                            del  ald[i]

                data['alarms']=ald
                data['loggers']=loggersList

                data['permissions']= [data['readPerms'],data['writePerms'],data['apiPriority'] ]
                
                del data['readPerms']
                del data['writePerms']
                del data['apiPriority']

                tagpoints.configTagFromData(tagName,data)
            
            raise cherrypy.HTTPRedirect("/tagpoints/"+ util.url(tagName))

        if tagName in tagpoints.allTags:
            tag=tagpoints.allTags[tagName]()
        else:
            tag=tagpoints.Tag(tagName)
    #normalize
    normalizednormalizedTagName=tag.name

    configData = tagpoints.configTagData.get(normalizednormalizedTagName,{})
    ald= configData.get('alarms',{})


    
    
        

    if hasattr(tag, 'kweb_manualOverrideClaim'):
        x  = tag.kweb_manualOverrideClaim
        orval = x.value
        orprio=x.priority
        orname =x.name
    else:
        orval=''
        orprio=90
        orname="config"


    eald = tag.effectiveAlarmData

    # Use to show the placeholders for what you'll get if you blank out something
    defaultAlarmData = collections.defaultdict(lambda: {})
    defaultAlarmData.update(tag.dynamicAlarmData)
    


%>
<title>${normalizednormalizedTagName|h}</title>
<script src="/static/widget.js"></script>
<h2>Tag Point: <small>${normalizednormalizedTagName}</small></h2>
<div class="sectionbox">
<p class="help">
    This page manages one tagpoint. To save configured defaults you must save the server state
    to disk.  The important thing to know about tag points is that they have two configurations: runtime and configured.

    Runtime is set directly in code, but can be overridden on a per-setting basis bu configuration set through the web UI.
    When you remove a configured alarm or logger, it goes away, and returns to the config set in code, if any.
</br>

    Changing the default value will only take effect if the tag's value has never been set any other way(data timestamp==0)
</br>

<b>Tags dissapear if there are neither any references in code, nor any config vals set!</b></p>
<form method="POST" action="/tagpoints/${normalizednormalizedTagName|u}">

<h3>Override/Fixed Value</h3><p class="help">
    You can use an =expression as the value to create a dynamic getter.  The expression polls at the tag's interval if there are any subscribers, just like any other getter.
    if you use tv('tagName') or stv('stringTagName') in your expression, it will also re-evaluate when any of the tags you use change.  As with alarms,
    you have access to kaithem, random, math, and numpy, plus dateutil and dateutil.parser.
</p>
<table border="1">
    <tr>
        <td>Claim Name</td>
        <td><input name="overrideName" value="${configData.get('overrideName','')|h}" placeholder="config"></td>
    </tr>
    <tr>
        <td>Claim Value(Blank for no Override)</td>
        <td><input name="overrideValue" value="${configData.get('overrideValue','')|h}"  style="width:80em; max-width: 60vw;"></td>
    </tr>
    <tr>
        <td>Claim Priority</td>
        <td><input  name="overridePriority" value="${int(configData.get('overridePriority','90'))|h}" placeholder="90"></td>
    </tr>
</table>




<h3>MQTT Sync</h3><p class="help">
    You can sync a tag's value using MQTT.  Configuring this overrides any sync settings set in code.
    To use this, you must configure an MQTTConnection in the devices manager, and set the tag's message bus name to match.
    If you do not set a topic,  it will use /tagpoints/TAGNAME.

</p>
<table border="1">
    <tr>
        <td>Message Bus Name</td>
        <td><input name="mqtt.messageBusName" value="${configData.get('mqtt.messageBusName','')|h}" placeholder="config"></td>
    </tr>
    <tr>
        <td>MQTT Topic(blank for default)</td>
        <td><input name="mqtt.topic" value="${configData.get('mqtt.topic','')|h}""></td>
    </tr>

    <tr>
        <td>Incoming Message Priority(Default 50)</td>
        <td><input name="mqtt.incomingPriority" value="${configData.get('mqtt.incomingPriority','50')|h}""></td>
    </tr>
</table>



<h3>Description</h3>
${tag.description or "No description set"}

<h3>Info</h3>
<table border="1">
    <tr>
        <td>Time Since Update</td>
        <td>${((unitsofmeasure.formatTimeInterval(time.monotonic()-tag.timestamp,3)+" ago") if int(tag.timestamp) else 'never')}</td>
    </tr>
    <tr>
        <td>Timestamp(monotonic time)</td>
        <td>${tag.timestamp}</td>
    </tr>
    <tr>
        <td>Annotation</td>
        <td>${tag.annotation|h}</td>
    </tr>
    <tr>
        <td>Active Claim</td>
        <td>${tag.activeClaim().name}(P${tag.activeClaim().priority})</td>
    </tr>
    <tr>
        <td>Value at page load</td>
        <td>${(str(tag.value)[:128]) if not isinstance(tag.value,bytes) else str(len(tag.value)) +" bytes of binary"}</td>
    </tr>
    <tr>
        <td>Owner</td>
        <td>${tag.owner}</td>
    </tr>
    <tr>
        <td>Subscriber count</td>
        <td>${len(tag.subscribers)}</td>
    </tr>

    <tr>
        <td>WebAPI read perms</td>
        <td>${tag.getEffectivePermissions()[0]}</td>
    </tr>

    <tr>
        <td>WebAPI write perms</td>
        <td>${tag.getEffectivePermissions()[1]}</td>
    </tr>

    <tr>
        <td>WebAPI priority</td>
        <td>${tag.getEffectivePermissions()[2]}</td>
    </tr>

    <tr>
        <td>Python3 Object ID</td>
        <td>${id(tag)|h}</td>
    </tr>

    %if hasattr(tag,'unit'):
    <tr>
        <td>Base Unit</td>
        <td>${tag.unit|h}</td>
    </tr>
    %endif

    %if tag.originEvent:
    <tr>
        <td>Created in Event</td>
        <td>${str(tag.originEvent)|h}</td>
    </tr>
    %endif
</table>


<h3>Value</h3>
<p class="help">
    The default value affects tags immediately when created, when they have never been set by anything else.
    Changes will not take effect immediately if the tag has already been set.
    Default values cannot be =expressions.
</p>
<table border="1">
    <tr>
        <th>Default</th>
        <th>Current</th>
    </tr>
    <tr>

<td><input name="value" value="${configData.get('value','')}"></td>

%if tag and isinstance(tag,tagpoints._NumericTagPoint):
    %try:
    <td>${tag.meterWidget.render()}</td>
    %except Exception as e:
    ${e|h}</td>
    %endtry

%elif tag and isinstance(tag,(tagpoints._StringTagPoint, tagpoints._ObjectTagPoint)):
    <td>${tag.spanWidget.render()}</td>

%else:
    <td>No live preview</td>
%endif

%if tag==None:
<td>DELETED</td>
%endif
</tr>
</table>

<h3>Basic Config</h3>
<p class="help">If you do not configure a type, the tag will not exist until requested via code.</p>
<table border="1">
<tr>
    <th>Type/Create As</th>
    <th>Interval</th>
    <th>Min</th>
    <th>Max</th>
    <th>hi</th>
    <th>lo</th>
    <th>displayUnits</th>
</tr>
<tr><th>Current Values</th></tr>

%if tag and isinstance(tag,tagpoints._NumericTagPoint):
<tr>
    <td>${tag.type|h}</td>
    <td>${tag.interval}</td>
    <td>${tag.min}</td>
    <td>${tag.max}</td>
    <td>${tag.hi}</td>
    <td>${tag.lo}</td>
    <td>${tag.displayUnits}
</tr>
%endif

%if tag and isinstance(tag,(tagpoints._StringTagPoint, tagpoints._ObjectTagPoint)):
<tr>
    <td>${tag.type}</td>
    <td>${tag.interval}</td>
    <td>${tag.min}</td>
    <td>${tag.max}</td>
    <td>NA</td>
    <td>NA</td>
    <td>NA</td>
</tr>
%endif

%if tag==None:
<tr>
    <td>DELETED</td>
    <td>DELETED</td>
    <td>DELETED</td>
    <td>DELETED</td>
    <td>DELETED</td>
    <td>DELETED</td>

</tr>
%endif
<tr><th>Configured Values(Leave blank for default)</th></tr>
<tr>
    <td>
        <%
            # pre-set the configured type, if we got to this page by clicking the new tag button to make a specific type.
            configType= configData.get('type','')

            if new_strtag:
                configType='string'
            if new_numtag:
                configType='number'
        %>
        <select name="type">
            <option value="" ${'selected' if configType=='' else ''}>No setting/Create in code </option>
            <option value="string" ${'selected' if configType=='string' else ''}>String</option>
            <option value="number" ${'selected' if configType=='number' else ''}>Number</option>
            <option value="object" ${'selected' if configType=='object' else ''}>Object</option>
        </select>

    </td>
    <td><input name="interval" value="${configData.get('interval','')}" style="width:6em"></td>
    <td><input name="min" value="${configData.get('min','')}" style="width:6em"></td>
    <td><input name="max" value="${configData.get('max','')}" style="width:6em"></td>
    <td><input name="hi" value="${configData.get('hi','')}" style="width:6em"></td>
    <td><input name="lo" value="${configData.get('lo','')}" style="width:6em"></td>
    <td><input name="displayUnits" value="${configData.get('displayUnits','')}" style="width:6em"><td></td>
</tr>


</table>


<h3>WebAPI exposure</h3>
<div class="help">

    <p>This section allows you to directly expose tags via the WebSockets API, for use in places like the integratedFreeBoard Dashboard creator. </p>

    <p>Empty read perms disable exposing the tag, unless it is exposed via code.   
        Any values set here override those in code, blank values default to the one set in code.  
        These settings control access to the tag in the FreeBoard dashboard creator</p>

<p>At least one read permisson has to be defined to enable the api, even if there are write permissions, so write-only tags are not possible. Empty fields disable exposure, unless settings
    are iunherited from runtime
</p>

<p>Permissions are a comma separated list, The user must have all of them</p>

<p>Tags can be exposed in code with tag.expose(), but config overrides runtime on a per-field basis.</p>
    
<>To un-expose something wth an exposed runtime config, use the special permission __never__ to disallow all users.</p>
</div>


<table border="1" style="max-width: 30em;">
    <tr>
        <td>Read Permissions</td>
    
    <td>
        <input name="readPerms" value="${configData.get('permissions',['','',''])[0] |h}" placeholder="${tag.getEffectivePermissions()[0]|h}" style="width:24em">
    </td>
    </tr>

    <tr>
        <td>Write Permissions(comma separated, empty for admin-only)</td>
    
    <td>
        <input name="writePerms" value="${configData.get('permissions',['','',''])[1]|h}" placeholder="${tag.getEffectivePermissions()[1]|h}" style="width:24em">
    </td>
</tr>
    <tr>
        <td>Priority of claims set by the API</td>
   
    <td>
        <input name="apiPriority" value="${configData.get('permissions',['','',''])[2]|h}" placeholder="${tag.getEffectivePermissions()[2]|h}" style="width:24em">
    </td>
 </tr>
</table>


<h3>Alerting</h3>
<div class="help"><p>Setting blank name deletes that alarm. Conditions are python expressions that can use the tag itself(tag), the value(value),
     and the kaithem object.  Conditions are regular subscribers and can poll at the tag's interval.</p>

<p>You cannot delete hardcoded alarms, but you can disable by setting the condition to False or 0</p>

<p>You can also use tv('name') to get any numeric tag value by name inside your expressions, stv('name') to get string tags, and np to access numpy. You also have
    math, random, re, and dateutil.parser.
</p>

<p>Kaithem tracks the tags you use in this way, and the alarms will re-evaluate when needed.</p>

</div>

<table border=1>
    <tr>
        <th>Name</th>
        <th>Condition</th>
        <th>Release Condition</th>
        <th>Priority</th>
        <th>autoAck</th>
        <th>Trip Delay</th>
        <th>State</th>
    </tr>
    

%for i in eald:
<tr>
    %if not i in tag.dynamicAlarmData:
    <td><input name="alarm_${i}:name" value="${i|h}"></td>
    %else:
    <td><input title="Cannot change name of alarm that was created in code, set condition to None to disable" disabled=1 value="${i|h}"></td>
    %endif    
    <td><input name="alarm_${i}:condition" value="${ald.get(i,{}).get('condition','')|h}" placeholder="${defaultAlarmData[i].get('condition','')}" style="width:24em"></td>
    <td><input name="alarm_${i}:releaseCondition" value="${ald.get(i,{}).get('releaseCondition','')|h}" placeholder="${defaultAlarmData[i].get('releaseCondition','when tripCondition is False')}" style="width:24em"></td>
    <td>
        <select name="alarm_${i}:priority"  style="width:6em">
            <option value="" ${'selected' if ald.get(i,{}).get('priority')=='' else ''}>unchanged/default(${eald[i].get('priority','warning')})</option>
            <option value="debug" ${'selected' if ald.get(i,{}).get('priority')=='debug' else ''}>debug</option>
            <option value="info" ${'selected' if ald.get(i,{}).get('priority')=='info' else ''}>info</option>
            <option value="warning" ${'selected' if ald.get(i,{}).get('priority')=='warning' else ''}>warning</option>
            <option value="error" ${'selected' if ald.get(i,{}).get('priority')=='error' else ''}>error</option>
            <option value="critical" ${'selected' if ald.get(i,{}).get('priority')=='critical' else ''}>critical</option>
        </select>
    </td>
    <td><input name="alarm_${i}:autoAck" value="${ald.get(i,{}).get('autoAck','')|h}" placeholder="${defaultAlarmData[i].get('autoAck','False')}" style="width:4em"></td>
    <td><input name="alarm_${i}:tripDelay" value="${ald.get(i,{}).get('tripDelay','')|h}" placeholder="${defaultAlarmData[i].get('tripDelay','0')}" style="width:6em"></td>

    %if i in tag.alarms:
    <td style="background-color: ${'lightgreen' if tag.alarms[i].sm.state=='normal' else 'yellow'};">${tag.alarms[i].sm.state}</td>
    %else:
    <td>Null Alarm</td>
    %endif

</tr>
%endfor

<tr>
    <td><input name="alarm_NEW:name" placeholder="New Alarm Name"></td>
    <td><input name="alarm_NEW:condition" placeholder="New Alarm Condition"></td>
</tr>

</table>

<h3>Loggers</h3>
<p class="help">These loggers control the logging of tag data to history.db</br>
Interval is the maximum rate to log at. No logs are created if there are no changes. Tags that change more often than the interval will always 'flush' the most recent value after sufficient time.</br>
Accumulate determines what happens to multiple readings within an interval.  To store the latest, use latest. To store the mean for the whole interval, use average.</br>
Set the interval to 0 to delete the logger. Set history length to 0 to disable deleting old data.</p>


<table border=1>
    <tr>
        <th>Interval(s)</th>
        <th>Accumulate Mode</th>
        <th>Keep History</th>
    </tr>
    %for n,i in enumerate(configData.get('loggers',[]) + [{'interval':0, 'accumulate': 'latest'}]):

    <tr>
        <td><input type="number" step="0.1" value="${i['interval']}" name="logger_${n}:interval"</td>
    <td>
        <select name="logger_${n}:accumulate">
            <option value="latest" ${'selected' if i['accumulate']=='latest' else ''}>Latest</option>
            %if isinstance(tag,tagpoints._NumericTagPoint):
            <option value="mean" ${'selected' if i['accumulate']=='mean' else ''}>Average</option>
            <option value="min" ${'selected' if i['accumulate']=='min' else ''}>Minimum</option>
            <option value="max" ${'selected' if i['accumulate']=='max' else ''}>Maximum</option>
            %endif
        </select> 
    </td>
    <td><input type="number" step="1800" value="${i.get('historyLength',3*30*24*3600)}" name="logger_${n}:historyLength"</td>

    </tr>
    %endfor
</table>


%if hasattr(tag, 'configLoggers'):
<h3>Recent Log Data <a href="/tagpointlog/${normalizednormalizedTagName|u}">Full Logs</a></a></h3>

<table border=1>
    <tr><th>Time</th><th>Type</th><th>Val</th></tr>
    %if isinstance(tag,tagpoints._NumericTagPoint):
        %for i in combineLogs({i.accumType:i.getRecent(logtime, time.time(), 15) for i in tag.configLoggers}):
        <tr>
            <td>${i[0]}</td>
            <td>${i[1]}</td>

            %if i[2]>tag.hi or i[2]<tag.lo:
            <td><span class="error">${i[2]}</span></td>
            %else:
            <td>${i[2]}</td>
            %endif

        </tr>
        %endfor
    %else:
        %for i in combineLogs({i.accumType:i.getRecent(logtime, time.time(), 15) for i in tag.configLoggers}):
        <tr>
            <td>${i[0]}</td>
            <td>${i[1]}</td>
            <td>${i[2][:128]}</td>
        </tr>
        %endfor
    %endif
</table>
%endif

<h3>onChange Function</h3>
<p class="help">This has access to the same vars that alerts do. It creates a tag
    subscriber.
</p>
<textarea name="onChange">${configData.get('onChange','')|h}</textarea>
<br>
<input type="submit">
</form>

</div>
<div class="sectionbox"></div>
<h3>Objects Referring to this Tag</h3>
<div class="scrollbox">
<p class="help">Greyed entries may be less interesting and more likely the rendering of this page itself.</p>
<dl>
%for i in gc.get_referrers(obj):
%if not( isinstance(i,dict) and 'UNDEFINED' in i):
<dt><b>${id(i)}</b></dt
    >
<dd
>${util.saferepr(i)|h}
</dd>
%endif


%endfor
</dl>
</div>
<%include file="/pagefooter.html"/>