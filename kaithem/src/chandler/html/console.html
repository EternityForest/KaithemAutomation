<%inherit file="/pagetemplate.html" />
<%!
from kaithem.src.kaithemobj import kaithem
%>

${lists}


<datalist name="nextcueoptions" id="nextcueoptions">
    <option>default</option>
    <option></option>
    <option>__random__</option>
    <option>__shuffle__</option>
    <option>__schedule__</option>
</datalist>


<datalist name="specialcues" id="specialcues">
    <option value="__rules__">All other cues in the scene will inherit rules</option>
</datalist>


<datalist name="lenoptions" id="lenoptions">
    <option>0.25</option>
    <option>1</option>
    <option>2.5</option>
    <option>5</option>
    <option>10</option>
    <option>25</option>
    <option>@2:30PM</option>
    <option>@2:30PM every Friday</option>
</datalist>



<style>
    .grey {
        color: grey;
        font-size: 70%;
    }

    div.hfader {
        border-style: solid;
        border-radius: 5px;
        overflow: auto;
        border-width: 2px;
        border-color: rgba(0, 0, 0, 0.1);
        margin: 3px;
        min-width: 13.5em;
        min-height: 4em;
    }

    div.hfader span.indicator {
        float: right;
    }

    p.scene {
        border-style: solid;
        border-width: 1px;
    }

    .fadersbox {
        display: flex;
    }

    article.universe {
        overflow: auto;
        border-color: grey;
        margin: 3px;
        width: 95%;
        min-width: 16em;
        flex-basis: fit-content;
    }

    article.fixture {
        margin: 3px;
        max-width: 32em;
        flex-basis: min-content;
        min-width: 16em;
    }

    .indicator {
        border-radius: 0.2em;
        display: inline-block;
        width: 0.9em;
        height: 0.9em;
        border-style: dashed;
        border-width: 1.5px;
    }

    .labelbox {
        display: flex;
        flex-wrap: wrap;
    }

    .break {
        flex-basis: 100%;
        height: 0;
    }

    .blinking {
        animation: blinkingText 1s infinite;
    }

    @keyframes blinkingText {
        0% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.5;
        }
    }

    .multibar>* {
        display: inline-flex;
    }
</style>

<script src="/static/js/thirdparty/vue3.js"></script>

<script src="/static/js/thirdparty/sortable.min.js"></script>

<script type="text/javascript" src="/static/js/widget.js"></script>
<script src="/static/js/thirdparty/keyboard.min.js"></script>
<script src="/static/js/thirdparty/js-yaml.min.js"></script>
<script src="/static/js/thirdparty/strftime-min.js"></script>


<div id="app" v-cloak class="flex-row gaps">
    <section id="optionsblock" class="multibar undecorated w-full">

        <div class="menubar tool-bar">
            <p>{{clock}} </p><p><b>{{boardname}}</b></p>
            <button type="button" v-on:click="saveToDisk()"  :disabled="no_edit"
                title="Save the current state now.  If not manually saved, autosave happens every 10min"><i
                    class="mdi mdi-content-save"></i>Save</button>
            <button type="button" v-on:click="showimportexport=!showimportexport"><i
                        class="mdi mdi-folder-open"></i>Import/Export</button>
        </div>


        <div class="menubar tool-bar">
            <button type="button" v-on:click="showPresets=!showPresets"><i class="mdi mdi-palette"></i>Presets</button>
            <button type="button" v-on:click="showevents=!showevents"><i class="mdi mdi-flag"></i>Events</button>

            <button type="button" v-on:click="showslideshowtelemetry=!showslideshowtelemetry"><i
                        class="mdi mdi-monitor"></i>Displays</button>
            <a class="button" href="/chandler/config/${boardname}"><i class="mdi mdi-cog-outline"></i>Settings</a><label>
            <i class="mdi mdi-volume-medium"></i><input type="checkbox" class="toggle" v-model="uiAlertSounds">
            </label>
            <button type="button" onclick="document.documentElement.requestFullscreen()"><i
                class="mdi mdi-arrow-expand-all"></i></button>
        </div>

        <div class="menubar tool-bar">
            <p><b>Keys:</b></p>
            <button type="button" v-on:click="editMode" v-bind:class="{highlight:keybindmode=='edit'}"><i
                    class="mdi mdi-pencil"></i>Edit Mode</button>
            <button type="button" v-on:click="runMode" v-bind:class="{highlight:keybindmode=='run'}"><i
                    class="mdi mdi-flag"></i>Send Events</button>
        </div>

    </section>

    <main class="w-full flex-row">
        <section class="window w-full max-h-12rem" v-if="Object.keys(sys_alerts).length">
            <div class="flex-row scroll gaps padding">
                <div class="card" v-for="v,i of sys_alerts">
                    <header :class="v['barrel-class']" class="padding">
                        <i class="mdi mdi-alert"></i>{{i}}
                    </header>
                    <p :class="v['barrel-class']">{{v.message|| 'no trip message'}}</p>
                </div>
            </div>
        </section>
        <section class="window margin w-sm-full flex-col gaps h-48rem" style="resize:both; padding-bottom: 1px;">
            <header>
                <div class="decorative-image-h-bar decorative-image" style="min-height: 3em; margin: auto;"></div>

                <div class="tool-bar">
                    <input size=8
                        title="Enter a cue's shortcut code here to activate it. Keybindings are suspended while this is selected."
                        aria-label="Shortcut code" placeholder="Shortcut" v-model="sc_code"
                        v-on:keydown.enter="shortcut()" v-on:focus="keyboardJS.pause();"
                        v-on:blur="keyboardJS.resume();"></input>
                    <button type="button" v-on:click="shortcut()">Go!</button>
                </div>
                <div class="tool-bar">
                    <input v-model="scenefilter" placeholder="Search" list="tracks" /><button
                        v-on:click="scenefilter=''"><i class="mdi mdi-backspace"></i>
                    </button>
                    <button type="button" v-on:click="showPages=!showPages">Compact</button>

                </div>
            </header>

            <div class="h-24rem scroll">
                <div class="flex-col gaps">
                    <article v-for="i in formatAllScenes" style="position:relative;"
                        v-bind:class="{'scene':1, card:1, 'grey':i[1].doingHandoff, 'run':i[1].active &(!i[1].doingHandoff)}"
                        style="border-style:solid; border-width:1px;">
                        <header>
                            <div>
                                <h4>
                                    <button type="button" v-bind:class="{highlight:i[0]==scenename}"
                                        v-on:click="selectscene(i[1],i[0])" style="width: 100%">

                                        <span style="font-size: 150%;">{{i[1].name}}</span><span v-if="i[1].ext"
                                            class="grey">
                                            (external)</span>

                                        <i class="mdi mdi-wifi" v-if="i[1].mqttServer" title="This scene uses MQTT"></i>
                                    </button>
                                </h4>

                            </div>
                        </header>
                        <p>

                            <span v-if="i[1].active && cuemeta[i[1].cue]">{{cuemeta[i[1].cue].name}}
                                <small>{{formatTime(i[1].enteredCue)}}</small></span>
                            <span v-if="cuemeta[i[1].cue].sound"><i class="mdi mdi-music"></i></span>


                            <span v-if="cuemeta[i[1].cue].inheritRules" title="This cue has rules inherited"
                                v-on:click="selectcue(scenename,cuemeta[i[1].cue].name)"><i
                                    class="mdi mdi-script-text-outline"></i></span>
                            <span v-if="cuemeta[i[1].cue].rules && cuemeta[i[1].cue].rules.length>0"
                                title="This cue has rules attatched"
                                v-on:click="selectcue(scenename,cuemeta[i[1].cue].name)"><i
                                    class="mdi mdi-script-text-outline"></i></span>
                        </p>
                        <p class="warning" v-if="i[1].status">STATUS: {{i[1].status}}</p>


                        <div class="tool-bar noselect" v-if="!i[1].utility">
                            <button type="button" :class="{'success':i[1].active, 'warning':i[1].status}" v-on:click="go(i[0])"><i
                                    class="mdi mdi-play"></i>Go!</button>
                            <button type="button" v-on:click="prevcue(i[0])"><i class="mdi mdi-skip-previous"></i>Prev</button>
                            <button type="button" v-on:click="nextcue(i[0])">Next<i class="mdi mdi-skip-next"></i></button>
                            <button type="button" class="stopbutton" v-on:click="stop(i[0])"><i
                                    class="mdi mdi-stop-circle-outline"></i>Stop</button>
                        </div>
                        <iframe v-if="showPages && i[1].infoDisplay.length>0" :src="i[1].infoDisplay"></iframe>

                        <div class="tool-bar noselect" v-if="i[1].eventButtons.length > 0">
                            <button type="button" v-for="v of i[1].eventButtons" v-on:click="sceneev(v[1],v[1])">{{v[0]}}</button>
                        </div>


                        <smooth-range style="margin-left:0.4rem" v-if="!i[1].utility"
                            max="1" step="0.01" min="0"
                            v-on:input="setalpha(i[0],parseFloat($event.target.value));"
                            v-model="alphas[i[0]]"></smooth-range>

                        <scene-ui :unixtime="unixtime" v-bind:scene-data="i[1]" :cue="cuemeta[i[1].cue]"></scene-ui>


                        <div class="w-full flex">
                            <cue-countdown :scene="i[1]" :cue="cuemeta[i[1].cue]"></cue-countdown>
                            <small><span v-if="(i[1].active && (''+cuemeta[i[1].cue].length).indexOf('@')>-1)"><i
                                        class="mdi mdi-clock-outline"></i>{{cuemeta[i[1].cue].length.substring(1)}}</span></small>
                        </div>

                        <footer>
                            <span v-if="cuemeta[i[1].cue]&&(cuemeta[i[1].cue].next||cuemeta[i[1].cue].defaultnext)">Next
                                Cue:
                                {{cuemeta[i[1].cue].next||cuemeta[i[1].cue].defaultnext}}</span>

                            <small v-if="i[1].blend!=='normal'">Blend:<b>{{i[1].blend}}</b></small>
                            <small
                                v-if="cuemeta[i[1].cue]&&(cuemeta[i[1].cue].sound)"><br>Sound:<b>{{cuemeta[i[1].cue].sound.match(/([^\/]+)$/)[1]}}</b></small>
                        </footer>
                    </article>
                </div>
            </div>


            <footer class="padding">
                <div class="tool-bar">
                    <input :disabled="no_edit" v-model="newscenename" placeholder="New scene name" size="4">
                    <button type="button" data-testid="add-scene-button" v-on:click="addScene()"><i class="mdi mdi-plus"></i>Add</button>
                </div>
            </footer>

        </section>

        <section class="window margin" v-if="showevents" class="flex-item"
            style="position:fixed; z-index:99; bottom:0px; width:78%;">
            <h2> <button type="button" v-on:click="showevents=0"><i class="mdi mdi-close"></i>Close</button>Event
                Log
            </h2>
            <input v-model="evfilt" placeholder="Filter events"><br>
            <div class="max-h-12rem scroll border" style="height:6em">
                <div v-bind:class="{'evlisting': i[0]!=='error', 'evlisting_err': i[0].includes('error')}"
                    v-for="i in evlog.filter((d) => (d[1].search(evfilt)>-1 || d[0].search(evfilt)>-1) )">{{i[2]}}:
                    <b>{{i[0]}}</b>
                    at
                    {{i[1]}}:

                    <span v-if="!(typeof(i[3])=='string' && i[3].length>32)">{{i[3]}}</span>
                    <pre v-if="(typeof(i[3])=='string' && i[3].length>32)">{{i[3]}}</pre>
                    <pre v-if="i[4]">{{i[4]}}</pre>
                </div>
            </div>

            <label>Send Global Event:
                <input :disabled="no_edit" v-model="evtosend" v-on:keydown.enter="sendev" placeholder="Event Name" title="Event Name">
            </label>

            <input :disabled="no_edit" v-model="evval" v-on:keydown.enter="sendev" title="Event Value" placeholder="value">

            <select v-model="evtypetosend">
                <option value="int">Integer</option>
                <option value="float">Real Number</option>
                <option value="str">Text</option>
            </select>

            <button type="button" v-on:click="sendev('__global__')">Send</button>
        </section>





        <section v-if="showslideshowtelemetry" class="flex-item window paper h-24rem">
            <header>
                <div class="tool-bar">
                    <h3>Slideshow Players</h3>
                    <button type="button" v-on:click="showslideshowtelemetry=!showslideshowtelemetry"><i class="mdi mdi-close"></i>Close</button>
                </div>
            </header>
                <p>This table shows the slideshow displays that are active or seen recently.</p>
                <p>Only one display per IP/scene can be shown.  Battery status only works in Chrome</p>
                <p>Ding plays a tone to identify and test the display.  You can assign displays friendly names to help identify them.</p>
                <p>Be careful with refresh! Some browsers may respond badly if the network is messed up.</p>

                <table>
                <tr>
                    <th>
                        Connection
                    </th>
                    <th>
                        Name
                    </th>
                    <th>Status</th>
                    <th>Last Seen</th>
                    <th>Battery</th>
                    <th>Action</th>
                </tr>
                <tr v-for="v,i of slideshow_telemetry" :class="{'error': v.ts<(unixtime-70)}">
                    <td>{{i}}</td>
                    <td>{{v.name}}</td>
                    <td :class="{'error': v.status.includes('FAIL')}">{{v.ts<(unixtime-70)?'LOST CONNECTION':v.status}}</td>
                    <td>{{formatTime(v.ts)}}</td>
                    <td :class="{'error': (v.battery||{}).charging == false}">{{v.battery || ''}}</td>
                    <td>
                        <button type="button" @click="mediaLinkCommand(v.scene, v.id, ['testAudio'])">Ding</button>
                        <button type="button" @click="promptRenameDisplay(v.scene, v.id)">Rename</button>
                        <button type="button" @click="mediaLinkCommand(v.scene, v.id, ['refresh'])">Refresh</button>
                    </td>

                </tr>
            </table>
        </section>

        <section v-if="showimportexport" class="flex-item window paper h-24rem">
            <header>
                <div class="tool-bar">
                    <h3>Import/Export controls</h3>
                    <button type="button" v-on:click="showimportexport=!showimportexport"><i class="mdi mdi-close"></i>Close</button>

                </div>
            </header>

            <p>Setup files include all fixture types,
                fixture assignments, configured universes,
                and color presets.</p>

            <div class="tool-bar" style="padding:0.25em; border-width:2px;">
                <p>Download:</p>
                <button type="button" @click="downloadSetup()" title="Download your scenes as a file"><i
                        class="mdi mdi-content-save"></i>Setup</button>
            </div>

            <div class="tool-bar" style="padding:0.25em; border-width:2px;">
                <p>Load Setup:</p>
                <input type="file" id="setupfile">
                <button type="button" @click="uploadFileFromElement('setupfile', 'setup')" title="Upload a scenes file"><i
                        class="mdi mdi-folder-open"></i>Go</button>
            </div>
        </section>

        <section v-if="showPresets" class="flex-item window paper" style="width: 32em;">
            <h3>Presets<button type="button" v-on:click="showPresets=0">
                    <i class="mdi mdi-close"></i>Close</button>
            </h3>
            <details class="help">
                <summary>Help</summary>
                A preset is a set of values that may be quickly applied to any feature.
                Create them in the cue values section. They are loaded and saved with the "setup" file.
                Empty fields in a preset have no effect, they leave that value alone, so you can, for example,
                make a preset that sets the color without setting the XY values.
            </details>
            <dl>
                <template v-for="ps, i of dictView(presets,[])">
                    <dt>
                        <div class="tool-bar">
                            <h4>{{ps[0]}}</h4>
                            <button type="button" v-on:click="deletePreset(ps[0])"><i class="mdi mdi-delete"></i>Delete</button>
                            <button type="button" v-on:click="renamePreset(ps[0])"><i class="mdi mdi-pencil"></i>Rename</button>
                        </div>
                    </dt>
                    <dd style="display: flex; flex-wrap: wrap;">
                        <label v-for="val, field of ps[1]">
                            {{field}}<input :disabled="no_edit" v-model="ps[1][field]"
                                v-on:change="ps[1][field]=$event.target.value.trim();updatePreset(ps[0],ps[1]);">
                        </label>
                    </dd>
                </template>

            </dl>
        </section>




        <dialog id='soundpreviewdialog'>
            <iframe id="textpreview" style="height:24em; width: 24em;"></iframe>
            <audio controls id="soundpreview"></audio>
            <button type="button" v-on:click="closePreview">OK</button>
        </dialog>


        <section class="flex-item window paper margin padding" v-if="!(editingScene && cuemeta[editingScene.cue])"
            style="display:inline-block;  max-width:98vw; resize:both; overflow:auto;">
            <h2>No Scene selected</h2>
        </section>


        <section class="window paper margin" v-if="editingScene && cuemeta[editingScene.cue]">
            <header>

                <p class="warning" v-if="editingScene.status">STATUS: {{editingScene.status}}</p>
                <div class="tool-bar">
                    <h3><span v-on:dblclick="promptRename(scenename)" title="Double click to set scene name">
                            {{editingScene.name}}</span>
                        <small class="success" v-if="editingScene.active"> (running)</small>


                    </h3>
                    <button type="button" v-if="editingScene.cuelen" v-on:click="addTimeToScene(editingScene.id)"><i class="mdi mdi-clock"></i></i><i class="mdi mdi-plus"></i>Add Time</button>

                    <p>
                        <input v-model="cuefilter" placeholder="Search Cues" />
                        <button type="button" v-on:click="cuefilter=''"><i class="mdi mdi-backspace"></i></button>
                    </p>

                    <button type="button" v-on:click="delscene(scenename)"><i class="mdi mdi-delete"></i>Delete Scene</button>


                </div>
            </header>


            <div id="cuesbox">

                <div style="overflow-y: auto;max-height:12em;">
                    <table class="reflow w-full" border="1">

                        <thead>
                            <tr>
                                <th title="Click the cue name to edit that cue">Name</th>
                                <th class="desktop-only">Shortcut</th>
                                <th class="desktop-only">Fadein</th>
                                <th class="desktop-only" title="Length, 0 indicates until stopped">Length</th>
                                <th title="The next cue, after this one ends">Next</th>
                                <th class="desktop-only">Track</th>
                                <th>Jump to</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr v-for="i in formatCues"
                                v-bind:class="{'highlight' : selectedCues[scenename]==i[1].name}">
                                <td class="rowname" data-label="Cue: " style=" user-select: none;"
                                    title="Click the cue name to edit that cue"
                                    v-on:click="selectcue(scenename,i[1].name)">

                                    <i v-if="cuemeta[editingScene.cue].name==i[1].name"
                                        class="mdi mdi-arrow-right-bold-outline nomargin"></i>


                                    <span title="Cue number, double click to change." style="width:6em; margin: 6px"
                                        v-on:dblclick="promptsetnumber(i[1].id)">{{i[1].number}}</span>


                                    <span>{{i[1].name}}</span>

                                    <span  title="Checkpoint Cue" v-if="i[1].checkpoint" class="mdi mdi-star-four-points-outline"></span>

                                    <span v-if="selectedCues[scenename]==i[1].name"><i
                                            class="mdi mdi-pencil nomargin"></i></span>

                                    <i class="mdi mdi-light-bulb nomargin" v-if="i[1].hasLightingData"
                                        title="This cue has lighting commands"></i>

                                    <i class="mdi mdi-audio nomargin" v-if="i[1].sound"></i>
                                    <i class="mdi mdi-monitor nomargin" v-if="i[1].slide"></i>

                                    <span v-if="i[1].inheritRules" title="This cue has rules inherited"><i
                                            class="mdi mdi-script-text-outline nomargin"></i></span>

                                    <span v-if="i[1].rules && i[1].rules.length>0"
                                        title="This cue has rules attatched"><i
                                            class="mdi mdi-script-text-outline nomargin"></i></span>

                                    <i v-if="cuemeta[editingScene.cue].name==i[1].name"
                                            class="mdi mdi-arrow-left-bold-outline nomargin"></i>

                                </td>


                                <td class="desktop-only" data-label="Shortcut:">
                                    <div class="tool-bar" style="width: 8em;">
                                        <input :disabled="no_edit" title="Shortcut code" style="max-width: 4.5em;"
                                            v-on:change="apiCommand(i[1].id,'setshortcut',$event.target.value)" min=0
                                            step=0.1 v-model="i[1].shortcut">
                                        <button type="button" style="opacity:0.3"
                                            title="Generate a shortcut code from the cue's number"
                                            v-on:click="apiCommand(i[1].id,'setshortcut','__generate__from__number__')">GEN</button>
                                    </div>
                                </td>

                                <td class="desktop-only" data-label="Fade In:">
                                    <input :disabled="no_edit" type="number" v-on:change="setfadein(i[1].id,$event.target.value)"
                                        style="width:3em" min=0 v-model="i[1].fadeIn">
                                </td>

                                <td class="desktop-only" data-label="Length:">
                                    <input :disabled="no_edit" v-on:change="setlength(i[1].id,$event.target.value)" class="w-12rem"
                                        list="lenoptions" v-model="i[1].length">
                                </td>

                                <td data-label="Next Cue:">
                                    <select style="width:98%" v-model="i[1].next"  :disabled="no_edit"
                                        v-if="Object.keys(scenecues[scenename]).length<600" autocomplete=off
                                        title="Select a cue to activate when this one ends"
                                        v-on:change="setnext(i[1].id,$event.target.value)">
                                        <option value="">&gt&gt&gt</option>
                                        <option v-for="j in formatCues" v-bind:value="j[1].name">{{j[1].number}}:
                                            {{j[1].name}}</option>
                                        <option v-bind:value="i[1].next">{{i[1].next}}</option>

                                        <option value="__random__">RANDOM</option>
                                        <option value="__shuffle__">SHUFFLE</option>
                                        <option value="__schedule__">Skip to Schedule</option>

                                    </select>

                                    <input :disabled="no_edit" v-if="Object.keys(scenecues[scenename]).length>40" autocomplete=off
                                        list="cues_in_scene" title="Select a cue to activate when this one ends"
                                        v-on:change="setnext(i[1].id,$event.target.value)" v-model="i[1].next"
                                        v-bind:placeholder="i[1].defaultnext">
                                    </input>
                                </td>


                                <td class="desktop-only" data-label="Track vals from prev: ">
                                    <input :disabled="no_edit" type="checkbox" v-on:change="settrack(i[1].id,i[1].track)"
                                        v-model="i[1].track"
                                        title="Track values from previous cue? If false, values not present are always transparent">
                                </td>
                                <td data-label="Goto:">
                                    <button type="button" style="min-width: 90%;" v-on:click="jumptocue(i[1].id,  editingScene.id)">Go</button>
                                </td>

                            </tr>
                        </tbody>

                    </table>
                </div>

                <div class="tool-bar">
                    <input :disabled="no_edit" v-model="newcuename" placeholder="New cue name" list="specialcues">
                    <button type="button" v-on:click="add_cue(scenename,newcuename)">
                        <i class="mdi mdi-plus"></i>Add Cue</button>
                    <button type="button" v-on:click="clonecue(scenename,currentcueid,newcuename)">
                        <i class="mdi mdi-content-copy"></i>Clone Cue</button>
                    <button type="button" v-on:click="rmcue(currentcueid)">
                        <i class="mdi mdi-delete"></i>Delete Current</button>
                </div>
            </div>

            <hr>


            <div v-if="currentcue">
                <h3><i
                    class="mdi mdi-pencil nomargin"></i>Editing Cue: {{currentcue.name}}</h3>
                <p v-if="currentcue.name.startsWith('__')" class="highlight">Cues starting with __ are special cues.
                    They are never chosen in random selections or as the default next cue and may have predefined system functions attatched.</p>


                <span class="help" v-if="editingScene.ext">This is an external scene that is defined somewhere in code.
                    Any
                    changes made here may be overwritten by the code at any time.</span>

                <details open class="undecorated">
                    <summary>Cue Channel Values</summary>
                    <div class="tool-bar">
                        <button type="button" v-bind:class="{highlight:scenetab=='cue'}" v-on:click="scenetab='cue'"><i
                                class="mdi mdi-cog-outline"></i>Normal View</button>
                        <button type="button" v-bind:class="{highlight:scenetab=='channels'}" v-on:click="scenetab='channels'"><i
                                class="mdi mdi-list-box-outline"></i>Channels</button>
                    </div>
                    <div style="overflow: auto; max-height:30em;" class="fadersbox">
                        <template v-for="(h,uname) in cuevals[currentcueid]">
                            <article class="universe card flex-col gaps" v-if="uname[0]!='@'">
                                <header>
                                    <h3 class="noselect">{{uname}}</h3>
                                </header>
                                <div class="scroll nomargin h-24rem">
                                    <h-fader :i="i" :chinfo="chnamelookup(i.u,i.ch)"
                                        :currentcueid="currentcueid"
                                        :showdelete="scenetab=='channels'" v-for="i in h">
                                    </h-fader>
                                </div>
                            </article>
                        </template>
                        <template v-for="(h,fname) in cuevals[currentcueid]">

                            <article class="fixture card flex-col gaps noselect" v-if="fname[0]=='@'">
                                <header>
                                    <div class="tool-bar">
                                        <h4 :title="lookupFixtureType(fname)">{{fname}}</h4>
                                        <select  :disabled="no_edit"
                                            v-on:change="setFixturePreset(currentcueid, fname, presets[$event.target.value]);$event.target.value='__dummy__'">
                                            <option value="__dummy__">Presets</option>
                                            <option
                                                v-for="ps of dictView(presets,[], function(k,v){if((!k.includes('.') || k.includes(''))){return 1}})"
                                                :value="ps[0]">{{ps[0]}}</option>
                                        </select>
                                        <button type="button" v-on:click="savePreset(h)">Save</button>
                                    </div>
                                    <button type="button" v-if="scenetab=='channels'" v-on:click="rmFixCue(currentcueid, fname)">
                                        <i class="mdi mdi-delete"></i>
                                    </button>
                                </header>
                                <div class="scroll nomargin h-24rem padding-bottom">
                                    <h-fader :i="i" :chinfo="chnamelookup(i.u,i.ch)"
                                        :currentcueid="currentcueid"
                                        :showdelete="scenetab=='channels'" v-for="i in h">
                                    </h-fader>
                                </div>
                            </article>
                        </template>
                        <div v-if="scenetab=='channels'" class="flex-row gaps">
                            <div class="card margin">
                                <header>
                                    <h4>Add Raw Channel</h4>
                                </header>

                                <div class="stacked-form w-24rem">
                                    <label>Universe
                                        <combo-box v-bind:options="useBlankDescriptions(universes)"
                                            v-model="newcueu"></combo-box>
                                    </label>

                                    <label>
                                        Channel
                                        <combo-box v-bind:options="getChannelCompletions(newcueu)"
                                            v-model="newcuevnumber">
                                        </combo-box>
                                    </label>

                                    <button type="button"  :disabled="no_edit" v-on:click="addValToCue()"><i class="mdi mdi-plus"></i>Add Channel to
                                        Cue</button>
                                </div>

                            </div>

                            <div class="card margin">
                                <header>
                                    <h4>Add Tag Point</h4>
                                </header>

                                <div class="stacked-form w-24rem">
                                    <label>Tag
                                        <input
                                            v-model="newcuetag" list="tagslisting"></input>
                                    </label>


                                    <button type="button"  :disabled="no_edit" v-on:click="addTagToCue()"><i class="mdi mdi-plus"></i>Add Channel to
                                        Cue</button>
                                </div>

                            </div>


                            <div class="card margin w-24rem">
                                <header>
                                    <h4>Add Fixture</h4>
                                </header>
                                <div class="scroll">
                                    <table>
                                        <tr v-for="(v,i) in fixtureAssignments">
                                            <td>{{v.universe}}:{{i}} at {{v.channel}}</td>
                                            <td><button type="button" v-on:click="addThisFixToCurrentCue(i,1,1,0)"><i
                                                        class="mdi mdi-plus"></i>Add</button>
                                            </td>
                                            <td><button type="button" v-on:click="addRangeEffect(i)"><i
                                                        class="mdi mdi-plus"></i>Range
                                                    Effect</button>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>

                </details>


                <details class="undecorated">
                    <summary><i class="mdi mdi-script-text-outline"></i>Cue Logic</summary>

                    <div>
                        <h3>Automation Logic</h3>
                        <details class="help">
                            <summary><i class="mdi mdi-help-circle-outline"></i></summary>
                            <p>
                                Here you can create rules that
                                apply whenever the scene is in this cue, to
                                do things like trigger other cues when
                                this one enters or exits.
                            </p>

                            <p>Action parameters can use spreadsheet-style =expressions. The special function tv('name')
                                or stv('name') gets the value of
                                a tag or string tag.
                            </p>

                            <p>The variables "event.name", "event.value", and "event.time" are available to get info on
                                the event that triggered a rule.</p>


                        </details>
                    </div>
                    <div class="card w-sm-full" style="overflow: visible;">
                        <label>Inherit rules from
                            <div style="overflow: visible;">
                                <combo-box  :disabled="no_edit" v-model="currentcue.inheritRules" :disabled="editingScene.name =='__rules__'"
                                    v-on:change="setCueInheritRules(currentcueid, currentcue.inheritRules)"
                                    :options="useBlankDescriptions(scenecues[scenename])"></combo-box>
                            </div>
                            <p>Inherited rules run after directly set rules.</p>
                            <p>If a cue names __rules__ exists, <br> all cues will additionally inherit from that cue.</p>

                        </label>
                    </div>
                    <hr>


                    <script-editor :completers="completers" v-bind:example_events="example_events"
                        v-model="currentcue.rules" @update:model-value="setCueRules(currentcueid, $event);"
                        v-bind:commands="availableCommands" v-bind:scenes="cueNamesBySceneName()"
                        v-bind:pinnedvars="specialvars" v-bind:vars="editingScene.vars"
                        v-bind:parentscene="editingScene.name"
                        :disabled="no_edit"
                        >
                    </script-editor>

                    <div style="display:flex;flex-wrap:wrap;">
                        <div style="border-style:solid;flex-grow:3;margin:0.5em;padding:0.5em;">
                            <h3>Scene Variables</h3>
                            <table border="1">

                                <tr v-for="(v,i) in editingScene.vars">
                                    <td>{{i}}</td>
                                    <td>{{v}}</td>
                                </tr>
                            </table>
                        </div>

                        <div style="border-style:solid;flex-grow:1;margin:0.5em;padding:0.5em;">
                            <h3>Timers</h3>
                            <table border="1" style="width:98%">

                                <tr v-for="(v,i) in editingScene.timers">
                                    <td>{{i}}</td>
                                    <td style="width:8em;"
                                        v-bind:class="{warning:(v-unixtime)<60, blinking:(v-unixtime)<5}">
                                        {{formatInterval((v-unixtime))}}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </details>




                <div>

                    <details class="undecorated">
                        <summary>Cue Sound/Media</summary>

                        <p><a :href="'../webmediadisplay?scene='+editingScene.id">Web Media Display</a></p>

                        <div class="flex-row gaps">

                            <div class="card w-sm-full">
                                <header>
                                    <h3>Cue Sound</h3>
                                </header>
                                <div class="stacked-form">
                                    <label>Sound
                                        <input :disabled="no_edit" placeholder="No sound file" v-model="currentcue.sound"
                                            v-on:change="setSoundfile(currentcueid,currentcue.sound)">
                                    </label>
                                    <label>Web player slide
                                        <input :disabled="no_edit" placeholder="No picture file" v-model="currentcue.slide"
                                            v-on:change="setCueSlide(currentcueid,currentcue.slide)">
                                    </label>

                                    <p>
                                        <label>Sound start
                                            <input :disabled="no_edit" v-model="currentcue.soundStartPosition"
                                                v-on:change="setCueSoundStart(currentcueid,currentcue.soundStartPosition)">s
                                            into
                                            file.
                                        </label>


                                        <label>Media Speed
                                            <input :disabled="no_edit" type="number" v-model="currentcue.mediaSpeed"
                                                v-on:change="setCueMediaSpeed(currentcueid,currentcue.mediaSpeed)">
                                        </label>
                                    </p>

                                    <p>
                                        <label>Windup
                                            <input :disabled="no_edit" type="number" v-model="currentcue.mediaWindUp"
                                                v-on:change="setCueProperty(currentcueid,'mediaWindUp', currentcue.mediaWindUp)">
                                        </label>

                                        <label>Winddown
                                            <input :disabled="no_edit" type="number" v-model="currentcue.mediaWindDown"
                                            v-on:change="setCueProperty(currentcueid,'mediaWindDown', currentcue.mediaWindDown)">
                                        </label>
                                    </p>

                                    <label>Device

                                        <datalist id="soundcards">
                                            <option value="scenewebplayer">Play media file in web player</option>
                                            <option v-for="i of soundCards" v-bind:value="i"></option>
                                            <option value="@auto"></option>
                                            <option value="@pulse:hw:0,0"></option>
                                            <option value="@alsa:hw:0,0"></option>

                                        </datalist>


                                        <input
                                            title="Using mplayer -ao syntax, or one of kaithem's device aliases, set the output device"
                                            v-on:change="setSoundOutput(currentcueid,$event.target.value)"
                                            v-model="cuemeta[currentcueid].soundOutput" placeholder="default"
                                            list="soundcards"></input>
                                    </label>

                                    <p>
                                        <label>Relative length
                                            <input :disabled="no_edit" type="checkbox" title="Cause length to be an offset after sound ends"
                                                v-on:change="setrellen(currentcueid,currentcue.relLength)"
                                                v-model="currentcue.relLength"
                                                title="If checked, the length parameter is interpreted as a delay after the sound cue ends.">
                                        </label>



                                        <label>Fade sound after end
                                            <input :disabled="no_edit" type="number"
                                                v-on:change="setSoundFadeOut(currentcueid,$event.target.value)" min=0
                                                v-model="currentcue.soundFadeOut"
                                                title="Sound should fade out starting when the cue ends, taking this long.">

                                        </label>
                                    </p>

                                    <p>
                                        <label>Sound fadein:
                                            <input :disabled="no_edit" type="number"
                                                v-on:change="setSoundFadeIn(currentcueid,$event.target.value)" min=-1
                                                v-model="currentcue.soundFadeIn"
                                                title="Sound should fade in if starting from, taking this long. Use -1 to override and disable a global scene crossfade.">

                                        </label>

                                        <label>Cue Volume
                                            <input :disabled="no_edit" v-on:change="setCueVolume(currentcueid,$event.target.value)" min=0
                                                v-model="currentcue.soundVolume">
                                        </label>

                                        <label>Loops
                                            <input :disabled="no_edit" title="-1 means forever"
                                                v-on:change="setCueLoops(currentcueid,$event.target.value)" min=-1
                                                v-model="currentcue.soundLoops">
                                        </label>
                                    </p>



                                </div>
                            </div>
                            <div class="w-sm-double flex-col gaps">
                                <div class="card w-full flex-col gaps">
                                    <header>
                                        <h3>Media browser</h3>
                                    </header>
                                    <div class="tool-bar">
                                        <input :disabled="no_edit" v-model="soundsearch" v-on:change="soundsearchresults=[]"
                                            v-on:keyup.enter="doSoundSearch(soundsearch)" placeholder="Filter Sounds"
                                            style="width:60%;">
                                        <button type="button" v-on:click="doSoundSearch(soundsearch)">Search</button>
                                        <button type="button" v-on:click="soundsearch=''">Clear Search</button>
                                    </div>
                                    <div class="scroll h-24rem w-full padding">

                                        <div v-if="soundsearch" class="w-full">
                                            <table border="1" class="w-full">
                                                <tr>
                                                    <th>File</th>
                                                    <th>Action</th>
                                                </tr>
                                                <tr v-for="i in soundsearchresults">
                                                    <td v-bind:title="'Found in'+i[0]">{{i[1]}}</td>
                                                    <td><button
                                                            v-on:click="setSoundfile(currentcueid,(soundsearch.length ? '': soundfilesdir)+i[1])">Set(sound)</button>
                                                        <button
                                                            v-on:click="newCueFromSound(scenename,(soundsearch.length ? '': soundfilesdir)+i[1])">New(sound)</button>
                                                        <button
                                                            v-on:click="previewSound((soundsearch.length ? '': soundfilesdir)+i[1])">Preview</button>
                                                        <button
                                                            v-on:click="setCueSlide(currentcueid,(soundsearch.length ? '': soundfilesdir)+i[1])">Set(slide)</button>
                                                        <button
                                                            v-on:click="newCueFromSlide(scenename,(soundsearch.length ? '': soundfilesdir)+i[1])">New(slide)</button>



                                                    </td>
                                                </tr>
                                            </table>
                                        </div>

                                        <div v-if="soundsearch==''">
                                            <h4>
                                                <a title="View in file manager"
                                                    v-bind:href="'/settings/files'+encodeURI(soundfilesdir)"
                                                    target="_blank">{{soundfilesdir}}</a>
                                            </h4>

                                            <ul class="w-full">
                                                <li v-on:click="setSoundfileDir('')"><a>&ltTOP DIRECTORY&gt</a></li>
                                                <li v-on:click="setSoundfileDir(soundfilesdir)">
                                                    <a><i class="mdi mdi-refresh"></i>Refresh</a>
                                                </li>
                                                <li v-if="soundfilesdir"
                                                    v-on:click="setSoundfileDir(((soundfilesdir.match(/(.*)[\/\\]/)[1]||'').match(/(.*)[\/\\]/)[1]||'')+'/')">
                                                    <a>..</a>
                                                </li>
                                                <li v-on:click="setSoundfileDir(i[0])"
                                                    v-for="i in soundfileslisting[0]">
                                                    <a>{{i[1] || i[0]}}</a>
                                                </li>
                                            </ul>

                                            <table border="1" class="w-full">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 40%;">File</th>
                                                        <th>Action</th>

                                                    </tr>
                                                </thead>
                                                <tr v-for="i in soundfileslisting[1]">
                                                    <td class="w-12rem">{{i}}</td>
                                                    <td><button
                                                            v-on:click="setSoundfile(currentcueid,soundfilesdir+i)">Set</button>
                                                        <button
                                                            v-on:click="newCueFromSound(scenename,soundfilesdir+i)">New</button>
                                                        <button
                                                            v-on:click="previewSound(soundfilesdir+i)">Preview</button>
                                                        <button
                                                            v-on:click="setCueSlide(currentcueid,(soundsearch.length ? '': soundfilesdir)+i)">Set(slide)</button>
                                                        <button
                                                            v-on:click="newCueFromSlide(scenename,(soundsearch.length ? '': soundfilesdir)+i)">New(slide)</button>

                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="max-h-12rem flex-col border card">
                                    <header>
                                        <h4>Sound Outputs</h4>
                                    </header>
                                    <details class="help">
                                        <summary><i class="mdi mdi-help-circle-outline"></i></summary>To use play videos,
                                        you
                                        must
                                        use the web remote display feature. Cue
                                        videos will play in the browser on connected remote displays.
                                    </details>
                                    <div class="scroll">
                                        <dl>


                                            <dt>Web Player</dt>
                                            <dd>
                                                <div class="tool-bar">
                                                    <button
                                                        v-on:click="setSoundOutput(currentcueid,'scenewebplayer')">Set
                                                        for
                                                        Cue</button>
                                                    <button
                                                        v-on:click="setSceneSoundOutput(scenename,'scenewebplayer')">Set
                                                        as
                                                        Scene Default</button>
                                                </div>
                                            </dd>


                                            <template v-for="i of soundCards">
                                                <dt>{{i || "UNSET" }}</dt>
                                                <dd>
                                                    <div class="tool-bar">
                                                        <button type="button" v-on:click="setSoundOutput(currentcueid,i)">Set for
                                                            Cue</button>
                                                        <button type="button" v-on:click="setSceneSoundOutput(scenename,i)">Set as
                                                            Scene
                                                            Default</button>
                                                        <button type="button" v-on:click="testSoundCard(i,0,48000)">Test</button>
                                                    </div>
                                                </dd>
                                            </template>
                                        </dl>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </details>

                    <details class="undecorated">
                        <summary>Cue Text</summary>
                        <textarea v-model="currentcue.markdown" class="w-full h-16rem"
                            @input="setCuePropertyDeferred(currentcue.id, 'markdown', $event.target.value)"
                            @change="setCueProperty(currentcue.id, 'markdown', $event.target.value)">

                        </textarea>
                    </details>

                    <details class="undecorated">
                        <summary>Cue Properties
                        </summary>

                        <div>
                            <div class="flex-row gaps">
                                <fieldset class="stacked-form w-sm-full">
                                    <legend>Basic</legend>
                                    <label>Action</label>
                                    <div class="tool-bar">
                                        <button type="button" v-on:click="promptRenameCue(scenename,currentcue.name)"><i class="mdi mdi-rename-box-outline"></i>Rename
                                            Cue</button>

                                    </div>

                                    <label><span><i class="mdi mdi-pound-box-outline"></i>
                                    Number</span>
                                        <input :disabled="no_edit" type="number" title="Cue number"
                                            v-on:change="setnumber(currentcueid,$event.target.value)" min=0 step=0.1
                                            v-model="currentcue.number">
                                    </label>

                                    <label><i class="mdi mdi-star-four-points-outline"></i>Checkpoint
                                        <input :disabled="no_edit" type="checkbox" v-model="currentcue.checkpoint"
                                        title="At startup, jump to the last checkpoint cue you were in."
                                        v-on:change="setCueProperty(currentcueid,'checkpoint', currentcue.checkpoint)">
                                    </label>
                                </p>
                                    <p>
                                        <label>
                                            <input :disabled="no_edit" type="checkbox" v-on:change="settrack(currentcueid,currentcue.track)"
                                                v-model="currentcue.track"
                                                title="Track values from previous cue? If false, values not present are always transparent">
                                                <span><i class="mdi mdi-arrow-expand-right"></i>Track</span>
                                        </label>

                                        <label><input :disabled="no_edit" title="If false, dissallow entering cue if it's already running"
                                                type="checkbox"
                                                v-on:change="setreentrant(currentcueid,currentcue.reentrant)"
                                                v-model="currentcue.reentrant"><span><i class="mdi mdi-replay"></i>Reentrant</span></label>
                                    </p>


                                    <p>

                                        <label><span><i class="mdi mdi-arrow-down-circle-outline"></i>Shortcut
                                            </span>
                                            <input :disabled="no_edit" title="Shortcut code used to quickly activate a cue" size="8"
                                                v-on:change="apiCommand(i[1].id,'setshortcut',$event.target.value)"
                                                v-model="currentcue.shortcut">
                                        </label>

                                        <label><span><i class="mdi mdi-arrow-right-circle-outline"></i>
                                            Trigger Shortcut</span>
                                            <input :disabled="no_edit" title="When entering this cue, trigger the shortcut in other scenes"
                                                size="8"
                                                v-on:change="settriggershortcut(currentcueid,$event.target.value)"
                                                v-model="currentcue.triggerShortcut">
                                        </label>
                                    </p>
                                    <p>
                                        <label>
                                            <span><i class="mdi mdi-clock-outline"></i>
                                            Fadein</span>
                                            <input :disabled="no_edit" type="number"
                                                v-on:change="setfadein(currentcueid,$event.target.value)" min=0
                                                v-model="currentcue.fadeIn">
                                        </label>
                                        <label><span><i class="mdi mdi-clock-outline"></i>
                                            Length</span>
                                            <input :disabled="no_edit" v-on:change="setlength(currentcueid,$event.target.value)"
                                                v-model="cuemeta[currentcueid].length" min=0></input>
                                        </label>
                                    </p>

                                    <p>
                                        <label><span><i class="mdi mdi-dice-multiple-outline"></i>
                                         Randomize Length</span>
                                            <input :disabled="no_edit" type="number"
                                                v-on:change="setrandomize(currentcueid,$event.target.value)"
                                                title="Randomize the cue length +- this amount"
                                                v-model="cuemeta[currentcueid].lengthRandomize" min=0 step=0.25></input>
                                        </label>
                                        <label><span><i class="mdi mdi-dice-multiple-outline"></i>Probability</span>
                                            <input
                                                title="Probability this cue is selected in random selections. =expressions allowed"
                                                v-on:change="setprobability(currentcueid,$event.target.value)"
                                                v-model="currentcue.probability" placeholder="1">
                                        </label>

                                    </p>
                                    <label><span><i class="mdi mdi-text"></i>Notes</span>
                                        <input :disabled="no_edit" v-on:change="setCueProperty(currentcueid, 'notes', $event.target.value)"
                                            v-model="cuemeta[currentcueid].notes" min=0></input>
                                    </label>

                                </fieldset>

                                <fieldset class="stacked-form w-sm-full">
                                    <legend>Cue Advance</legend>
                                    <label>Next Cue
                                        <div>
                                            <combo-box v-model="cuemeta[currentcueid].next"  :disabled="no_edit"
                                                v-on:change="setnext(currentcueid,cuemeta[currentcueid].next)"
                                                :options="useBlankDescriptions(scenecues[scenename],{'__random__':'','__shuffle__':'Avoid Recent','*':'Wildcard match'})"></combo-box>
                                        </div>
                                    </label>
                                    <p>
                                        <button type="button" v-on:click="gotonext(currentcueid,scenename)">
                                            <i class="mdi mdi-arrow-right"></i>Edit Next</button>
                                        <button
                                            title="If this cue's next does not exist, clone the current cue to be the next, and edit that cue"
                                            v-on:click="clonecue(scenename,currentcueid,currentcue.next)">
                                            <i class="mdi mdi-content-copy"></i>Clone to Next</button>
                                    </p>

                                    <datalist id="cues_in_scene" v-if="Object.keys(scenecues[scenename]).length<50">
                                        <option v-for="i in Object.keys(scenecues[scenename]).sort()" v-bind:value="i">
                                            {{i}}</option>
                                    </datalist>
                                </fieldset>
                            </div>
                        </div>
                    </details>
                </div>



            </div>
            <details class="undecorated">
                <summary>Scene Notes</summary>



                <div style="overflow: auto; max-height:30em;">
                    <h4>Scene Notes</h4>
                    <textarea v-model="editingScene.notes"
                        @change="setSceneProperty(editingScene.id, 'notes', $event.target.value)"
                        @input="setScenePropertyDeferred(editingScene.id, 'notes', $event.target.value)"></textarea>
                </div>
            </details>

            <details class="undecorated">
                <summary>Scene Settings</summary>

                <!-- <details>
                    <summary>Music Visualization Presets</summary>
                    <textarea v-on:change="setvisualization(scenename,$event.target.value);"
                        v-model="editingScene.musicVisualizations"></textarea>
                </details> -->
                <div class="flex-row gaps">

                    <div class="w-sm-full card">

                        <header>
                            <h4>Basic</h4>
                        </header>
                        <div class="stacked-form">

                            <p> <label>
                                    Alpha:<input type="number" max=1 step=0.01 min=0
                                        v-on:change="setalpha(scenename,parseFloat($event.target.value));"
                                        v-model="alphas[scenename]">
                                </label>

                                <label>Default Alpha
                                    <input :disabled="no_edit" type="number" max=1 step=0.01 min=0
                                        v-on:change="setdalpha(scenename,parseFloat($event.target.value))"
                                        v-model="editingScene.defaultAlpha"></input>
                                </label>
                            </p>

                            <label>Blend Mode
                                <select  :disabled="no_edit" title="This setting controls blending multiple scenes together"
                                    v-on:input="setblend(scenename,$event.target.value)" v-model="editingScene.blend"
                                    data-testid="scene_blend_mode">

                                    <option title="Alpha blend with scenes below">normal</option>
                                    <option
                                        title="Highest Takes Priority, only affect lights if the value is higher than the others">
                                        HTP</option>
                                    <option title="Limit maximum level">inhibit</option>

                                    <option v-for="i in ${[i for i in blendmodes.blendmodes.keys()]}">{{i}}
                                    </option>

                                </select>
                            </label>

                            <p>
                                <label><span class="mdi mdi-lock-alert"></span>
                                    Require Confirmation for Cue Jumps
                                    <input :disabled="no_edit" type="checkbox" v-model="editingScene.requireConfirm"
                                    v-on:change="setSceneProperty(scenename,'requireConfirm', editingScene.requireConfirm)">
                                </label>

                                <label>Priority
                                    <input :disabled="no_edit" type='number' min=0 max=100
                                        v-on:change="setSceneProperty(scenename,'priority', parseFloat($event.target.value))"
                                        v-model="editingScene.priority">
                                </label>
                                <label>BPM
                                    <input :disabled="no_edit" type='number' min=0 max=100
                                        v-on:change="setbpm(scenename,parseFloat($event.target.value))"
                                        v-model="editingScene.bpm">
                                </label>
                                <button type="button" v-on:click="tap(scenename)" class="grow">
                                    <i class="mdi mdi-gesture-tap"></i>Tap
                                </button>
                            </p>

                            <p>
                                <label title="Check this box to make the scene active at startup">Active By
                                    Default
                                    <input :disabled="no_edit" type="checkbox"
                                        v-on:change="setSceneProperty(scenename,'defaultActive',$event.target.checked)"
                                        v-model="editingScene.defaultActive"></input>
                                </label>

                                <label
                                    title="Scenes inherit from previous scenes even if you jump directly to them">Backtrack
                                    <input :disabled="no_edit" type="checkbox"
                                        v-on:change="setSceneProperty(scenename,'backtrack', $event.target.checked)"
                                        v-model="editingScene.backtrack"></input>
                                </label>
                            </p>


                            <label>Slideshow Overlay:
                                <input :disabled="no_edit" v-on:change="setSceneProperty(scenename,'slideOverlayUrl',$event.target.value)"
                                    v-model="editingScene.slideOverlayUrl"></input>
                            </label>



                            <label title="Recieve note events from a MIDI input device">MIDI
                                Source:
                                <input :disabled="no_edit" list="midiinputs"
                                    v-on:change="setSceneProperty(scenename,'midiSource', $event.target.value)"
                                    v-model="editingScene.midiSource"></input>
                            </label>

                            <label title="Recieve shortcut codes from a command-type tag">
                                Command Tag:<input :disabled="no_edit" placeholder="Tagpoint"
                                    v-on:change="setcommandtag(scenename,$event.target.value)"
                                    v-model="editingScene.commandTag" list="commandtagslisting">
                            </label>

                            <label title="You can use this with __random__ to create a shuffle effect.">Default
                                cue advance:
                                <input :disabled="no_edit" list="nextcueoptions" v-on:change="setdefaultnext(scenename,$event.target.value)"
                                    v-model="editingScene.defaultNext" placeholder="Next cue in list"></input>
                            </label>
                        </div>
                    </div>


                    <div class="card w-sm-full">
                        <header>
                            <h4>Sound</h4>
                        </header>
                        <div class="stacked-form">
                            <label> Sound Output<input
                                    title="If not set by a cue, the global setting for the scene is used"
                                    v-on:change="setSceneSoundOutput(scenename,$event.target.value)"
                                    v-model="editingScene.soundOutput" placeholder="default"
                                    list="soundcards"></input></label>

                            <label>
                                Crossfade for non-silent Sounds
                                <input :disabled="no_edit" type="number" max=1 step=0.01 min=0
                                    v-on:change="setcrossfade(scenename,parseFloat($event.target.value))"
                                    v-model="editingScene.crossfade"></input>
                            </label>
                        </div>
                        <h5>Outputs</h5>
                        <div class="scroll max-h-24rem">
                            <dl>
                                <dt>Web Player</dt>
                                <dd>
                                    <div class="tool-bar">
                                        <button type="button" v-on:click="setSceneSoundOutput(scenename,'scenewebplayer')">Set
                                            as
                                            Scene
                                            Default</button>
                                    </div>
                                </dd>

                                <template v-for="i of soundCards">
                                    <dt>{{i || "UNSET"}}</dt>
                                    <dd>
                                        <div class="tool-bar">
                                            <button type="button" v-on:click="setSceneSoundOutput(scenename,i)">Set as Scene
                                                Default</button>
                                            <button type="button" v-on:click="testSoundCard(i,0,48000)">Test</button>
                                        </div>
                                    </dd>
                                </template>
                            </dl>
                        </div>
                    </div>

                    <div class="card w-sm-full">
                        <header>
                            <h4>MQTT Features</h4>
                        </header>
                        <div class="stacked-form">
                            <label>MQTT Server:
                                <input :disabled="no_edit" v-on:change="setmqtt(scenename,$event.target.value)"
                                    v-model="editingScene.mqttServer"></input>
                            </label>

                            <label
                                title="Cue transitions on the same MQTT server sharing a group name will sync if cue names match.">Sync
                                Group Name
                                <input :disabled="no_edit" v-on:change="setmqttfeature(scenename,'syncGroup',$event.target.value)"
                                    v-model="editingScene.mqttSyncFeatures.syncGroup"></input>
                            </label>
                        </div>
                    </div>


                    <div class="card w-sm-full">
                        <header>
                            <h4>Import/Export</h4>
                        </header>
                        <div class="stacked-form">
                            <label>Download just this scene
                                <a class="button"
                                    v-bind:href="'downloadOneScene?id='+scenename+'&name='+editingScene.name"
                                    title="Download your scene as a file"><i class="mdi mdi-download"></i>Download
                                    Scene</a>
                            </label>

                            <label>Download audio playlist as m3u
                                <a class="button"
                                    v-bind:href="'downloadm3u?id='+scenename+'&rel=&name='+editingScene.name"
                                    title="Download your scene as a file"><i class="mdi mdi-download"></i>Download
                                    Playlist</a>
                            </label>

                            <p>This playlist should work in other apps such as VLC on other computers, as long as the
                                same media folders are
                                in the same place relative to your home folder.
                            </p>

                            <label>Add new cues from playlist
                                <a class="button" v-bind:href="'uploadm3u?id='+scenename" title="Upload a playlist"><i
                                        class="mdi mdi-folder-open"></i>Upload M3U Playlist</a>
                            </label>

                            <p>Uploads use fuzzy search and should work as long as media files exist somewhere in a
                                media folder, you can use playlists from other devices.
                            </p>

                        </div>
                    </div>



                    <div class="card w-sm-full" v-if="editingScene.blend!='normal'">
                        <header>
                            <h4>Send event</h4>
                        </header>
                        <div class="stacked-form">
                            <label>Event name:
                                <input :disabled="no_edit" v-model="evtosend" v-on:keydown.enter="sendev" placeholder="Event Name"
                                    title="Event Name">

                            </label>

                            <label>Value
                                <input :disabled="no_edit" v-model="evval" v-on:keydown.enter="sendev" title="Event Value"
                                    placeholder="value">
                            </label>
                            <label>Type
                                <select v-model="evtypetosend">
                                    <option value="int">Integer</option>
                                    <option value="float">Real Number</option>
                                    <option value="str">Text</option>
                                </select>
                            </label>

                            <button type="button" v-on:click="sendev(scenename)">Send</button>
                            </label>
                        </div>
                    </div>


                    <div class="card w-sm-full" v-if="editingScene.blend!='normal'">
                        <header>
                            <h4>Blend Mode</h4>
                        </header>
                        <div class="stacked-form">
                            <p>{{editingScene.blendDesc}}</p>
                            <p>
                                <label v-for="(j,k) in editingScene.blendParams">{{j[0]}}:
                                    <input :disabled="no_edit" type="number" style="width:5em" step=0.01 v-bind:title="j[2]"
                                        v-on:change="setblendparam(scenename,k,parseFloat($event.target.value))"
                                        v-model="editingScene.blendArgs[k]"></input>

                                </label>
                            </p>
                        </div>
                    </div>





                    <div class="card w-sm-double">
                        <header>
                            <h4>UI</h4>
                        </header>

                        <div class="stacked-form">
                            <p>
                                <label>Utility Scene(No controls)
                                    <input :disabled="no_edit" type="checkbox" v-on:change="setutility(scenename,editingScene.utility)"
                                        v-model="editingScene.utility"
                                        title="If checked, the scene is a utility scene without sidebar controls. Use for embedding CCTV, or basic state machines.">
                                </label>

                                <label>Hide in Runtime Mode
                                    <input :disabled="no_edit" type="checkbox" v-on:change="setHide(scenename,editingScene.hide)"
                                        v-model="editingScene.hide"
                                        title="If checked, the scene is a utility scene without sidebar controls. Use for embedding CCTV, or basic state machines.">
                                </label>
                            </p>

                            <label title="This URL is shown in a mini window in the sidebar">Sidebar info URL
                                <input :disabled="no_edit" v-on:change="setinfodisplay(scenename,$event.target.value)"
                                    v-model="editingScene.infoDisplay"></input>
                            </label>
                        </div>
                        <h5>Event Buttons</h5>
                        <table border="1" class="w-full">
                            <tr>
                                <th>Label</th>
                                <th>Event</th>
                                <th>Acton</th>
                            </tr>
                            <tr v-for="(v,i) in editingScene.eventButtons">
                                <td><input :disabled="no_edit" v-model="v[0]" class="w-6rem" data-testid="event_button_label"
                                        v-on:change="setEventButtons(scenename, editingScene.eventButtons);">
                                </td>
                                <td><input :disabled="no_edit" v-model="v[1]" class="w-6rem" data-testid="event_button_event"
                                        v-on:change="setEventButtons(scenename, editingScene.eventButtons);">
                                </td>
                                <td><button data-testid="event_button_delete"
                                        v-on:click="editingScene.eventButtons.splice(i, 1); setEventButtons(scenename, editingScene.eventButtons);">Delete</button>
                            </tr>


                            <tr>
                                <td></td>
                                <td></td>
                                <td><button
                                        v-on:click="editingScene.eventButtons.push(['','']); setEventButtons(scenename, editingScene.eventButtons);">Add
                                        Button</button>
                            </tr>
                        </table>

                        <h5>Display and Input Tags</h5>

                        <details class="help">
                            <summary><i class="mdi mdi-help-circle-outline"></i></summary>
                            <p>Lets you display some tag
                                points
                                in
                                the
                                scene overview.</p>

                            <p>Tags will be created if they do not exist. Use the tag settings page to configure
                                defaults an limits</p>

                            <p>Expression tags are allowed, =tv('tag1') + 6 will display 6 plus the tag 'tv'</p>

                            <p>You can also add inputs to the scene overview. You can then respond to these inputs
                                in the cue logic.
                            </p>


                        </details>

                        <table border="1" class="w-full">
                            <tr>
                                <th>Label</th>
                                <th>Width</th>
                                <th>Tag</th>
                                <th>Type</th>
                                <th>Action</th>
                            </tr>
                            <tr v-for="(v,i) in editingScene.displayTags">
                                <td><input :disabled="no_edit" v-model="v[0]" class="w-6rem" data-testid="display_tag_label"
                                        v-on:change="setDisplayTags(scenename, editingScene.displayTags);">
                                </td>

                                <td><input type="number" :disabled="no_edit" v-model="v[2].width" class="w-4rem"
                                    data-testid="display_tag_width"
                                    v-on:change="setDisplayTags(scenename, editingScene.displayTags);">
                                </td>

                                <td><input :disabled="no_edit" list="tagslisting" v-model="v[1]"
                                    data-testid="display_tag_tag"
                                        v-on:change="setDisplayTags(scenename, editingScene.displayTags);">
                                </td>


                                <td><select v-model="v[2].type" class="w-6rem"
                                    data-testid="display_tag_type"
                                        v-on:change="setDisplayTags(scenename, editingScene.displayTags);">
                                        <option value="meter">Meter</option>
                                        <option value="text">Text</option>
                                        <option value="led">LED</option>
                                        <option value="string_input">Text Input</option>
                                        <option value="numeric_input">Numeric Input</option>
                                        <option value="switch_input">Switch Input</option>
                                        <option value="auto">Invalid</option>

                                    </select>

                                    <template v-if="v[2].type == 'led'">
                                        <select :disabled="no_edit" v-model="v[2].color" data-testid="display_tag_led_color"
                                            v-on:change="setDisplayTags(scenename, editingScene.displayTags);">
                                            <option value="red">Red</option>
                                            <option value="yellow">Yel</option>
                                            <option value="green">Grn</option>
                                            <option value="blue">Blu</option>
                                            <option value="purple">Purple</option>
                                        </select>
                                    </template>

                                </td>

                                <td><button data-testid="display_tag_delete"
                                        v-on:click="editingScene.displayTags.splice(i, 1); setDisplayTags(scenename, editingScene.displayTags);">Delete</button>

                                    <a v-bind:href="'/tagpoints/'+encodeURIComponent(v[1])"><i
                                            class="mdi mdi-gear"></i></a>
                                </td>


                            </tr>


                            <tr>
                                <td></td>
                                <td></td>
                                <td><button
                                        v-on:click="editingScene.displayTags.push(['Label','=1', {'type':'auto'}]); setDisplayTags(scenename, editingScene.displayTags);">Add
                                        Tag</button>
                            </tr>
                        </table>
                    </div>

                    <div class="card w-full">
                        <header>
                            <h4>Slideshow Layout</h4>
                        </header>
                        <p class="help">You have to refresh the player for this to take effect.</p>

                        <details>
                            <summary>Special Vars</summary>
                            <dl>
                                <dt v-pre>{{clock}}</dt>
                                <dd>Browser's local formatted time</dd>

                                <dt v-pre>{{date}}</dt>
                                <dd>Browser's local formatted date</dd>

                                <dt v-pre>{{countdown}}</dt>
                                <dd>Empty if cue has no length, otherwise, 00:00:00 formatted countdown to end
                                    of current cue.
                                </dd>

                                <dt v-pre>{{var_XXX}}</dt>
                                <dd>User defined variables set in cue logic.
                                </dd>
                            </dl>

                        </details>
                        <details>
                            <summary>Custom layout for slideshow</summary>
                            <div class="stacked-form">
                                <textarea v-model="editingScene.slideshowLayout" class="w-full h-16rem"
                                    data-testid="slideshow_layout"
                                    @change="setSceneProperty(editingScene.id, 'slideshowLayout', $event.target.value)"
                                    @input="setScenePropertyDeferred(editingScene.id, 'slideshowLayout', $event.target.value)"></textarea>
                            </div>
                        </details>
                    </div>
            </details>





            <details class="undecorated">
                <summary>Cue History</summary>
                <div>
                    <button type="button" v-on:click="refreshhistory(scenename)">Refresh</button>
                    <h3>Cue History</h3>
                    <table border="1" v-if="scenemeta[scenename].history">
                        <tr>
                            <th>Cue</th>
                            <th>Time</th>
                        </tr>
                        <tr v-for="v,i of scenemeta[scenename].history">
                            <td>{{v[0]}}</td>
                            <td>{{(new Date(v[1]*1000)).toLocaleString() }}</td>
                        </tr>

                    </table>
                </div>
            </details>

            <div
                v-if="scenecues[scenename][selectedCues[scenename]]==undefined || cuemeta[scenecues[scenename][selectedCues[scenename]]]==undefined">
                Cue data not found...
            </div>
            <div v-if="showevents" style="height:25em">
            </div>
        </section>

    </main>

</div>




<script src="/static/js/thirdparty/strftime-min.js"></script>

<script src="../dyn_js/boardapi.js"></script>
<script src="/static/js/thirdparty/vue3-sfc-loader.js"></script>

<script>



    // Add console specific stuff to the appdata
    appData.formatTime = function (t) {
        var date = new Date(t * 1000);
        return date.strftime("%I:%M:%S%p")
    }

    appData.boardname = window.location.pathname.split('/')[3]

    document.title = appData.boardname

    appData.keyboardJS = keyboardJS

    appData.no_edit = ${'false' if kaithem.web.has_permission('system_admin') else 'true'}

    const options = {
        moduleCache: {
            vue: Vue
        },
        async getFile(url) {

            const res = await fetch(url);
            if (!res.ok)
                throw Object.assign(new Error(res.statusText + ' ' + url), { res });
            return {
                getContentData: asBinary => asBinary ? res.arrayBuffer() : res.text(),
            }
        },
        addStyle(textContent) {

            const style = Object.assign(document.createElement('style'), { textContent });
            const ref = document.head.getElementsByTagName('style')[0] || null;
            document.head.insertBefore(style, ref);
        },
    }

    const { loadModule } = window['vue3-sfc-loader'];


    function httpVueLoader(u) {
        return Vue.defineAsyncComponent(() => loadModule(u, options))
    }

    var vueapp = Vue.createApp(
        {
            data: function () {
                return appData
            },
            methods: appMethods,
            components: {
                "combo-box": httpVueLoader('/static/vue/ComboBox.vue'),
                "script-editor": httpVueLoader('../static/ScriptEditor.vue'),
                "h-fader": httpVueLoader('../static/hfader.vue'),
                'cue-countdown': httpVueLoader('../static/cue-countdown.vue'),
                // Currently contains the timers and the display tags for the scenes overview
                'scene-ui': httpVueLoader('../static/scene-ui-controls.vue'),
                'smooth-range': httpVueLoader('/static/vue/smoothrange.vue')
            },
            computed: appComputed
        }).mount("#app")

    var script = document.createElement('script');
    script.onload = function () {
        init_api_link()
    };

    script.src = "/apiwidget/WebChandlerConsole:"+appData.boardname+"?js_name=api_link";

    document.head.appendChild(script);

</script>

<script>
    keysdown = {}
    keyHandle = function (e) {
        if (keysdown[e.key] != undefined) {
            if (keysdown[e.key]) {
                return;
            }

        }
        keysdown[e.key] = true;
        e.preventRepeat();
        api_link.send(['event', "keydown." + e.key, 1, 'int', "__global__"])
    }
    keyUpHandle = function (e) {
        if (keysdown[e.key] != undefined) {
            if (!keysdown[e.key]) {
                return;
            }

        }
        keysdown[e.key] = false;
        api_link.send(['event', "keyup." + e.key, 1, 'int', "__global__"])
    }
    rebind = function (data) {
        keyboardJS.reset()
        keyboardJS.bind(keyHandle)
        keyboardJS.bind(null, keyUpHandle)

    }

    appData.example_events[3] = ['FooEvent', 'Any custom name you want']

    // Blur the active element to cause Onchange events
    window.visibilitychange = function () {
        document.activeElement.blur();
    };

</script>