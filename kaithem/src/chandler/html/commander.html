<%include file="/pageheader.html" />

<script src="/static/js/thirdparty/keyboard.min.js"></script>

<title>Chandler Commander</title>


<style>

    main{
        width: 100%;
    }
    .grey {
        color: grey;
        font-size: 70%;
    }

    div.hfader {
        border-style: solid;
        border-radius: 5px;
        overflow: auto;
        border-width: 2px;
        border-color: rgba(0, 0, 0, 0.1);
        margin: 3px;
        float: left;
        min-width: 15em;
        min-height: 4em;
    }

    div.hfader input {
        float: right;
    }

    div.hfader span.indicator {
        float: right;
    }


    .indicator {
        border-radius: 0.2em;
        display: inline-block;
        width: 0.9em;
        height: 0.9em;
        border-style: dashed;
        border-width: 1.5px;
    }

    .break {
        flex-basis: 100%;
        height: 0;
    }

    .cuebutton {
        min-width: 24em;
        max-width: 32em;
    }

    .blinking {
        animation: blinkingText 1s infinite;
    }

    @keyframes blinkingText {
        0% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.5;
        }
    }


    div.highlight {
        border: 2px solid;
    }
</style>

<script src="/static/js/thirdparty/vue3.js"></script>



<script type="text/javascript" src="/static/js/widget.js"></script>


<div id="app" v-cloak style="display:flex; flex-wrap:wrap; justify-content: center;">
    <section class="window w-full max-h-12rem margin" v-if="sys_alerts.length">
        <div class="flex-row scroll gaps padding">
            <div class="card" v-for="v,i of sys_alerts">
                <header :class="v['barrel-class']" class="padding">
                    <i class="icofont-warning"></i>{{i}}
                </header>
                <p :class="v['barrel-class']">{{v.message|| 'no trip message'}}</p>
            </div>
        </div>
    </section>
    
    <div class="window paper w-full margin" style="overflow: auto; max-width:98vw; flex-grow:1">
        <header>
            <div class="tool-bar">
                <h3 title="All currently active scenes and all scenes that were created through the light board are shown">
                    Scenes</h3>
                <input size=8
                    title="Enter a cue's shortcut code here to activate it. Keybindings are suspended while this is selected."
                    aria-label="Shortcut code" placeholder="Shortcut" v-model="sc_code" v-on:keydown.enter="shortcut()"
                    v-on:focus="keyboardJS.pause();" v-on:blur="keyboardJS.resume();"></input>
                <button v-on:click="shortcut()">Go!</button>
                <button v-on:click="showPages=!showPages">Toggle Compact</button>

            </div>
        </header>



        <div class="flex-row gaps padding scroll max-h-48rem">
            <template v-for="i in formatScenes" >
            <article v-if="i"
                style="position:relative"
                v-bind:class="{'card':1, 'w-sm-full': 1,  'scene':1, 'nogrow':1, 'flex-col': 1, 'min-h-18rem':1, 'max-h-24rem':1}"
                >


                <header class="flex-row gaps">
                    <h3><button :disabled="i[1].utility" v-bind:class="{highlight:i[0]==scenename}"
                            v-on:click="selectscene(i[1],i[0])" style="font-weight:bold; width:100%">
                            {{i[1].name}}<span v-if="i[1].ext" class="grey"> (external)</span>


                            <span v-if="cuemeta[i[1].cue].sound"><i class="icofont-ui-music"></i></span>


                            <span v-if="cuemeta[i[1].cue].inheritRules" title="This cue has rules inherited"
                               ><i
                                    class="icofont-law-document"></i></span>
                            <span v-if="cuemeta[i[1].cue].rules && cuemeta[i[1].cue].rules.length>0"
                                title="This cue has rules attatched"
                                ><i
                                    class="icofont-law-document"></i></span>
                        </button></h3>
                </header>
                <div class="flex-col nogaps" style="text-align: center;">

                    <p class="warning" v-if="i[1].status">STATUS: {{i[1].status}}</p>


                    <div class="flex-row nogaps nogrow w-full">
                        
                        
                        <div :class="{'success':i[1].active, 'grow': 1, 'h-min-content': 1}" v-if="i[1].active && cuemeta[i[1].cue]">{{cuemeta[i[1].cue].name}} <small>{{formatTime(i[1].enteredCue)}}</small>
                        
                            <cue-countdown :unixtime="unixtime" :scene="i[1]" :cue="cuemeta[i[1].cue]"></cue-countdown>
                        </div>
                        
                        <img style="border:none; height: fit-content;" class="h-8rem w-8rem"
                            onerror='this.style.display = "none"' v-if="cuemeta[i[1].cue].sound"
                            :src="'WebMediaServer?albumArt='+encodeURIComponent(i[1].cue)"></img>

                        <span v-if="(i[1].active && (''+cuemeta[i[1].cue].length).indexOf('@')>-1)"><i
                                class="icofont-wall-clock"></i>{{cuemeta[i[1].cue].length.substring(1)}}</span>

                    </div>

                    <small v-if="i[1].active&&(cuemeta[i[1].cue].next||cuemeta[i[1].cue].defaultNext)">
                        Next: {{(cuemeta[i[1].cue].next||cuemeta[i[1].cue].defaultNext||'').split('?')[0]}}
                    </small>

                    <iframe style="flex-grow:1" v-if="showPages && i[1].infoDisplay.length>0"
                        :src="i[1].infoDisplay"></iframe>

                        <scene-ui v-bind:scene-data="i[1]" :unixtime="unixtime" :cue="cuemeta[i[1].cue]"></scene-ui>


                    </table>


                </div>

                    <footer>
                        <p v-if="!i[1].utility" class="tool-bar" style="flex-grow: 0.15">
                            <button :class="{'highlight':i[1].active}" v-on:click="go(i[0])"><i
                                    class="icofont-ui-play"></i></button>
                            <button v-on:click="prevcue(i[0])"><i class="icofont-ui-previous"></i></button>
                            <button v-on:click="nextcue(i[0])"><i class="icofont-ui-next"></i></button>
                            <button class="stopbutton" v-on:click="stop(i[0])"><i class="icofont-ui-play-stop"></i></button>
                        </p>
                        
                        <div class="tool-bar"><input v-if="!i[1].utility" type="range" style="width: 98%" max=1 step=0.01 min=0
                            v-on:input="setalpha(i[0],parseFloat($event.target.value));" v-on:change="unlockAlpha(i[0]);"
                            :value="alphas[i[0]]">
                        </div>
                        
                        <div class="tool-bar nogrow" v-if="i[1].eventButtons.length > 0">
                            <button v-for="v of i[1].eventButtons" v-on:click="sceneev(v[1],v[1])">{{v[0]}}</button>
                        </div>
                    </footer>
            </article>
        </template>
        </div>

    </div>


    <div class="window paper margin" v-if="editingScene && cuemeta[editingScene.cue]"
        style="display:inline-block;" class="scroll">
        <header>
            <h3>{{editingScene.name}}
                <span class="highlight" v-if="editingScene.active&(!editingScene.doingHandoff)">(running)</span>
            </h3>
        </header>

        <div id="cuesbox">
            <div class="flex-row gaps align-left padding">

                <article class="w-sm-full flex-col h-18rem" v-for="i in formatCues"
                    v-bind:class="{'card': 1, 'highlight' : cuemeta[editingScene.cue].name==i[1].name}">

                    <header>
                        <button class="h-4rem w-full" v-on:click="jumptocue(i[1].id)" class="cuebutton">
                            <div v-if="i[1].shortcut.length>0"> ({{i[1].shortcut}})</div>
                            {{i[1].name}}
                        </button>
                    </header>


                    <div class="flex-row nogaps nogrow min-h-6em w-full">
                        
                        
                        <div :class="{'success': cuemeta[editingScene.cue].name==i[1].name,'grow': 1, 'h-min-content': 1}" >                        
                            <cue-countdown v-if="cuemeta[editingScene.cue].name==i[1].name" :unixtime="unixtime" :scene="editingScene" :cue="cuemeta[editingScene.cue]"></cue-countdown>
                            <div v-if="i[1].notes.length>0" style="max-width: 10em;">({{i[1].notes}})</div>
                        </div>
                        
                        <img style="border:none; height: fit-content;" class="w-2rem grow"
                            onerror='this.style.display = "none"' v-if="i[1].sound"
                            :src="'WebMediaServer?albumArt='+encodeURIComponent(i[1].id)"></img>

                        <span v-if="(i[1].active && (''+i[1].length).indexOf('@')>-1)"><i
                                class="icofont-wall-clock"></i>{{i[1].cue.length.substring(1)}}</span>

                    </div>

                </article>

            </div>

        </div>
    </div>

    <div class="w-full window margin">
        <div class="scroll h-12rem w-full">
            <template v-for="i in evlog.slice()">
                <div v-if="i[0].indexOf('err')>-1">
                    {{i[2]}}: <b>{{i[0]}}</b> at {{i[1]}}:
                    <span v-if="!(typeof(i[3])=='string' && i[3].length>32)">{{i[3]}}</span>
                    <pre v-if="(typeof(i[3])=='string' && i[3].length>32)">{{i[3]}}</pre>
                    <pre v-if="i[4]">{{i[4]}}</pre>
                </div>
            </template>
        </div>
    </div>

</div>

</div>

<section class="window margin scroll">
<iframe src="/dropdownpanel?summary=1" width="99%"></iframe>
</section>


${module.board.link.render('api_link')}


<script type="text/javascript" src="dyn_js/boardapi.js"></script>
<script src="/static/js/thirdparty/strftime-min.js"></script>
<script src="/static/js/thirdparty/vue3-sfc-loader.js"></script>


<script>
    appData.formatTime = function (t) {
        var date = new Date(t * 1000);
        return date.strftime("%I:%M:%S%p")
    }
    const options = {
        moduleCache: {
            vue: Vue
        },
        async getFile(url) {

            const res = await fetch(url);
            if (!res.ok)
                throw Object.assign(new Error(res.statusText + ' ' + url), { res });
            return {
                getContentData: asBinary => asBinary ? res.arrayBuffer() : res.text(),
            }
        },
        addStyle(textContent) {

            const style = Object.assign(document.createElement('style'), { textContent });
            const ref = document.head.getElementsByTagName('style')[0] || null;
            document.head.insertBefore(style, ref);
        },
    }

    const { loadModule } = window['vue3-sfc-loader'];


    function httpVueLoader(u) {
        return Vue.defineAsyncComponent(() => loadModule(u, options))
    }


    var vueapp = Vue.createApp(
        {
            data: function(){
                return appData;
            },
            computed: appComputed,
            methods: appMethods,
            components: {
                "combo-box": httpVueLoader('/static/vue/ComboBox.vue'),
                'cue-countdown': httpVueLoader('static/cue-countdown.vue'),
                 // Currently contains the timers and the display tags for the scenes overview
                'scene-ui': httpVueLoader('static/scene-ui-controls.vue')
            }
        }).mount("#app")
        init_api_link()

</script>

<%include file="/pagefooter.html" />