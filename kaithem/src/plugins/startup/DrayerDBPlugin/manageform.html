<%!
import datetime
import cherrypy

%>
<h3>Posts</h3>
<p class="help">
    The primary use case for DrayerDB was originslly personal Wikis, so a basic post browser is provided here.  To
    integrate similar functionality into a page, see the code in kaithem/src/plugins/DrayerDBPlugins/manageform
</p>
<dl>


<%
parentPost = obj.getDocumentByID(cherrypy.request.params.get("parentPost","")) or {}

minAge = 10**18
maxAge = -10**18
%>
<h3>Parent post: ${parentPost.get("title",'')}<b><a href="?parentPost=${parentPost.get('parent','')|u}">(UP)</a></b></h3>

<pre>
${parentPost.get("body",'')}
</pre>

<h3>Comments/sub-posts


</h3>
%for i in obj.getDocumentsByType("post", startTime=float(cherrypy.request.params.get("minAge",0)), endTime=float(cherrypy.request.params.get("maxAge",10**18)), parent=cherrypy.request.params.get("parentPost",""), limit=50):
<%
try:
    minAge=min(i.get("time",minAge),minAge)
    maxAge=max(i.get("time",maxAge),maxAge)
except:
    pass
%>
<dt><b><a href="?parentPost=${i.get('id','ERR')|u}">${i.get("title","ERROR") or "No Title"|h}</a></b>

${datetime.datetime.fromtimestamp(i.get('time',0)/10**6).strftime("%c") }

</dt>
<dd>${i.get("body","ERROR")[:240]|h}</dd>
%endfor
</dl>

<b><a href="?parentPost=${parentPost.get('id','')|u}&maxAge=${minAge}">Older</a></b>
<b><a href="?parentPost=${parentPost.get('id','')|u}&minAge=${maxAge}">Newer</a></b>


<h3>Info</h3>
<p class="help">
This device represents one locally-hosted DrayerDB stream which you can connect to.  DB files are stored under vardir/drayerdb/NAME/ so watch out, renaming this essentially creates
a whole new DB.  Deleting this device may delete the underlying database.  Everything is already ready to go to use Kaithem as a server, just set the client's sync server URL
to Kaithem's URL.  DrayerDB has it's own encryption so you can use plain HTTP.
</p>

<p class="help">
    New records will be posted to /devices/NAME/record.  device.setDocument({'type':'foo'}) can be used to insert data.  
    device.getDocumentsByType(type, startTime=0, endTime=10**18, parent='') will return all documents of the given type, in the time range, having that parent document.
    Set parent to none to get the document regardless of what the parent is.

    Parent must always be a UUID matching another record's id field.    device.getDocumentByID(uuid) returns the document or None if it is nonexistant or orphaned.
    To overwrite, simply set a new document with same ID. Set type to null to delete it. If you ever change the parent, you must set moveTime or the move will be ignored.
</p>

    
<p class="help">
    All DrayerDB timestamps are the UNIX time in microseconds.
</p>


<p class="help">
    Device.service will be the actual DrayerDB object.
</p>


<datalist id="bool">
    <option>yes</option>
    <option>no</option>
</datalist>
<p class="help">User-created records should never be marked as autocleanable. The feature is used to clear old notification logs.  Autocleaned records are "silently deleted" on
    this device only, any other devices will still have them.
    </p>
<table>
    <tr>
        <td>Sync Key(Leave blank to generate new key and password)</td>
        <td><input id='vk' name="device.syncKey" value="${data.get('device.syncKey','')|h}"></td>
    </tr>

    <tr>
        <td>Write Password</td>
        <td><input id='sk' name="device.writePassword" value="${data.get('device.writePassword','')|h}"></td>
    </tr>

    <tr>
        <td>Sync Server URL</td>
        <td><input id='sv' name="device.syncServer" value="${data.get('device.syncServer','')|h}"></td>
    </tr>


    <tr>
        <td>Log system notifications into DB(set yes to enable)</td>
        <td><input id='sv' list="bool" name="device.archiveNotifications" value="${data.get('device.archiveNotifications','no')|h}"></td>
    </tr>


    <tr>
        <td>Keep Autocleanable records(days, 0=forever)</td>
        <td><input id='sv' list="bool" name="device.autocleanDays" value="${data.get('device.autocleanDays','0')|h}"></td>
    </tr>


</table>


<script src="/static/qrcode.min.js"></script>

<div class="sectionbox">
    <h2>Sharing Code Setup</h2>
    <p class="help">Scan with a QR code app and paste into Drayer Journal or any other app!  Note that you may have to manually set the sync server,
        the app cannot know by itself which IP you want to use.  When in doubt, use the same URL you use for the web UI.
    </p>
    <div id="lanqr"></div>
    <script>

    function loadSharingCode()
    {
        c = JSON.parse(prompt("Enter Code"))
        document.getElementById('vk').value = c['vk']||''
        document.getElementById('sk').value = c['sk']||''
        document.getElementById('sv').value = c['sv']||
        
        
        ''
    }
    function doQR(wp,cb)
    {
        d = {
            'sv':'',
            'vk':"${data.get('device.syncKey','')|h}",
            'n':"${data.get('name','')|h}"
        }

        if(wp)
        {
            d['sk']="${data.get('device.writePassword','')|h}"
        }

        if (cb){
            navigator.clipboard.writeText(JSON.stringify(d))
        }
        else
        {
        new QRCode(document.getElementById("lanqr"), JSON.stringify(d));
        }
    }
    </script>

<button type="button" onclick="doQR(0)">Show QR Code(For readonly access)</button></br>
<button type="button"onclick="doQR(1)">Show QR Code(For full access)</button></br>
<button type="button" onclick="doQR(0,1)">Copy Sharing Code to clipboard(readonly)</button></br>
<button type="button" onclick="doQR(1,1)">Copy Sharing Code to clipboard(full)</button></br>

<h2>Load from sharing code</h2>

<button type="button" onclick="loadSharingCode()">Load</button>

</div>



<div class="sectionbox">
<p>