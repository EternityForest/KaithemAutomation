# Kaithem Devices

Kaithem provides an abstraction called a Device that covers several kinds of device, but currently only
Kasa smartplugs and Pavillion devices are supported.



## API

All devices appear in the kaithem.devices[] space. 

All Pavillion devices post all recieved pavillion messages to the bus at /devices/<DEVNAME>/msg/<TARGET>, with the data being (pavillion message name, payload, (ip,port))

All Tagpoints the device exposes appear in the tags list under  /devices/<DEVNAME>/<TAGNAME>. 


### Device Objects

#### dev.alerts

Dict of Alert objects the device defines

#### dev.__init__(name, data)
Data will be the same kwargs from the HTTP POST used to create or delete

### Sync tagpoints
These sync with the tag on the remote device as you might expect.

The value is synced using a claim called "shared" at default priority 51. If a tag is bidirectional, set this claim directly, otherwise just read or override with a higher claim.

#### dev.setDataKey(key,val)
Sets a persistant and savable key for this device in it's data.

#### dev.data
The device data, the stuff passed in over kwargs.


## Adding new device types


Devices are defined by a dict of configuration data and a name. At
minimium, the device config data will have a "type" field that
determines what class is used to construct the device object.


Every device has a set of "descriptors", which are objects indexed by
string keys that describe exactly what the device is capable of. String
keys can be anything, but domain name based names help avoid collisions.

To create your own device types, all you have to do is subclass
devices.Device, and add your subclass to the weak dict
devices.deviceTypes.

### HTML Config

Device configuration pages are structured as HTML forms, and the field
names map directly to data keys in the configuration. Every device has a
getManagementForm() method that returns raw HTML that gets inserted into
that form.

getCreateForm() is similar, but must be a static method. It is used
for creating new devices.

All keywords that get passed from management or create forms
are saved in the "device data" dict. These are what actually gets saved
to files.

The exception is names starting with "temp.", these are passed to the constructor, but they are not saved or loaded from disk.

### Keyword naming

Configuration keys are hierarchially namespaced. To be completely safe,
use the "device." namespace for device specific stuff.

Anything beginning with temp. is passed to the device but not saved or loaded.

#### Reserved Keys

##### name
Always present, you do not need an input for this
##### type
Always present, you do not need an input for this, one is already in the page


#### Alerts
Config keys of the form alerts.NAME.priority are used to set the
priority of the corresponding alert in the device.alerts dict, allowing
easy configurable alerting. The config page already has this section,
you do not need to include it in your management form.

The alerts list is autogenerated. To apply configured priorities, call
device.setAlertPriorities()

## Configuring

You configure devices through the devices page.
