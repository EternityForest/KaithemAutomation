---
allow-origins: ['*']
allow-xss: false
auto-reload: false
auto-reload-interval: 5.0
code: ''
mimetype: text/html
no-header: true
no-navheader: true
require-method: [GET, POST]
require-permissions: []
resource-timestamp: 1691537220579779
resource-type: page
setupcode: ''
streaming-response: false
template-engine: mako
theme-css-url: ''

---
<%! 
#Code Here runs once when page is first rendered. Good place for import statements. 
%>

<% 
__doc__="#Python Code here runs every page load" 
%>

<style>
  body{
background-color:  black;
color: white;
text-align: center;
}
</style>
<script src="/static/widget.js"></script>

<style>
    body{
        background-color: black;
        overflow: hidden;
        margin: 0px;
        padding:0opx;
    }
.video-container {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    height: 100%; 
    overflow: hidden;
    margin: 0px;
    padding: 0px;
    border-width:0px;
    background: none;
  }
  .video-container video,.video-container img {
    width: 100%; 
    margin: 0px;
    padding: 0px;

    height: auto;
    max-height: 100%;

    /* Center the video */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
  }
</style>



  ${module.scenes_by_name[kwargs['scene']].mediaLink.render('link')}


<section class="video-container" id="layer">
</section>

<section class="video-container" id="layer2">
</section>


<script>

atypes = ['.ogg', '.m4a', '.mp3', '.opus']
itypes = ['.png', '.jpg','.bmp','.tiff']

function isSound(fn)
{
    for(i of atypes)
    {
      if (fn.indexOf(i) >-1)
      {
         return true;
      }
    }

  return false
}

function isStill(fn)
{
    for(i of itypes)
    {
      if (fn.indexOf(i) >-1)
      {
         return true;
      }
    }

  return false
}


currentLayer = document.getElementById("layer")
altLayer = document.getElementById("layer2")

currentMedia = 0
altMedia = 0

fadeTask = 0
fadeStart = 0
fadeLength =0
targetVolume = 0.1


function fader()
{

  if(fadeLength == -1)
  {
    return;
  }
  if(fadeLength==0)
  {
    if(currentMedia)
    {
      currentMedia.volume = targetVolume;
    }
    if(altMedia){
      altMedia.volume = 0;
    }
    return;
  }

  var position = Math.max(Math.min((Date.now()-fadeStart) / fadeLength, 1),0)

  if(position==1)
  {
    fadeLength = 0;
  }


  currentLayer.style.opacity = (position*100)+'%'
  altLayer.style.opacity = ((1-position)*100)+'%'

  if(currentMedia)
  {
    currentMedia.volume = position*targetVolume
  }

  if(altMedia)
  {
    altMedia.volume = (1-position)*targetVolume
  }

}

setInterval(fader, 1000/24)

lastMedia=''

function playMedia(t, f, st)
{


  if (t.children.length>0) {
    t.removeChild(t.children[0]);
  }

    if(!f)
  {
    return
  }

  if(isSound(f))
  {
    t.appendChild(document.createElement('audio')) 
  }

  else if(isStill(f))
  {
    t.appendChild(document.createElement('img')) 
  }

  else
  {
    t.appendChild(document.createElement('video')) 
  }


  var x = "WebMediaServer?scene=" + "${kwargs['scene']}" +"&file="+encodeURIComponent(f)

  t.children[0].src = x


  if(!isStill(f))
  {
    t.children[0].volume = 0
    t.children[0].currentTime = st
    try
    {
      t.children[0].play()
    }
    catch(e)
    {
    //Allow retry once user clicks in normal browser
    lastMedia=''
      console.log(e)
    }
  }
  return t.children[0]
}
function switchMedia(v,t, startAt)
{

    if(lastMedia == v)
    {
      return null
    }
    lastMedia=v

  fadeStart = Date.now()

 // ye switcharoo
  x = currentLayer
  currentLayer = altLayer
  altLayer = x

  currentLayer.style.opacity = '0%'

  fadeLength = -1
  altMedia = currentMedia
  currentMedia = playMedia(currentLayer,v, startAt)

  fadeLength = t*1000;
}

</script>


<script>

lastMedia=''

function f(v)
{
  if(v[0]=='volume')
  {
    targetVolume = v[1]
  }

  if(v[0]=='mediaURL')
  {

      // We want to be able to jump in at the appropriate time relative to cue start in case we refresh the page.
      // But we more importantly want to prioritize not missing the start of a short clip
      var t = (link.now()/1000)-v[2]
      if(t< 1)
      {
          t=0;
      }

      switchMedia(v[1],1,t)

  }
}
link.upd=f
link.timeSyncInterval = 10000

link.send(['ask'])

function f2()
{
link.send(['ask'])
}

setInterval(f2, 1000)


</script>