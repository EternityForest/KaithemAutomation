---
allow-origins: ['*']
allow-xss: false
auto-reload: false
auto-reload-interval: 5.0
code: ''
mimetype: text/html
no-header: true
no-navheader: true
require-method: [GET, POST]
require-permissions: []
resource-timestamp: 1690988087141429
resource-type: page
setupcode: ''
streaming-response: false
template-engine: mako
theme-css-url: ''

---
<%! 
#Code Here runs once when page is first rendered. Good place for import statements. 
%>

<% 
__doc__="#Python Code here runs every page load" 
%>

<style>
  body{
background-color:  black;
color: white;
text-align: center;
}
</style>
<script src="/static/widget.js"></script>

<style>
    body{
        background-color: black;
        overflow: hidden;
        margin: 0px;
        padding:0opx;
    }
.video-container {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    height: 100%; 
    overflow: hidden;
    margin: 0px;
    padding: 0px;
  }
  .video-container video,.video-container img {
    width: 100%; 
    margin: 0px;
    padding: 0px;

    height: auto;
    max-height: 100%;

    /* Center the video */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
  }
</style>



  ${module.scenes_by_name[kwargs['scene']].mediaLink.render('link')}


<div class="video-container">
  <video id="v" style="width: 100%; max-height: 100%" controls></video>
  <audio id='a'></audio>
  <img id='i' style="max-width: 100%; max-height: 100%;"></img>
</div>

<script>

      atypes = ['.ogg', '.m4a', '.mp3', '.opus']
      itypes = ['.png', '.jpg','.bmp','.tiff']

      lastSrc = ''

      allowJumpAnyway = false

      // Because of delay in starting a video, play it very slightly faster.
      // This marks when it has caught up.
      firstNegative = false

      lastTime = -1

function f(v)
{
    var a =  document.getElementById('a')
    var vid = document.getElementById('v')
    var img = document.getElementById('i')

  
  if(v[0]=='volume')
  {
    a.volume = v[1]
    vid.volume = v[1]
  }

  if(v[0]=='mediaURL')
  {
    isSound=0
    isPicture = 0
    
    if(v[1] == null)
    {
      a.pause();
      vid.pause();
      vid.style.display='none'
      a.style.display='none'
      img.style.display='none'

      return
    }

    for(i of itypes)
    {
      if (v[1].indexOf(i) >-1)
      {
        isPicture = true;
      }
    }
    
    
    for(i of atypes)
    {
      if (v[1].indexOf(i) >-1)
      {
        isSound = true;
      }
    }
    
    

    var m = null
    
    if (isSound)
    {
      a.controls=true;
      vid.pause();
      vid.style.display = 'none'
      a.style.display=''
      m= a
    }
    else if(isPicture)
    {
      a.style.display='none'
      vid.pause();
      vid.style.display = 'none'
      m= img
    }
    else
    {
      a.controls=false
      a.pause()
      a.style.display='none'
      vid.style.display = ''
      try
      {
        vid.requestFullscreen();
      }
      catch(e)
      {
      console.log(e)
      }
      m=vid
    }

    try{

      var x = "WebMediaServer?scene=" + "${kwargs['scene']}" +"&file="+encodeURIComponent(v[1])
      if( lastSrc != x)
      {
        allowJumpAnyway = true

        lastSrc = x
        m.src=x
      }


    if(!isPicture){
      //detect restart
      if(lastTime<m.currentTime)
      {
              firstNegative = false;
        m.playbackRate = 1.005;
      }
      lastTime = m.currentTime;

            try{
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      var latency = parseInt(urlParams.get('latency')) || 30
      }
      catch(e){
      var latency = 30
      }

      

      var dt = ((link.now()/1000) - v[2]) - (latency/1000)
      var delta = dt-m.currentTime


      if(dt< m.duration)
      {

        if((!firstNegative) && (Math.abs(delta) < 0.6) && (!allowJumpAnyway))
        {
        if(delta<0.002){
          m.playbackRate= 1;
          firstNegative=true
          }
          else{
            m.playbackRate = 1.003
          }
        }

        else if((Math.abs(delta) < 0.6) && (!allowJumpAnyway)) 
        {
          if(delta>0)
          {
              m.playbackRate += 0.00003
          }
          else if(delta<0)
          {
              m.playbackRate -= 0.000033
          }
        }


        else{
          m.currentTime = dt
          allowJumpAnyway = false
        }
      }

      if(m.paused)
      {
      if(dt< m.duration)
      {
        m.play().catch(function (e)
            {
              console.log(e)
            })
            }
            }
          }
    }
    catch(e)
    {
      link.send(['error', e.toString()])
      throw e
    }
  }
}
link.upd=f
link.timeSyncInterval = 10000

link.send(['ask'])

function f2()
{
link.send(['ask'])
}

setInterval(f2, 1000)


</script>